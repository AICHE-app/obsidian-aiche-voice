/*
AICHE Voice - Obsidian Plugin
https://aiche.app
*/

var V=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var le=Object.prototype.hasOwnProperty;var de=(i,s)=>{for(var e in s)V(i,e,{get:s[e],enumerable:!0})},ue=(i,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of ce(s))!le.call(i,n)&&n!==e&&V(i,n,{get:()=>s[n],enumerable:!(t=ae(s,n))||t.enumerable});return i};var he=i=>ue(V({},"__esModule",{value:!0}),i);var we={};de(we,{default:()=>M});module.exports=he(we);var c=require("obsidian");var P=require("obsidian");var $={encryptedAccessToken:void 0,encryptedRefreshToken:void 0,tokenStorageVersion:void 0,machineId:void 0,deviceId:void 0,accessToken:void 0,refreshToken:void 0,tokenExpiresAt:0,userEmail:"",userId:null,isSubscribed:!1,subscriptionPlan:null,autoEnhance:!0,insertAtCursor:!0,showNotifications:!0,hasShownWelcome:!1,spokenNotesFolder:"Voice Notes",attachAudioToVoiceNotes:!0,organizeByCategoryFolders:!1,pendingTranscriptions:[],hasGivenPrivacyConsent:!1},j={work:"Work",life:"Life",ideas:"Ideas",misc:"Misc"};function X(i){if(!i)return"misc";switch(i.toLowerCase()){case"work":return"work";case"life":return"life";case"ideas":return"ideas";case"misc":return"misc";case"personal":return"life";case"idea":return"ideas";case"note":return"misc";default:return"misc"}}function Q(i){return i instanceof Error}function pe(i){return typeof i=="object"&&i!==null&&"message"in i&&typeof i.message=="string"}function ge(i){return typeof i=="object"&&i!==null&&"name"in i&&typeof i.name=="string"}function q(i){return typeof i=="object"&&i!==null&&"status"in i&&typeof i.status=="number"}function z(i){return typeof i=="object"&&i!==null&&"json"in i&&typeof i.json=="object"&&i.json!==null&&"detail"in i.json&&typeof i.json.detail=="string"}function E(i){return Q(i)||pe(i)?i.message:typeof i=="string"?i:"Unknown error"}function K(i){if(Q(i)||ge(i))return i.name}var x="https://api.aiche.app",B=class{constructor(){this.onTokenRefresh=null;this.refreshPromise=null;this.accessToken="",this.refreshToken=""}setTokens(s,e){this.accessToken=s,this.refreshToken=e}setTokenRefreshCallback(s){this.onTokenRefresh=s}async activateDeviceCode(s,e){let n=(await(0,P.requestUrl)({url:`${x}/api/v1/auth/device/activate`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:s.toUpperCase().trim(),device_info:e})})).json;return this.setTokens(n.access_token,n.refresh_token),n}async verifyDeviceCode(s){try{return(await(0,P.requestUrl)({url:`${x}/api/v1/auth/device/verify/${s.toUpperCase().trim()}`,method:"GET"})).json}catch(e){return{valid:!1,error:E(e)}}}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this.performTokenRefresh();try{return await this.refreshPromise}finally{this.refreshPromise=null}}async performTokenRefresh(){if(!this.refreshToken)throw new Error("No refresh token available");let e=(await(0,P.requestUrl)({url:`${x}/api/v1/auth/refresh`,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`refresh_token=${encodeURIComponent(this.refreshToken)}`})).json,t={access_token:e.access_token,refresh_token:e.refresh_token||this.refreshToken,token_type:e.token_type||"bearer",expires_in:e.expires_in||86400*8};return this.setTokens(t.access_token,t.refresh_token),this.onTokenRefresh&&this.onTokenRefresh(t),t}async request(s){let e=s.headers||{};this.accessToken&&(e.Authorization=`Bearer ${this.accessToken}`);try{return(await(0,P.requestUrl)({...s,headers:e})).json}catch(t){if(q(t)&&t.status===401&&!s.retried&&this.refreshToken)try{return await this.refreshAccessToken(),e.Authorization=`Bearer ${this.accessToken}`,(await(0,P.requestUrl)({url:s.url,method:s.method,headers:e,body:s.body})).json}catch(r){throw new Error("Session expired. Please reconnect your account.")}let n="Request failed";throw z(t)?n=t.json.detail:n=E(t),new Error(n)}}async getUserProfile(){return this.request({url:`${x}/api/v1/auth/me`,method:"GET"})}async transcribeAudio(s,e){let t="----AicheFormBoundary"+Math.random().toString(36).substring(2),n=JSON.stringify({include_category:!0}),r=`--${t}\r
Content-Disposition: form-data; name="request"\r
Content-Type: application/json\r
\r
${n}\r
`,o=`--${t}\r
Content-Disposition: form-data; name="file"; filename="${e}"\r
Content-Type: audio/webm\r
\r
`,a=`\r
--${t}--\r
`,d=new TextEncoder().encode(r),l=new TextEncoder().encode(o),u=new TextEncoder().encode(a),p=new Uint8Array(s),g=new Uint8Array(d.length+l.length+p.length+u.length);return g.set(d,0),g.set(l,d.length),g.set(p,d.length+l.length),g.set(u,d.length+l.length+p.length),this.request({url:`${x}/api/v1/transcription/audio/direct`,method:"POST",headers:{"Content-Type":`multipart/form-data; boundary=${t}`},body:g.buffer})}async pollTranscriptionStatus(s,e=30){for(let t=0;t<e;t++){let n=await this.request({url:`${x}/api/v1/transcription/${s}`,method:"GET"});if(n.status==="completed"||n.status==="failed")return n;await new Promise(r=>setTimeout(r,Math.min(1e3+t*200,3e3)))}throw new Error("Transcription timed out")}async logout(){if(this.accessToken)try{await this.request({url:`${x}/api/v1/auth/logout`,method:"POST"})}catch(s){}this.accessToken="",this.refreshToken=""}};var U=require("obsidian"),S=null;if(!U.Platform.isMobileApp)try{S=require("child_process").spawn}catch(i){}function T(i){var s;if(U.Platform.isMobileApp){window.open(i,"_blank");return}try{let e=window.electron;if((s=e==null?void 0:e.shell)!=null&&s.openExternal){e.shell.openExternal(i);return}if(S&&process.platform==="linux"){let t={HOME:process.env.HOME||"",PATH:process.env.PATH||"/usr/bin:/bin",USER:process.env.USER||"",DISPLAY:process.env.DISPLAY||":0",XAUTHORITY:process.env.XAUTHORITY||"",DBUS_SESSION_BUS_ADDRESS:process.env.DBUS_SESSION_BUS_ADDRESS||"",XDG_RUNTIME_DIR:process.env.XDG_RUNTIME_DIR||"",XDG_CURRENT_DESKTOP:process.env.XDG_CURRENT_DESKTOP||""};S("xdg-open",[i],{detached:!0,stdio:"ignore",env:t}).unref()}else S&&process.platform==="darwin"?S("open",[i],{detached:!0,stdio:"ignore"}).unref():S&&process.platform==="win32"&&S("cmd",["/c","start","",i],{detached:!0,stdio:"ignore"}).unref()}catch(e){window.open(i,"_blank")}}var I=class{constructor(s){this.mediaRecorder=null;this.audioChunks=[];this.stream=null;this.state="idle";this.durationInterval=null;this.startTime=0;this.events=s}getState(){return this.state}setState(s){this.state=s,this.events.onStateChange(s)}async startRecording(){if(this.state!=="idle")throw new Error("Already recording. Stop first.");try{this.stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:1,sampleRate:48e3}});let s=this.getSupportedMimeType();this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:s,audioBitsPerSecond:83e3}),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.audioChunks.push(e.data)},this.mediaRecorder.onerror=e=>{var n;let t=e;this.events.onError(new Error(((n=t.error)==null?void 0:n.message)||"Recording error")),this.cleanup()},this.mediaRecorder.start(1e3),this.startTime=Date.now(),this.setState("recording"),this.durationInterval=setInterval(()=>{let e=Math.floor((Date.now()-this.startTime)/1e3);this.events.onDurationUpdate(e)},1e3)}catch(s){this.cleanup();let e=K(s);throw e==="NotAllowedError"?new Error("Microphone blocked. Allow access in system settings."):e==="NotFoundError"?new Error("No microphone found. Connect one and try again."):s}}getSupportedMimeType(){let s=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/mp4"];for(let e of s)if(MediaRecorder.isTypeSupported(e))return e;return"audio/webm"}pauseRecording(){this.state!=="recording"||!this.mediaRecorder||(this.mediaRecorder.pause(),this.setState("paused"))}resumeRecording(){this.state!=="paused"||!this.mediaRecorder||(this.mediaRecorder.resume(),this.setState("recording"))}async stopRecording(){if(this.state==="idle"||!this.mediaRecorder)throw new Error("Not recording. Start a recording first.");return this.setState("processing"),new Promise((s,e)=>{if(!this.mediaRecorder){e(new Error("No media recorder"));return}this.mediaRecorder.onstop=async()=>{var t;try{let n=new Blob(this.audioChunks,{type:((t=this.mediaRecorder)==null?void 0:t.mimeType)||"audio/webm"});if(n.size<1e3)throw new Error("Too short. Speak for at least 1 second.");let r=await n.arrayBuffer();s(r)}catch(n){e(n)}finally{this.cleanup()}},this.mediaRecorder.stop()})}cancelRecording(){this.cleanup()}cleanup(){this.durationInterval&&(clearInterval(this.durationInterval),this.durationInterval=null),this.stream&&(this.stream.getTracks().forEach(s=>s.stop()),this.stream=null),this.mediaRecorder=null,this.audioChunks=[],this.setState("idle")}getDuration(){return this.state==="idle"?0:Math.floor((Date.now()-this.startTime)/1e3)}};var m=require("obsidian");var N=class extends m.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;if(s.empty(),s.createEl("h2",{text:"Voice Recording"}),s.createEl("h3",{text:"Account"}),this.plugin.settings.encryptedAccessToken||this.plugin.settings.accessToken){new m.Setting(s).setName("Connected as").setDesc(this.plugin.settings.userEmail||"Connected").addButton(n=>n.setButtonText("Disconnect").setWarning().onClick(async()=>{await this.plugin.logout(),this.display()}));let t=this.plugin.settings.isSubscribed?`Active: ${this.plugin.settings.subscriptionPlan||"Premium"}`:"No active subscription";new m.Setting(s).setName("Subscription").setDesc(t).addButton(n=>n.setButtonText(this.plugin.settings.isSubscribed?"Manage":"Subscribe").onClick(()=>{T("https://aiche.app/account")})),new m.Setting(s).addButton(n=>n.setButtonText("Refresh Status").onClick(async()=>{await this.plugin.refreshUserStatus(),this.display()}))}else new m.Setting(s).setName("Connect your account").setDesc("Sign in to start recording.").addButton(t=>t.setButtonText("Sign In").setCta().onClick(()=>{this.plugin.openConnectModal()})),new m.Setting(s).setDesc("No account yet?").addButton(t=>t.setButtonText("Create Account").onClick(()=>{T("https://aiche.app/signup")}));s.createEl("h3",{text:"Recording"}),new m.Setting(s).setName("Polish text").setDesc("Fix grammar and punctuation automatically.").addToggle(t=>t.setValue(this.plugin.settings.autoEnhance).onChange(async n=>{this.plugin.settings.autoEnhance=n,await this.plugin.saveSettings()})),new m.Setting(s).setName("Insert at cursor").setDesc("Add text where your cursor is. Otherwise, adds to end of note.").addToggle(t=>t.setValue(this.plugin.settings.insertAtCursor).onChange(async n=>{this.plugin.settings.insertAtCursor=n,await this.plugin.saveSettings()})),new m.Setting(s).setName("Show notifications").setDesc("Show a message when recording completes.").addToggle(t=>t.setValue(this.plugin.settings.showNotifications).onChange(async n=>{this.plugin.settings.showNotifications=n,await this.plugin.saveSettings()})),new m.Setting(s).setName("Voice notes folder").setDesc("Where to save new notes when no note is open.").addText(t=>t.setPlaceholder("Voice Notes").setValue(this.plugin.settings.spokenNotesFolder).onChange(async n=>{this.plugin.settings.spokenNotesFolder=n||"Voice Notes",await this.plugin.saveSettings()})),new m.Setting(s).setName("Attach audio").setDesc("Save audio file with notes in the voice notes folder.").addToggle(t=>t.setValue(this.plugin.settings.attachAudioToVoiceNotes).onChange(async n=>{this.plugin.settings.attachAudioToVoiceNotes=n,await this.plugin.saveSettings()})),new m.Setting(s).setName("Organize by category").setDesc("Sort notes into subfolders (Work, Life, Ideas, Misc) based on content.").addToggle(t=>t.setValue(this.plugin.settings.organizeByCategoryFolders).onChange(async n=>{this.plugin.settings.organizeByCategoryFolders=n,await this.plugin.saveSettings()})),m.Platform.isMobileApp||(s.createEl("h3",{text:"Hotkeys"}),new m.Setting(s).setName("Toggle Recording").setDesc("Start or stop recording"),new m.Setting(s).setName("Cancel Recording").setDesc("Discard without saving"),new m.Setting(s).setName("New Voice Note").setDesc("Create a new note and start recording"),new m.Setting(s).setDesc('Set hotkeys in Settings \u2192 Hotkeys, search "Voice"').addButton(t=>t.setButtonText("Open Hotkeys").onClick(()=>{this.app.setting.open(),this.app.setting.openTabById("hotkeys")}))),s.createEl("h3",{text:"About"}),new m.Setting(s).setName("Version").setDesc(this.plugin.manifest.version).addButton(t=>t.setButtonText("Website").onClick(()=>{T("https://aiche.app")})).addButton(t=>t.setButtonText("Help").onClick(()=>{T("https://aiche.app/help")})).addButton(t=>t.setButtonText("Privacy").onClick(()=>{T("https://aiche.app/privacy")}))}};async function Y(i,s){let e=new TextEncoder,t=await crypto.subtle.importKey("raw",e.encode(i),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:s.buffer,iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function F(i){let s=new Uint8Array(i),e="";for(let t=0;t<s.byteLength;t++)e+=String.fromCharCode(s[t]);return btoa(e)}function H(i){let s=atob(i),e=new Uint8Array(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e}async function R(i,s,e){if(!i)throw new Error("Cannot encrypt empty token");let t=crypto.getRandomValues(new Uint8Array(16)),n=crypto.getRandomValues(new Uint8Array(12)),r=`${s}:${e}:aiche-voice`,o=await Y(r,t),a=new TextEncoder,d=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},o,a.encode(i));return{ciphertext:F(d),iv:F(n.buffer),salt:F(t.buffer)}}async function D(i,s,e){if(!i||!i.ciphertext||!i.iv||!i.salt)throw new Error("Invalid encrypted data");let t=H(i.ciphertext),n=H(i.iv),r=H(i.salt),o=`${s}:${e}:aiche-voice`,a=await Y(o,r),d=await crypto.subtle.decrypt({name:"AES-GCM",iv:n.buffer},a,t.buffer);return new TextDecoder().decode(d)}function k(){return!!(typeof crypto!="undefined"&&crypto.subtle&&typeof crypto.subtle.encrypt=="function"&&typeof crypto.subtle.decrypt=="function"&&typeof crypto.getRandomValues=="function")}var fe=50,J=3,me=1440*60*1e3;function ye(i){let s=new Uint8Array(i),e="";for(let t=0;t<s.byteLength;t++)e+=String.fromCharCode(s[t]);return btoa(e)}function Z(i){let s=atob(i),e=new Uint8Array(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e.buffer}function ve(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function O(i){return Date.now()-i.timestamp>me}function ee(i){return i.retryCount<J&&!O(i)}async function te(i,s,e,t){if(!k())throw new Error("Web Crypto API unavailable - cannot securely save offline recordings");let n=ye(i),r=await R(n,e,t);return{id:ve(),audioData:r,filename:s,timestamp:Date.now(),retryCount:0}}function ne(i){return{...i,retryCount:i.retryCount+1}}function se(i,s){let e=i.filter(t=>!O(t));return e.length>=fe&&e.shift(),[...e,s]}function _(i,s){return i.filter(e=>e.id!==s)}function ie(i){for(let s of i)if(ee(s))return s;return null}function re(i){return i.filter(s=>ee(s))}function oe(i){let s=0,e=0,t=0;for(let n of i)O(n)?e++:n.retryCount>=J?t++:s++;return{total:i.length,pending:s,expired:e,maxRetries:t}}var M=class extends c.Plugin{constructor(){super(...arguments);this.settings=$;this.api=new B;this.recorder=null;this.statusBarEl=null;this.ribbonIconEl=null;this.pendingAuth=null;this.statusBarClickHandler=null;this.statusBarContextHandler=null;this.statusBarTouchStart=null;this.statusBarTouchEnd=null;this.statusBarTouchMove=null;this.longPressTimer=null;this.animationTimeouts=[];this.beforeUnloadHandler=null;this.ariaLiveRegion=null;this.onlineHandler=null;this.isProcessingQueue=!1;this.activeNotice=null}async onload(){await this.loadSettings();let e=await this.getAccessToken(),t=await this.getRefreshToken();e&&this.api.setTokens(e,t||""),this.api.setTokenRefreshCallback(async n=>{await this.setAccessToken(n.access_token),await this.setRefreshToken(n.refresh_token),this.settings.tokenExpiresAt=Date.now()+n.expires_in*1e3,await this.saveSettings()}),this.registerObsidianProtocolHandler("aiche-auth",async n=>{await this.handleAuthCallback(n)}),this.recorder=new I({onStateChange:n=>this.updateRecordingUI(n),onError:n=>new c.Notice(this.getUserFriendlyError(n)),onDurationUpdate:n=>this.updateDurationDisplay(n)}),this.ribbonIconEl=this.addRibbonIcon("mic","Voice recording",async()=>{await this.toggleRecording()}),this.ribbonIconEl.setAttribute("aria-label","Toggle voice recording"),this.statusBarEl=this.addStatusBarItem(),this.statusBarEl.addClass("aiche-status-bar"),this.statusBarEl.setAttribute("role","button"),this.statusBarEl.setAttribute("tabindex","0"),this.statusBarEl.setAttribute("aria-label","Toggle voice recording"),this.statusBarClickHandler=n=>{n.button===0&&(n.preventDefault(),n.stopPropagation(),this.toggleRecording())},this.statusBarContextHandler=n=>{n.preventDefault(),n.stopPropagation(),this.showStatusBarMenu(n)},this.statusBarEl.addEventListener("click",this.statusBarClickHandler),this.statusBarEl.addEventListener("contextmenu",this.statusBarContextHandler),c.Platform.isMobileApp&&(this.statusBarTouchStart=n=>{this.longPressTimer=setTimeout(()=>{this.vibrate(50);let r=n.touches[0],o=new MouseEvent("contextmenu",{clientX:r.clientX,clientY:r.clientY});this.showStatusBarMenu(o)},500)},this.statusBarTouchEnd=()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},this.statusBarTouchMove=()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},this.statusBarEl.addEventListener("touchstart",this.statusBarTouchStart),this.statusBarEl.addEventListener("touchend",this.statusBarTouchEnd),this.statusBarEl.addEventListener("touchmove",this.statusBarTouchMove)),this.statusBarEl.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),this.toggleRecording())}),this.updateStatusBar(),this.createAriaLiveRegion(),this.onlineHandler=()=>{navigator.onLine&&this.settings.pendingTranscriptions.length>0&&this.processOfflineQueue()},window.addEventListener("online",this.onlineHandler),navigator.onLine&&this.settings.pendingTranscriptions.length>0&&setTimeout(()=>this.processOfflineQueue(),3e3),this.addCommand({id:"toggle-recording",name:"Toggle Recording",icon:"mic",callback:async()=>{await this.toggleRecording()}}),this.addCommand({id:"cancel-recording",name:"Cancel Recording",icon:"x",callback:()=>{this.recorder&&this.recorder.getState()!=="idle"&&(this.recorder.cancelRecording(),this.showRecordingNotice("Recording canceled",1500))}}),this.addCommand({id:"new-voice-note",name:"New Voice Note",icon:"file-plus",callback:async()=>{await this.newVoiceNote()}}),this.addSettingTab(new N(this.app,this)),this.beforeUnloadHandler=n=>{if(this.recorder&&this.recorder.getState()!=="idle")return n.preventDefault(),n.returnValue="Active recording will be lost. Close anyway?",n.returnValue},window.addEventListener("beforeunload",this.beforeUnloadHandler),e&&this.refreshUserStatus().catch(()=>{}),this.settings.hasShownWelcome||this.app.workspace.onLayoutReady(()=>{new G(this.app,this).open()})}onunload(){this.recorder&&this.recorder.getState()!=="idle"&&this.recorder.cancelRecording(),this.statusBarEl&&(this.statusBarClickHandler&&this.statusBarEl.removeEventListener("click",this.statusBarClickHandler),this.statusBarContextHandler&&this.statusBarEl.removeEventListener("contextmenu",this.statusBarContextHandler),this.statusBarTouchStart&&this.statusBarEl.removeEventListener("touchstart",this.statusBarTouchStart),this.statusBarTouchEnd&&this.statusBarEl.removeEventListener("touchend",this.statusBarTouchEnd),this.statusBarTouchMove&&this.statusBarEl.removeEventListener("touchmove",this.statusBarTouchMove)),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.animationTimeouts.forEach(e=>clearTimeout(e)),this.animationTimeouts=[],this.beforeUnloadHandler&&(window.removeEventListener("beforeunload",this.beforeUnloadHandler),this.beforeUnloadHandler=null),this.ariaLiveRegion&&(this.ariaLiveRegion.remove(),this.ariaLiveRegion=null),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.statusBarClickHandler=null,this.statusBarContextHandler=null,this.statusBarTouchStart=null,this.statusBarTouchEnd=null,this.statusBarTouchMove=null}async loadSettings(){this.settings=Object.assign({},$,await this.loadData()),await this.migrateToEncryptedTokens()}async saveSettings(){await this.saveData(this.settings)}getVaultPath(){return c.Platform.isMobileApp?this.app.vault.getName():this.app.vault.adapter.basePath||this.app.vault.getName()}getMachineId(){return this.settings.machineId||(this.settings.machineId=crypto.randomUUID()),this.settings.machineId}getDeviceId(){return this.settings.deviceId||(this.settings.deviceId=crypto.randomUUID()),this.settings.deviceId}async setAccessToken(e){if(!e){this.settings.encryptedAccessToken=void 0,this.settings.accessToken=void 0;return}if(!k())throw new Error("Web Crypto API unavailable. Cannot securely store authentication tokens.");let t=this.getVaultPath(),n=this.getMachineId();this.settings.encryptedAccessToken=await R(e,t,n),this.settings.accessToken=void 0,this.settings.tokenStorageVersion=2}async getAccessToken(){if(this.settings.tokenStorageVersion===2&&this.settings.encryptedAccessToken){if(!k()){console.error("AICHE: Web Crypto API unavailable, cannot decrypt token");return}try{let e=this.getVaultPath(),t=this.getMachineId();return await D(this.settings.encryptedAccessToken,e,t)}catch(e){console.error("AICHE: Failed to decrypt access token:",e);return}}return this.settings.accessToken||void 0}async setRefreshToken(e){if(!e){this.settings.encryptedRefreshToken=void 0,this.settings.refreshToken=void 0;return}if(!k())throw new Error("Web Crypto API unavailable. Cannot securely store authentication tokens.");let t=this.getVaultPath(),n=this.getMachineId();this.settings.encryptedRefreshToken=await R(e,t,n),this.settings.refreshToken=void 0}async getRefreshToken(){if(this.settings.tokenStorageVersion===2&&this.settings.encryptedRefreshToken){if(!k()){console.error("AICHE: Web Crypto API unavailable, cannot decrypt token");return}try{let e=this.getVaultPath(),t=this.getMachineId();return await D(this.settings.encryptedRefreshToken,e,t)}catch(e){console.error("AICHE: Failed to decrypt refresh token:",e);return}}return this.settings.refreshToken||void 0}async migrateToEncryptedTokens(){if(this.settings.tokenStorageVersion!==2&&!(!this.settings.accessToken&&!this.settings.refreshToken)){if(!k()){console.warn("AICHE: Cannot migrate tokens - Web Crypto API unavailable");return}try{this.settings.accessToken&&await this.setAccessToken(this.settings.accessToken),this.settings.refreshToken&&await this.setRefreshToken(this.settings.refreshToken),await this.saveSettings(),new c.Notice("Security upgrade complete")}catch(e){console.error("AICHE: Token migration failed:",e)}}}getDeviceInfo(){let e=this.getDeviceId();return{name:`Obsidian (${c.Platform.isDesktop?"Desktop":"Mobile"})`,device_fingerprint:e,device_id:e,os:c.Platform.isDesktop?c.Platform.isMacOS?"macOS":c.Platform.isWin?"Windows":"Linux":c.Platform.isIosApp?"iOS":"Android",app_version:this.manifest.version}}generateAuthState(){let e=new Uint8Array(16);crypto.getRandomValues(e);let t=Array.from(e,n=>n.toString(16).padStart(2,"0")).join("");return this.pendingAuth={state:t,timestamp:Date.now()},t}validateAuthState(e){return!(!this.pendingAuth||this.pendingAuth.state!==e||Date.now()-this.pendingAuth.timestamp>300*1e3)}clearAuthState(){this.pendingAuth=null}async handleAuthCallback(e){let{code:t,state:n,error:r}=e;if(r){new c.Notice(`Sign-in failed: ${r}`);return}if(!t){new c.Notice("Sign-in failed: No device code received");return}if(n&&!this.validateAuthState(n)){new c.Notice("Session expired. Please try again."),this.clearAuthState();return}try{await this.activateDeviceCode(t),this.clearAuthState()}catch(o){new c.Notice(this.getUserFriendlyError(o))}}openAuthInBrowser(){let e=this.generateAuthState(),t=this.getDeviceInfo(),n=encodeURIComponent(JSON.stringify({name:t.name,os:t.os,app_version:t.app_version,fingerprint:t.device_fingerprint})),r=`https://aiche.app/connect-device?redirect=obsidian://aiche-auth&state=${e}&device=${n}&client=obsidian`;T(r)}async activateDeviceCode(e){try{let t=this.getDeviceInfo(),n=await this.api.activateDeviceCode(e,t);await this.setAccessToken(n.access_token),await this.setRefreshToken(n.refresh_token),this.settings.tokenExpiresAt=Date.now()+n.expires_in*1e3,this.settings.userEmail=n.user.email,this.settings.userId=n.user.id,this.api.setTokens(n.access_token,n.refresh_token),await this.refreshUserStatus(),await this.saveSettings(),new c.Notice("Account connected"),this.updateStatusBar()}catch(t){throw new Error(E(t)||"Failed to activate device code")}}async refreshUserStatus(){let e=await this.api.getUserProfile();this.settings.userEmail=e.email,this.settings.userId=e.id;let t=e.is_premium||!1;this.settings.isSubscribed=t,this.settings.subscriptionPlan=e.plan_name||null,await this.saveSettings(),this.updateStatusBar()}openConnectModal(){new A(this.app,this).open()}async logout(){await this.api.logout(),this.settings.encryptedAccessToken=void 0,this.settings.encryptedRefreshToken=void 0,this.settings.accessToken=void 0,this.settings.refreshToken=void 0,this.settings.tokenExpiresAt=0,this.settings.userEmail="",this.settings.userId=null,this.settings.isSubscribed=!1,this.settings.subscriptionPlan=null,await this.saveSettings(),this.updateStatusBar(),new c.Notice("Account disconnected")}generateNoteTitle(){let e=new Date,n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()],r=e.getDate(),o=e.getHours(),a=e.getMinutes().toString().padStart(2,"0"),d=o>=12?"pm":"am";return o=o%12||12,`${n} ${r}, ${o}.${a}${d}`}async createVoiceNote(){let e=this.settings.spokenNotesFolder||"Voice Notes",t=this.generateNoteTitle(),n=`${e}/${t}.md`;try{this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e);let o=1;for(;this.app.vault.getAbstractFileByPath(n);)n=`${e}/${t} (${o}).md`,o++;let a=await this.app.vault.create(n,"");return await this.app.workspace.getLeaf(!1).openFile(a),a}catch(r){return new c.Notice(`Could not create note: ${E(r)}`),null}}async moveNoteToCategory(e,t){var a;let n=this.settings.spokenNotesFolder||"Voice Notes",r=j[t],o=`${n}/${r}`;if(((a=e.parent)==null?void 0:a.path)!==o)try{this.app.vault.getAbstractFileByPath(o)||await this.app.vault.createFolder(o);let l=`${o}/${e.name}`,u=1;for(;this.app.vault.getAbstractFileByPath(l);){let p=e.basename,g=e.extension;l=`${o}/${p} ${u}.${g}`,u++}await this.app.fileManager.renameFile(e,l)}catch(d){console.error("Failed to move note to category folder:",d)}}async newVoiceNote(){if(!(this.settings.encryptedAccessToken||this.settings.accessToken)){new c.Notice("Connect your account to start recording"),new A(this.app,this).open();return}if(!this.settings.isSubscribed){new c.Notice("Subscription required"),new L(this.app).open();return}if(await this.createVoiceNote()){await new Promise(n=>setTimeout(n,100));try{await this.recorder.startRecording(),this.vibrate(50),this.showRecordingNotice("Recording...",0),this.announceToScreenReader("Recording started. Speak now.")}catch(n){this.showRecordingNotice(this.getUserFriendlyError(n),3e3)}}}async toggleRecording(){if(!this.recorder)return;let e=this.recorder.getState();e==="idle"?await this.startRecording():(e==="recording"||e==="paused")&&await this.stopAndTranscribe()}async startRecording(){if(!(this.settings.encryptedAccessToken||this.settings.accessToken)){new c.Notice("Connect your account to start recording"),new A(this.app,this).open();return}if(!this.settings.isSubscribed){new c.Notice("Subscription required"),new L(this.app).open();return}if(!this.settings.hasGivenPrivacyConsent){new W(this.app,this,async()=>{await this.proceedWithRecording()}).open();return}await this.proceedWithRecording()}async proceedWithRecording(){let e=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(!e){if(!await this.createVoiceNote())return;await new Promise(n=>setTimeout(n,100)),e=this.app.workspace.getActiveViewOfType(c.MarkdownView)}try{await this.recorder.startRecording(),this.vibrate(50),this.showRecordingNotice("Recording...",0),this.announceToScreenReader("Recording started. Speak now.")}catch(t){this.showRecordingNotice(this.getUserFriendlyError(t),3e3)}}async stopAndTranscribe(){var n;if(!this.recorder)return;let e=null,t="";try{e=await this.recorder.stopRecording(),t=`recording-${Date.now()}.webm`,this.setProcessingState(!0),this.showRecordingNotice("Processing...",0);let r=await this.api.transcribeAudio(e,t);if(r.status==="failed")throw new Error(r.error||"Transcription failed");let o=this.settings.autoEnhance&&r.enhanced_text?r.enhanced_text:r.text;if(!o){this.showRecordingNotice("No speech detected",2e3),this.showErrorAnimation();return}let a=this.app.workspace.getActiveFile(),d=this.settings.spokenNotesFolder||"Voice Notes",l=((n=a==null?void 0:a.parent)==null?void 0:n.path)||"",u=l===d||l.startsWith(d+"/");if(u&&this.settings.attachAudioToVoiceNotes&&a&&e?await this.insertTextWithAudio(o,e,a):this.insertText(o),u&&this.settings.organizeByCategoryFolders&&a){let g=X(r.category);await this.moveNoteToCategory(a,g)}this.showSuccessAnimation(),this.vibrate([50,30,50]),this.settings.showNotifications&&this.showRecordingNotice(`${r.word_count||0} words added`,2e3),this.announceToScreenReader(`Done. ${r.word_count||0} words added.`)}catch(r){this.isNetworkError(r)&&e?(await this.saveToOfflineQueue(e,t),this.showRecordingNotice("Offline. Saved for retry.",3e3),this.announceToScreenReader("Offline. Recording saved for later.")):(this.showRecordingNotice(this.getUserFriendlyError(r),3e3),this.announceToScreenReader("Failed. Try again.")),this.showErrorAnimation(),this.vibrate([100,50,100])}}insertText(e){let t=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(!t){new c.Notice("No note open. Text copied to clipboard."),navigator.clipboard.writeText(e);return}let n=t.editor;if(this.settings.insertAtCursor){let r=n.getCursor();n.replaceRange(e,r);let o=e.split(`
`),a=o[o.length-1].length;n.setCursor({line:r.line+o.length-1,ch:o.length===1?r.ch+a:a})}else{let r=n.getValue(),o=r+(r.endsWith(`
`)?"":`
`)+e+`
`;n.setValue(o),n.setCursor(n.lastLine())}}async insertTextWithAudio(e,t,n){var o;let r=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(!r){new c.Notice("No note open. Text copied to clipboard."),navigator.clipboard.writeText(e);return}try{let a=this.getAttachmentFolder(n),l=`Recording ${n.basename}.webm`,u=a?`${a}/${l}`:l,p=2;for(;this.app.vault.getAbstractFileByPath(u);)l=`Recording ${n.basename} ${p}.webm`,u=a?`${a}/${l}`:l,p++;a&&(this.app.vault.getAbstractFileByPath(a)||await this.app.vault.createFolder(a)),await this.app.vault.createBinary(u,t);let g=`![[${l}]]`,f=r.editor,v=f.getValue();if(v.trim()===""){let y=`${e}

${g}
`;f.setValue(y);let b=e.split(`
`);f.setCursor({line:b.length-1,ch:b[b.length-1].length})}else if(this.settings.insertAtCursor){let y=`${e}

${g}
`,b=f.getCursor();f.replaceRange(y,b);let w=e.split(`
`);f.setCursor({line:b.line+w.length-1,ch:w[w.length-1].length})}else{let y=`${e}

${g}
`,b=v+(v.endsWith(`
`)?"":`
`)+y;f.setValue(b);let w=e.split(`
`),C=v.split(`
`).length;f.setCursor({line:C+w.length-1,ch:w[w.length-1].length})}let h=(o=this.app.workspace.getActiveViewOfType(c.MarkdownView))==null?void 0:o.leaf;if(h){let y=h.getViewState();await h.setViewState({...y,state:{...y.state,mode:"preview"}}),await h.setViewState({...y,state:{...y.state,mode:"source"}})}}catch(a){console.error("Failed to save audio:",a),this.insertText(e)}}getAttachmentFolder(e){var r;let t=this.app.vault.config,n=(t==null?void 0:t.attachmentFolderPath)||"";if(!n||n==="/")return"";if(n.startsWith("./")){let o=((r=e.parent)==null?void 0:r.path)||"",a=n.slice(2);return o?a?`${o}/${a}`:o:a}else return n}updateRecordingUI(e){if(this.ribbonIconEl){switch(this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),document.body.removeClass("aiche-is-recording","aiche-is-processing"),this.updateCommandIcon(e),e){case"recording":this.ribbonIconEl.addClass("aiche-recording"),document.body.addClass("aiche-is-recording"),(0,c.setIcon)(this.ribbonIconEl,"mic");break;case"paused":this.ribbonIconEl.addClass("aiche-paused"),document.body.addClass("aiche-is-recording"),(0,c.setIcon)(this.ribbonIconEl,"pause");break;case"processing":this.ribbonIconEl.addClass("aiche-processing"),document.body.addClass("aiche-is-processing"),(0,c.setIcon)(this.ribbonIconEl,"loader");break;default:(0,c.setIcon)(this.ribbonIconEl,"mic")}this.updateStatusBar()}}updateCommandIcon(e){var r;let t=(r=this.app.commands)==null?void 0:r.commands;if(!t)return;let n=t["aiche-voice:toggle-recording"];if(n)switch(e){case"recording":case"paused":n.icon="square";break;case"processing":n.icon="loader";break;default:n.icon="mic"}}updateDurationDisplay(e){if(!this.statusBarEl)return;let t=Math.floor(e/60),n=e%60,r=`${t}:${n.toString().padStart(2,"0")}`;this.statusBarEl.setText(`Recording ${r}`),this.statusBarEl.addClass("aiche-status-recording")}updateStatusBar(){var r,o;if(!this.statusBarEl)return;let e=((r=this.recorder)==null?void 0:r.getState())||"idle";if(this.statusBarEl.removeClass("aiche-status-recording","aiche-status-processing","aiche-status-ready","aiche-status-error"),e==="recording"){this.statusBarEl.addClass("aiche-status-recording");return}if(e==="processing"){this.statusBarEl.addClass("aiche-status-processing"),this.statusBarEl.setText("Processing...");return}let t=this.settings.encryptedAccessToken||this.settings.accessToken,n=((o=this.settings.pendingTranscriptions)==null?void 0:o.length)||0;t?this.settings.isSubscribed?(this.statusBarEl.addClass("aiche-status-ready"),n>0?(this.statusBarEl.setText(`Voice (${n} saved)`),this.statusBarEl.setAttribute("aria-label",`${n} recordings saved for retry`)):(this.statusBarEl.setText("Voice"),this.statusBarEl.setAttribute("aria-label","Toggle voice recording"))):this.statusBarEl.setText("Voice: No subscription"):this.statusBarEl.setText("Voice: Not connected")}showStatusBarMenu(e){var a,d;let t=new c.Menu,n=((a=this.recorder)==null?void 0:a.getState())||"idle";n==="recording"||n==="paused"?(t.addItem(l=>l.setTitle("Stop recording").setIcon("check").onClick(()=>this.stopAndTranscribe())),t.addItem(l=>l.setTitle("Cancel").setIcon("x").onClick(()=>{var u;(u=this.recorder)==null||u.cancelRecording(),this.showRecordingNotice("Recording canceled",1500)}))):(t.addItem(l=>l.setTitle("Start recording").setIcon("mic").onClick(()=>this.toggleRecording())),t.addItem(l=>l.setTitle("New voice note").setIcon("file-plus").onClick(()=>this.newVoiceNote()))),t.addSeparator(),this.settings.encryptedAccessToken||this.settings.accessToken?t.addItem(l=>l.setTitle("Refresh status").setIcon("refresh-cw").onClick(async()=>{try{await this.refreshUserStatus(),new c.Notice("Status updated")}catch(u){new c.Notice("Could not refresh. Check connection.")}})):t.addItem(l=>l.setTitle("Connect account").setIcon("log-in").onClick(()=>new A(this.app,this).open()));let o=((d=this.settings.pendingTranscriptions)==null?void 0:d.length)||0;o>0&&(t.addSeparator(),t.addItem(l=>l.setTitle(`Retry saved (${o})`).setIcon("upload").onClick(()=>this.processOfflineQueue())),t.addItem(l=>l.setTitle("Delete saved").setIcon("trash").onClick(()=>this.clearOfflineQueue()))),t.addItem(l=>l.setTitle("Settings").setIcon("settings").onClick(()=>{this.app.setting.open(),this.app.setting.openTabById("aiche-voice")})),t.showAtMouseEvent(e)}setProcessingState(e){!this.ribbonIconEl||!this.statusBarEl||(e?(this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-success","aiche-error"),this.ribbonIconEl.addClass("aiche-processing"),(0,c.setIcon)(this.ribbonIconEl,"loader"),this.statusBarEl.removeClass("aiche-status-recording","aiche-status-ready","aiche-status-success","aiche-status-error"),this.statusBarEl.addClass("aiche-status-processing"),this.statusBarEl.setText("Processing...")):(this.ribbonIconEl.removeClass("aiche-processing"),this.statusBarEl.removeClass("aiche-status-processing")))}showSuccessAnimation(){if(!this.ribbonIconEl)return;this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),this.ribbonIconEl.addClass("aiche-success"),(0,c.setIcon)(this.ribbonIconEl,"check"),this.statusBarEl&&(this.statusBarEl.removeClass("aiche-status-processing"),this.statusBarEl.setText("Done"),this.statusBarEl.addClass("aiche-status-success"));let e=setTimeout(()=>{let t=this.animationTimeouts.indexOf(e);t>-1&&this.animationTimeouts.splice(t,1),this.ribbonIconEl&&(this.ribbonIconEl.removeClass("aiche-success"),(0,c.setIcon)(this.ribbonIconEl,"mic")),this.statusBarEl&&this.statusBarEl.removeClass("aiche-status-success"),this.updateStatusBar()},1500);this.animationTimeouts.push(e)}showErrorAnimation(){if(!this.ribbonIconEl)return;this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),this.ribbonIconEl.addClass("aiche-error"),(0,c.setIcon)(this.ribbonIconEl,"mic"),this.statusBarEl&&(this.statusBarEl.removeClass("aiche-status-processing"),this.statusBarEl.addClass("aiche-status-error"));let e=setTimeout(()=>{let t=this.animationTimeouts.indexOf(e);t>-1&&this.animationTimeouts.splice(t,1),this.ribbonIconEl&&this.ribbonIconEl.removeClass("aiche-error"),this.statusBarEl&&this.statusBarEl.removeClass("aiche-status-error"),this.updateStatusBar()},500);this.animationTimeouts.push(e)}createAriaLiveRegion(){this.ariaLiveRegion=document.body.createDiv({cls:"aiche-sr-only"}),this.ariaLiveRegion.setAttribute("role","status"),this.ariaLiveRegion.setAttribute("aria-live","polite"),this.ariaLiveRegion.setAttribute("aria-atomic","true")}announceToScreenReader(e){this.ariaLiveRegion&&(this.ariaLiveRegion.setText(""),setTimeout(()=>{this.ariaLiveRegion&&this.ariaLiveRegion.setText(e)},100))}showRecordingNotice(e,t=2500){this.activeNotice&&this.activeNotice.hide(),this.activeNotice=new c.Notice(e,t)}hideActiveNotice(){this.activeNotice&&(this.activeNotice.hide(),this.activeNotice=null)}vibrate(e=50){c.Platform.isMobileApp&&navigator.vibrate&&navigator.vibrate(e)}async saveToOfflineQueue(e,t){let n=this.getVaultPath(),r=this.getMachineId(),o=await te(e,t,n,r);this.settings.pendingTranscriptions=se(this.settings.pendingTranscriptions,o),await this.saveSettings(),this.updateStatusBar()}async processOfflineQueue(){if(this.isProcessingQueue||!navigator.onLine)return;this.settings.pendingTranscriptions=re(this.settings.pendingTranscriptions),await this.saveSettings();let e=oe(this.settings.pendingTranscriptions);if(e.pending!==0){this.isProcessingQueue=!0;try{for(new c.Notice(`Retrying ${e.pending} saved recording${e.pending>1?"s":""}...`);;){let t=ie(this.settings.pendingTranscriptions);if(!t)break;if(!navigator.onLine){new c.Notice("Still offline. Will retry when connected.");break}try{let n=this.getVaultPath(),r=this.getMachineId(),o;try{let l=await D(t.audioData,n,r);o=Z(l)}catch(l){console.error("Failed to decrypt queued audio:",l),this.settings.pendingTranscriptions=_(this.settings.pendingTranscriptions,t.id),await this.saveSettings();continue}let a=await this.api.transcribeAudio(o,t.filename);if(a.status==="failed")throw new Error(a.error||"Transcription failed");let d=this.settings.autoEnhance&&a.enhanced_text?a.enhanced_text:a.text;d&&(this.insertText(d),new c.Notice(`Saved recording processed: ${a.word_count||0} words added`)),this.settings.pendingTranscriptions=_(this.settings.pendingTranscriptions,t.id),await this.saveSettings()}catch(n){if(this.isNetworkError(n)){new c.Notice("Connection lost. Will retry later.");break}let r=ne(t);r.retryCount>=3?(this.settings.pendingTranscriptions=_(this.settings.pendingTranscriptions,t.id),new c.Notice("Recording failed after 3 attempts. Removed.")):this.settings.pendingTranscriptions=this.settings.pendingTranscriptions.map(o=>o.id===t.id?r:o),await this.saveSettings()}}this.updateStatusBar()}finally{this.isProcessingQueue=!1}}}async clearOfflineQueue(){this.settings.pendingTranscriptions=[],await this.saveSettings(),this.updateStatusBar(),new c.Notice("Saved recordings deleted")}isNetworkError(e){let t=E(e).toLowerCase();return!navigator.onLine||t.includes("network")||t.includes("fetch")||t.includes("connection")||t.includes("timeout")||t.includes("econnrefused")||t.includes("enotfound")||t.includes("net::err")}getUserFriendlyError(e){let t=E(e);return this.isNetworkError(e)?"No internet. Check connection and try again.":t.includes("Session expired")||t.includes("401")?"Session expired. Reconnect in settings.":t.includes("refresh token")||t.includes("No refresh")?"Sign-in expired. Reconnect your account.":t.includes("NotAllowedError")||t.includes("Permission denied")?"Microphone blocked. Allow access in system settings.":t.includes("NotFoundError")||t.includes("No microphone")?"No microphone found. Connect one and try again.":t.includes("NotReadableError")?"Microphone busy. Close other apps using it.":t.includes("too short")?"Too short. Speak for at least 1 second.":t.includes("Already recording")?"Already recording. Stop first.":t.includes("subscription")||t.includes("premium")?"Subscription required. Visit aiche.app/pricing":t.includes("Transcription failed")?"Failed. Check connection and try again.":t.includes("500")||t.includes("Internal")?"Server error. Try again in a moment.":t.includes("503")||t.includes("Service Unavailable")?"Service busy. Try again shortly.":t.length>100?"Something went wrong. Try again.":t}},W=class extends c.Modal{constructor(e,t,n){super(e);this.consentCheckbox=null;this.plugin=t,this.onConsent=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("aiche-modal");let t=e.createEl("h2",{text:"Privacy & Data Consent"});t.style.marginBottom="16px";let n=e.createEl("p",{text:"Before you record, please review how your data is handled:"});n.style.marginBottom="16px",n.style.fontWeight="500";let r=e.createEl("div",{cls:"aiche-consent-info"});r.style.backgroundColor="var(--background-secondary)",r.style.padding="14px",r.style.borderRadius="4px",r.style.marginBottom="16px",r.style.lineHeight="1.6";let o=[{icon:"upload-cloud",text:"Audio sent to AICHE servers for AI processing"},{icon:"trash-2",text:"Audio deleted immediately after transcription"},{icon:"lock",text:"Offline recordings saved locally (encrypted AES-GCM)"},{icon:"database",text:"Transcribed text stored with your account for history"}];o.forEach((y,b)=>{let w=r.createEl("div");w.style.display="flex",w.style.alignItems="center",w.style.gap="10px",w.style.marginBottom=b<o.length-1?"8px":"0",w.style.fontSize="14px";let C=w.createSpan();C.style.width="18px",C.style.height="18px",C.style.flexShrink="0",(0,c.setIcon)(C,y.icon),w.createSpan({text:y.text})});let a=e.createEl("div");a.style.marginBottom="16px",a.style.fontSize="13px";let d=a.createEl("span",{text:"Full details: "});d.style.color="var(--text-muted)";let l=a.createEl("a",{text:"Privacy Policy"});l.href="#",l.style.color="var(--interactive-accent)",l.addEventListener("click",y=>{y.preventDefault(),T("https://aiche.app/privacy")});let u=e.createEl("div",{cls:"aiche-consent-checkbox"});u.style.display="flex",u.style.alignItems="center",u.style.gap="12px",u.style.marginBottom="16px",u.style.padding="12px",u.style.backgroundColor="var(--background-secondary)",u.style.borderRadius="4px";let p=u.createEl("input",{type:"checkbox"});p.style.cursor="pointer",p.style.width="18px",p.style.height="18px",p.style.minWidth="18px",p.style.margin="0",p.id="aiche-consent-checkbox",this.consentCheckbox=p;let g=u.createEl("label",{text:"I understand and consent to the data practices described above"});g.style.fontSize="14px",g.style.cursor="pointer",g.style.userSelect="none",g.style.lineHeight="1.4",g.setAttribute("for","aiche-consent-checkbox");let f=e.createEl("div",{cls:"aiche-modal-buttons"});f.style.display="flex",f.style.gap="8px";let v=f.createEl("button",{text:"Not now"});v.style.flex="1",v.style.padding="8px",v.style.backgroundColor="transparent",v.style.border="1px solid var(--divider-color)",v.style.borderRadius="4px",v.style.cursor="pointer",v.addEventListener("click",()=>this.close());let h=f.createEl("button",{text:"I Consent & Record"});h.style.flex="1",h.style.padding="8px",h.style.backgroundColor="var(--interactive-accent)",h.style.color="white",h.style.border="none",h.style.borderRadius="4px",h.style.cursor="pointer",h.style.fontWeight="500",h.style.opacity="0.5",h.style.pointerEvents="none",p.addEventListener("change",()=>{p.checked?(h.style.opacity="1",h.style.pointerEvents="auto"):(h.style.opacity="0.5",h.style.pointerEvents="none")}),h.addEventListener("click",async()=>{p.checked&&(this.plugin.settings.hasGivenPrivacyConsent=!0,await this.plugin.saveSettings(),this.close(),await this.onConsent())})}},A=class extends c.Modal{constructor(e,t){super(e);this.codeInput=null;this.manualSection=null;this.plugin=t}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("aiche-connect-modal"),e.createEl("h2",{text:"Connect Your Account"}),e.createEl("p",{text:"Sign in to start recording.",cls:"setting-item-description"});let n=e.createDiv({cls:"aiche-primary-action"}).createEl("button",{text:"Sign In",cls:"mod-cta aiche-signin-btn"});n.style.width="100%",n.style.padding="12px",n.style.fontSize="16px",n.style.marginBottom="16px",n.onclick=()=>{this.plugin.openAuthInBrowser()},e.createEl("p",{text:"Opens aiche.app. You'll return here after signing in.",cls:"setting-item-description"});let r=e.createDiv({cls:"aiche-divider"});r.style.borderTop="1px solid var(--background-modifier-border)",r.style.margin="20px 0",r.style.position="relative";let o=r.createEl("span",{text:"or enter code manually"});o.style.position="absolute",o.style.top="-10px",o.style.left="50%",o.style.transform="translateX(-50%)",o.style.background="var(--modal-background)",o.style.padding="0 10px",o.style.color="var(--text-muted)",o.style.fontSize="12px",this.manualSection=e.createDiv({cls:"aiche-manual-section"});let a=this.manualSection.createEl("details"),d=a.createEl("summary",{text:"Having trouble? Enter code manually"});d.style.cursor="pointer",d.style.color="var(--text-muted)",d.style.marginBottom="12px";let l=a.createDiv();l.createEl("p",{text:`1. Go to aiche.app/account \u2192 "Connect Device"
2. Copy the code and paste below:`,cls:"setting-item-description"}),new c.Setting(l).setName("Code").addText(h=>{this.codeInput=h.inputEl,h.setPlaceholder("XXXX-XXXX-XXXX"),h.inputEl.style.width="220px",h.inputEl.style.textTransform="uppercase",h.inputEl.addEventListener("keypress",async y=>{y.key==="Enter"&&await this.submitCode()})}).addButton(h=>h.setButtonText("Connect").onClick(async()=>{await this.submitCode()}));let u=e.createDiv({cls:"modal-button-container"});u.style.marginTop="16px";let p=u.createEl("button",{text:"Create Account"});p.onclick=()=>{T("https://aiche.app/signup")};let g=u.createEl("button",{text:"Cancel"});g.onclick=()=>this.close();let f=e.createDiv();f.style.marginTop="16px",f.style.fontSize="12px",f.style.color="var(--text-muted)",f.style.textAlign="center",f.createEl("span",{text:"By signing in, you agree to our "});let v=f.createEl("a",{text:"Privacy Policy"});v.href="#",v.style.color="var(--interactive-accent)",v.style.textDecoration="none",v.onclick=h=>{h.preventDefault(),T("https://aiche.app/privacy")},f.createEl("span",{text:"."})}async submitCode(){var t,n;let e=(n=(t=this.codeInput)==null?void 0:t.value)==null?void 0:n.trim();if(!e){new c.Notice("Enter a code");return}if(this.plugin.pendingAuth||this.plugin.generateAuthState(),this.plugin.pendingAuth&&Date.now()-this.plugin.pendingAuth.timestamp>300*1e3){new c.Notice("Timed out. Reopen and try again."),this.plugin.clearAuthState(),this.close();return}try{await this.plugin.activateDeviceCode(e),this.plugin.clearAuthState(),this.close()}catch(r){new c.Notice(`Failed: ${E(r)}`)}}onClose(){this.contentEl.empty()}},L=class extends c.Modal{constructor(s){super(s)}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:"Subscription Required"}),s.createEl("p",{text:"You need an active subscription to use voice recording."});let e=s.createDiv({cls:"modal-button-container"}),t=e.createEl("button",{text:"See Plans",cls:"mod-cta"});t.onclick=()=>{T("https://aiche.app/pricing"),this.close()};let n=e.createEl("button",{text:"Later"});n.onclick=()=>this.close()}onClose(){this.contentEl.empty()}},G=class extends c.Modal{constructor(s,e){super(s),this.plugin=e}onOpen(){let{contentEl:s}=this;s.addClass("aiche-welcome-modal"),s.createEl("h2",{text:"Welcome to Voice Recording"}),s.createEl("p",{text:"Speak into your notes. Get polished text in seconds.",cls:"setting-item-description"});let e=s.createDiv({cls:"aiche-welcome-guide"});[{num:"1",text:"Connect your account"},{num:"2",text:"Click the microphone or use a hotkey"},{num:"3",text:"Speak, then click again to finish"}].forEach(l=>{let u=e.createDiv({cls:"aiche-welcome-step"});u.createSpan({text:l.num,cls:"aiche-welcome-step-icon"}),u.createSpan({text:l.text,cls:"aiche-welcome-step-text"})}),s.createEl("p",{text:"Grammar and punctuation are handled automatically.",cls:"setting-item-description"});let n=s.createDiv({cls:"modal-button-container"});n.style.marginTop="20px";let r=n.createEl("button",{text:"Connect Account",cls:"mod-cta"});r.onclick=async()=>{this.plugin.settings.hasShownWelcome=!0,await this.plugin.saveSettings(),this.close(),new A(this.app,this.plugin).open()};let o=n.createEl("button",{text:"Later"});o.onclick=async()=>{this.plugin.settings.hasShownWelcome=!0,await this.plugin.saveSettings(),this.close()};let a=s.createDiv();a.style.marginTop="20px",a.style.fontSize="12px",a.style.color="var(--text-muted)",a.style.textAlign="center",a.createEl("span",{text:"Learn more in our "});let d=a.createEl("a",{text:"Privacy Policy"});d.href="#",d.style.color="var(--interactive-accent)",d.style.textDecoration="none",d.onclick=l=>{l.preventDefault(),T("https://aiche.app/privacy")},a.createEl("span",{text:"."})}onClose(){this.contentEl.empty()}};
