/*
AICHE Voice - Obsidian Plugin
https://aiche.app
*/

var U=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var he=Object.prototype.hasOwnProperty;var pe=(i,s)=>{for(var e in s)U(i,e,{get:s[e],enumerable:!0})},ge=(i,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of ue(s))!he.call(i,n)&&n!==e&&U(i,n,{get:()=>s[n],enumerable:!(t=de(s,n))||t.enumerable});return i};var fe=i=>ge(U({},"__esModule",{value:!0}),i);var Ee={};pe(Ee,{default:()=>V});module.exports=fe(Ee);var a=require("obsidian");var R=require("obsidian");var F={encryptedAccessToken:void 0,encryptedRefreshToken:void 0,tokenStorageVersion:void 0,machineId:void 0,deviceId:void 0,accessToken:void 0,refreshToken:void 0,tokenExpiresAt:0,userEmail:"",userId:null,isSubscribed:!1,subscriptionPlan:null,autoEnhance:!0,insertAtCursor:!0,showNotifications:!0,hasShownWelcome:!1,spokenNotesFolder:"Voice Notes",attachAudioToVoiceNotes:!0,organizeByCategoryFolders:!1,pendingTranscriptions:[],hasGivenPrivacyConsent:!1},Q={work:"Work",life:"Life",ideas:"Ideas",misc:"Misc"};function q(i){if(!i)return"misc";switch(i.toLowerCase()){case"work":return"work";case"life":return"life";case"ideas":return"ideas";case"misc":return"misc";case"personal":return"life";case"idea":return"ideas";case"note":return"misc";default:return"misc"}}function z(i){return i instanceof Error}function me(i){return typeof i=="object"&&i!==null&&"message"in i&&typeof i.message=="string"}function ye(i){return typeof i=="object"&&i!==null&&"name"in i&&typeof i.name=="string"}function K(i){return typeof i=="object"&&i!==null&&"status"in i&&typeof i.status=="number"}function Y(i){return typeof i=="object"&&i!==null&&"json"in i&&typeof i.json=="object"&&i.json!==null&&"detail"in i.json&&typeof i.json.detail=="string"}function x(i){return z(i)||me(i)?i.message:typeof i=="string"?i:"Unknown error"}function J(i){if(z(i)||ye(i))return i.name}var A="https://api.aiche.app",N=class{constructor(){this.onTokenRefresh=null;this.refreshPromise=null;this.accessToken="",this.refreshToken=""}setTokens(s,e){this.accessToken=s,this.refreshToken=e}setTokenRefreshCallback(s){this.onTokenRefresh=s}async activateDeviceCode(s,e){let n=(await(0,R.requestUrl)({url:`${A}/api/v1/auth/device/activate`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:s.toUpperCase().trim(),device_info:e})})).json;return this.setTokens(n.access_token,n.refresh_token),n}async verifyDeviceCode(s){try{return(await(0,R.requestUrl)({url:`${A}/api/v1/auth/device/verify/${s.toUpperCase().trim()}`,method:"GET"})).json}catch(e){return{valid:!1,error:x(e)}}}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this.performTokenRefresh();try{return await this.refreshPromise}finally{this.refreshPromise=null}}async performTokenRefresh(){if(!this.refreshToken)throw new Error("No refresh token available");let e=(await(0,R.requestUrl)({url:`${A}/api/v1/auth/refresh`,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`refresh_token=${encodeURIComponent(this.refreshToken)}`})).json,t={access_token:e.access_token,refresh_token:e.refresh_token||this.refreshToken,token_type:e.token_type||"bearer",expires_in:e.expires_in||86400*8};return this.setTokens(t.access_token,t.refresh_token),this.onTokenRefresh&&this.onTokenRefresh(t),t}async request(s){let e=s.headers||{};this.accessToken&&(e.Authorization=`Bearer ${this.accessToken}`);try{return(await(0,R.requestUrl)({...s,headers:e})).json}catch(t){if(K(t)&&t.status===401&&!s.retried&&this.refreshToken)try{return await this.refreshAccessToken(),e.Authorization=`Bearer ${this.accessToken}`,(await(0,R.requestUrl)({url:s.url,method:s.method,headers:e,body:s.body})).json}catch(r){throw new Error("Session expired. Please reconnect your account.")}let n="Request failed";throw Y(t)?n=t.json.detail:n=x(t),new Error(n)}}async getUserProfile(){return this.request({url:`${A}/api/v1/auth/me`,method:"GET"})}async transcribeAudio(s,e){let t="----AicheFormBoundary"+Math.random().toString(36).substring(2),n=JSON.stringify({include_category:!0}),r=`--${t}\r
Content-Disposition: form-data; name="request"\r
Content-Type: application/json\r
\r
${n}\r
`,c=`--${t}\r
Content-Disposition: form-data; name="file"; filename="${e}"\r
Content-Type: audio/webm\r
\r
`,o=`\r
--${t}--\r
`,d=new TextEncoder().encode(r),l=new TextEncoder().encode(c),u=new TextEncoder().encode(o),h=new Uint8Array(s),p=new Uint8Array(d.length+l.length+h.length+u.length);return p.set(d,0),p.set(l,d.length),p.set(h,d.length+l.length),p.set(u,d.length+l.length+h.length),this.request({url:`${A}/api/v1/transcription/audio/direct`,method:"POST",headers:{"Content-Type":`multipart/form-data; boundary=${t}`},body:p.buffer})}async pollTranscriptionStatus(s,e=30){for(let t=0;t<e;t++){let n=await this.request({url:`${A}/api/v1/transcription/${s}`,method:"GET"});if(n.status==="completed"||n.status==="failed")return n;await new Promise(r=>setTimeout(r,Math.min(1e3+t*200,3e3)))}throw new Error("Transcription timed out")}async logout(){if(this.accessToken)try{await this.request({url:`${A}/api/v1/auth/logout`,method:"POST"})}catch(s){}this.accessToken="",this.refreshToken=""}};var H=require("obsidian"),C=null;if(!H.Platform.isMobileApp)try{C=require("child_process").spawn}catch(i){}function E(i){var s;if(H.Platform.isMobileApp){window.open(i,"_blank");return}try{let e=window.electron;if((s=e==null?void 0:e.shell)!=null&&s.openExternal){e.shell.openExternal(i);return}if(C&&process.platform==="linux"){let t={HOME:process.env.HOME||"",PATH:process.env.PATH||"/usr/bin:/bin",USER:process.env.USER||"",DISPLAY:process.env.DISPLAY||":0",XAUTHORITY:process.env.XAUTHORITY||"",DBUS_SESSION_BUS_ADDRESS:process.env.DBUS_SESSION_BUS_ADDRESS||"",XDG_RUNTIME_DIR:process.env.XDG_RUNTIME_DIR||"",XDG_CURRENT_DESKTOP:process.env.XDG_CURRENT_DESKTOP||""};C("xdg-open",[i],{detached:!0,stdio:"ignore",env:t}).unref()}else C&&process.platform==="darwin"?C("open",[i],{detached:!0,stdio:"ignore"}).unref():C&&process.platform==="win32"&&C("cmd",["/c","start","",i],{detached:!0,stdio:"ignore"}).unref()}catch(e){window.open(i,"_blank")}}var D=class{constructor(s){this.mediaRecorder=null;this.audioChunks=[];this.stream=null;this.state="idle";this.durationInterval=null;this.startTime=0;this.events=s}getState(){return this.state}setState(s){this.state=s,this.events.onStateChange(s)}async startRecording(){if(this.state!=="idle")throw new Error("Already recording. Stop first.");try{this.stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:1,sampleRate:48e3}});let s=this.getSupportedMimeType();this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:s,audioBitsPerSecond:83e3}),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.audioChunks.push(e.data)},this.mediaRecorder.onerror=e=>{var n;let t=e;this.events.onError(new Error(((n=t.error)==null?void 0:n.message)||"Recording error")),this.cleanup()},this.mediaRecorder.start(1e3),this.startTime=Date.now(),this.setState("recording"),this.durationInterval=setInterval(()=>{let e=Math.floor((Date.now()-this.startTime)/1e3);this.events.onDurationUpdate(e)},1e3)}catch(s){this.cleanup();let e=J(s);throw e==="NotAllowedError"?new Error("Microphone blocked. Allow access in system settings."):e==="NotFoundError"?new Error("No microphone found. Connect one and try again."):s}}getSupportedMimeType(){let s=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/mp4"];for(let e of s)if(MediaRecorder.isTypeSupported(e))return e;return"audio/webm"}pauseRecording(){this.state!=="recording"||!this.mediaRecorder||(this.mediaRecorder.pause(),this.setState("paused"))}resumeRecording(){this.state!=="paused"||!this.mediaRecorder||(this.mediaRecorder.resume(),this.setState("recording"))}async stopRecording(){if(this.state==="idle"||!this.mediaRecorder)throw new Error("Not recording. Start a recording first.");return this.setState("processing"),new Promise((s,e)=>{if(!this.mediaRecorder){e(new Error("No media recorder"));return}this.mediaRecorder.onstop=async()=>{var t;try{let n=new Blob(this.audioChunks,{type:((t=this.mediaRecorder)==null?void 0:t.mimeType)||"audio/webm"});if(n.size<1e3)throw new Error("Too short. Speak for at least 1 second.");let r=await n.arrayBuffer();s(r)}catch(n){e(n)}finally{this.cleanup()}},this.mediaRecorder.stop()})}cancelRecording(){this.cleanup()}cleanup(){this.durationInterval&&(clearInterval(this.durationInterval),this.durationInterval=null),this.stream&&(this.stream.getTracks().forEach(s=>s.stop()),this.stream=null),this.mediaRecorder=null,this.audioChunks=[],this.setState("idle")}getDuration(){return this.state==="idle"?0:Math.floor((Date.now()-this.startTime)/1e3)}};var m=require("obsidian");var M=class extends m.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;if(s.empty(),s.createEl("h2",{text:"Voice Recording"}),s.createEl("h3",{text:"Account"}),this.plugin.settings.encryptedAccessToken||this.plugin.settings.accessToken){new m.Setting(s).setName("Connected as").setDesc(this.plugin.settings.userEmail||"Connected").addButton(n=>n.setButtonText("Disconnect").setWarning().onClick(async()=>{await this.plugin.logout(),this.display()}));let t=this.plugin.settings.isSubscribed?`Active: ${this.plugin.settings.subscriptionPlan||"Premium"}`:"No active subscription";new m.Setting(s).setName("Subscription").setDesc(t).addButton(n=>n.setButtonText(this.plugin.settings.isSubscribed?"Manage":"Subscribe").onClick(()=>{E("https://aiche.app/account")})),new m.Setting(s).addButton(n=>n.setButtonText("Refresh Status").onClick(async()=>{await this.plugin.refreshUserStatus(),this.display()}))}else new m.Setting(s).setName("Connect your account").setDesc("Sign in to start recording.").addButton(t=>t.setButtonText("Sign In").setCta().onClick(()=>{this.plugin.openConnectModal()})),new m.Setting(s).setDesc("No account yet?").addButton(t=>t.setButtonText("Create Account").onClick(()=>{E("https://aiche.app/signup")}));s.createEl("h3",{text:"Recording"}),new m.Setting(s).setName("Polish text").setDesc("Fix grammar and punctuation automatically.").addToggle(t=>t.setValue(this.plugin.settings.autoEnhance).onChange(async n=>{this.plugin.settings.autoEnhance=n,await this.plugin.saveSettings()})),new m.Setting(s).setName("Insert at cursor").setDesc("Add text where your cursor is. Otherwise, adds to end of note.").addToggle(t=>t.setValue(this.plugin.settings.insertAtCursor).onChange(async n=>{this.plugin.settings.insertAtCursor=n,await this.plugin.saveSettings()})),new m.Setting(s).setName("Show notifications").setDesc("Show a message when recording completes.").addToggle(t=>t.setValue(this.plugin.settings.showNotifications).onChange(async n=>{this.plugin.settings.showNotifications=n,await this.plugin.saveSettings()})),new m.Setting(s).setName("Voice notes folder").setDesc("Where to save new notes when no note is open.").addText(t=>t.setPlaceholder("Voice Notes").setValue(this.plugin.settings.spokenNotesFolder).onChange(async n=>{this.plugin.settings.spokenNotesFolder=n||"Voice Notes",await this.plugin.saveSettings()})),new m.Setting(s).setName("Attach audio").setDesc("Save audio file with notes in the voice notes folder.").addToggle(t=>t.setValue(this.plugin.settings.attachAudioToVoiceNotes).onChange(async n=>{this.plugin.settings.attachAudioToVoiceNotes=n,await this.plugin.saveSettings()})),new m.Setting(s).setName("Organize by category").setDesc("Sort notes into subfolders (Work, Life, Ideas, Misc) based on content.").addToggle(t=>t.setValue(this.plugin.settings.organizeByCategoryFolders).onChange(async n=>{this.plugin.settings.organizeByCategoryFolders=n,await this.plugin.saveSettings()})),m.Platform.isMobileApp||(s.createEl("h3",{text:"Hotkeys"}),new m.Setting(s).setName("Toggle Recording").setDesc("Start or stop recording"),new m.Setting(s).setName("Cancel Recording").setDesc("Discard without saving"),new m.Setting(s).setName("New Voice Note").setDesc("Create a new note and start recording"),new m.Setting(s).setDesc('Set hotkeys in Settings \u2192 Hotkeys, search "Voice"').addButton(t=>t.setButtonText("Open Hotkeys").onClick(()=>{this.app.setting.open(),this.app.setting.openTabById("hotkeys")}))),s.createEl("h3",{text:"About"}),new m.Setting(s).setName("Version").setDesc(this.plugin.manifest.version).addButton(t=>t.setButtonText("Website").onClick(()=>{E("https://aiche.app")})).addButton(t=>t.setButtonText("Help").onClick(()=>{E("https://aiche.app/help")})).addButton(t=>t.setButtonText("Privacy").onClick(()=>{E("https://aiche.app/privacy")}))}};async function Z(i,s){let e=new TextEncoder,t=await crypto.subtle.importKey("raw",e.encode(i),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:s.buffer,iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function O(i){let s=new Uint8Array(i),e="";for(let t=0;t<s.byteLength;t++)e+=String.fromCharCode(s[t]);return btoa(e)}function W(i){let s=atob(i),e=new Uint8Array(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e}async function B(i,s,e){if(!i)throw new Error("Cannot encrypt empty token");let t=crypto.getRandomValues(new Uint8Array(16)),n=crypto.getRandomValues(new Uint8Array(12)),r=`${s}:${e}:aiche-voice`,c=await Z(r,t),o=new TextEncoder,d=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},c,o.encode(i));return{ciphertext:O(d),iv:O(n.buffer),salt:O(t.buffer)}}async function _(i,s,e){if(!i||!i.ciphertext||!i.iv||!i.salt)throw new Error("Invalid encrypted data");let t=W(i.ciphertext),n=W(i.iv),r=W(i.salt),c=`${s}:${e}:aiche-voice`,o=await Z(c,r),d=await crypto.subtle.decrypt({name:"AES-GCM",iv:n.buffer},o,t.buffer);return new TextDecoder().decode(d)}function S(){return!!(typeof crypto!="undefined"&&crypto.subtle&&typeof crypto.subtle.encrypt=="function"&&typeof crypto.subtle.decrypt=="function"&&typeof crypto.getRandomValues=="function")}var ve=50,ee=3,we=1440*60*1e3;function Te(i){let s=new Uint8Array(i),e="";for(let t=0;t<s.byteLength;t++)e+=String.fromCharCode(s[t]);return btoa(e)}function te(i){let s=atob(i),e=new Uint8Array(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e.buffer}function be(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function G(i){return Date.now()-i.timestamp>we}function ne(i){return i.retryCount<ee&&!G(i)}async function se(i,s,e,t){if(!S())throw new Error("Web Crypto API unavailable - cannot securely save offline recordings");let n=Te(i),r=await B(n,e,t);return{id:be(),audioData:r,filename:s,timestamp:Date.now(),retryCount:0}}function ie(i){return{...i,retryCount:i.retryCount+1}}function re(i,s){let e=i.filter(t=>!G(t));return e.length>=ve&&e.shift(),[...e,s]}function L(i,s){return i.filter(e=>e.id!==s)}function oe(i){for(let s of i)if(ne(s))return s;return null}function ae(i){return i.filter(s=>ne(s))}function ce(i){let s=0,e=0,t=0;for(let n of i)G(n)?e++:n.retryCount>=ee?t++:s++;return{total:i.length,pending:s,expired:e,maxRetries:t}}var V=class extends a.Plugin{constructor(){super(...arguments);this.settings=F;this.api=new N;this.recorder=null;this.statusBarEl=null;this.ribbonIconEl=null;this.pendingAuth=null;this.statusBarClickHandler=null;this.statusBarContextHandler=null;this.statusBarTouchStart=null;this.statusBarTouchEnd=null;this.statusBarTouchMove=null;this.longPressTimer=null;this.animationTimeouts=[];this.beforeUnloadHandler=null;this.ariaLiveRegion=null;this.onlineHandler=null;this.isProcessingQueue=!1;this.activeNotice=null;this.connectModal=null;this.settingTab=null}async onload(){await this.loadSettings();let e=await this.getAccessToken(),t=await this.getRefreshToken();e&&this.api.setTokens(e,t||""),this.api.setTokenRefreshCallback(async n=>{await this.setAccessToken(n.access_token),await this.setRefreshToken(n.refresh_token),this.settings.tokenExpiresAt=Date.now()+n.expires_in*1e3,await this.saveSettings()}),this.registerObsidianProtocolHandler("aiche-auth",async n=>{await this.handleAuthCallback(n)}),this.recorder=new D({onStateChange:n=>this.updateRecordingUI(n),onError:n=>new a.Notice(this.getUserFriendlyError(n)),onDurationUpdate:n=>this.updateDurationDisplay(n)}),this.ribbonIconEl=this.addRibbonIcon("mic","Voice recording",async()=>{await this.toggleRecording()}),this.ribbonIconEl.setAttribute("aria-label","Toggle voice recording"),this.statusBarEl=this.addStatusBarItem(),this.statusBarEl.addClass("aiche-status-bar"),this.statusBarEl.setAttribute("role","button"),this.statusBarEl.setAttribute("tabindex","0"),this.statusBarEl.setAttribute("aria-label","Toggle voice recording"),this.statusBarClickHandler=n=>{n.button===0&&(n.preventDefault(),n.stopPropagation(),this.toggleRecording())},this.statusBarContextHandler=n=>{n.preventDefault(),n.stopPropagation(),this.showStatusBarMenu(n)},this.statusBarEl.addEventListener("click",this.statusBarClickHandler),this.statusBarEl.addEventListener("contextmenu",this.statusBarContextHandler),a.Platform.isMobileApp&&(this.statusBarTouchStart=n=>{this.longPressTimer=setTimeout(()=>{this.vibrate(50);let r=n.touches[0],c=new MouseEvent("contextmenu",{clientX:r.clientX,clientY:r.clientY});this.showStatusBarMenu(c)},500)},this.statusBarTouchEnd=()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},this.statusBarTouchMove=()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},this.statusBarEl.addEventListener("touchstart",this.statusBarTouchStart),this.statusBarEl.addEventListener("touchend",this.statusBarTouchEnd),this.statusBarEl.addEventListener("touchmove",this.statusBarTouchMove)),this.statusBarEl.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),this.toggleRecording())}),this.updateStatusBar(),this.createAriaLiveRegion(),this.onlineHandler=()=>{navigator.onLine&&this.settings.pendingTranscriptions.length>0&&this.processOfflineQueue()},window.addEventListener("online",this.onlineHandler),navigator.onLine&&this.settings.pendingTranscriptions.length>0&&setTimeout(()=>this.processOfflineQueue(),3e3),this.addCommand({id:"toggle-recording",name:"Toggle Recording",icon:"mic",callback:async()=>{await this.toggleRecording()}}),this.addCommand({id:"cancel-recording",name:"Cancel Recording",icon:"x",callback:()=>{this.recorder&&this.recorder.getState()!=="idle"&&(this.recorder.cancelRecording(),this.showRecordingNotice("Recording canceled",1500))}}),this.addCommand({id:"new-voice-note",name:"New Voice Note",icon:"file-plus",callback:async()=>{await this.newVoiceNote()}}),this.settingTab=new M(this.app,this),this.addSettingTab(this.settingTab),this.beforeUnloadHandler=n=>{if(this.recorder&&this.recorder.getState()!=="idle")return n.preventDefault(),n.returnValue="Active recording will be lost. Close anyway?",n.returnValue},window.addEventListener("beforeunload",this.beforeUnloadHandler),e&&this.refreshUserStatus().catch(()=>{}),this.settings.hasShownWelcome||this.app.workspace.onLayoutReady(()=>{new X(this.app,this).open()})}onunload(){this.recorder&&this.recorder.getState()!=="idle"&&this.recorder.cancelRecording(),this.statusBarEl&&(this.statusBarClickHandler&&this.statusBarEl.removeEventListener("click",this.statusBarClickHandler),this.statusBarContextHandler&&this.statusBarEl.removeEventListener("contextmenu",this.statusBarContextHandler),this.statusBarTouchStart&&this.statusBarEl.removeEventListener("touchstart",this.statusBarTouchStart),this.statusBarTouchEnd&&this.statusBarEl.removeEventListener("touchend",this.statusBarTouchEnd),this.statusBarTouchMove&&this.statusBarEl.removeEventListener("touchmove",this.statusBarTouchMove)),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.animationTimeouts.forEach(e=>clearTimeout(e)),this.animationTimeouts=[],this.beforeUnloadHandler&&(window.removeEventListener("beforeunload",this.beforeUnloadHandler),this.beforeUnloadHandler=null),this.ariaLiveRegion&&(this.ariaLiveRegion.remove(),this.ariaLiveRegion=null),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.statusBarClickHandler=null,this.statusBarContextHandler=null,this.statusBarTouchStart=null,this.statusBarTouchEnd=null,this.statusBarTouchMove=null}async loadSettings(){this.settings=Object.assign({},F,await this.loadData()),await this.migrateToEncryptedTokens()}async saveSettings(){await this.saveData(this.settings)}getVaultPath(){return a.Platform.isMobileApp?this.app.vault.getName():this.app.vault.adapter.basePath||this.app.vault.getName()}getMachineId(){return this.settings.machineId||(this.settings.machineId=crypto.randomUUID()),this.settings.machineId}getDeviceId(){return this.settings.deviceId||(this.settings.deviceId=crypto.randomUUID()),this.settings.deviceId}async setAccessToken(e){if(!e){this.settings.encryptedAccessToken=void 0,this.settings.accessToken=void 0;return}if(!S())throw new Error("Web Crypto API unavailable. Cannot securely store authentication tokens.");let t=this.getVaultPath(),n=this.getMachineId();this.settings.encryptedAccessToken=await B(e,t,n),this.settings.accessToken=void 0,this.settings.tokenStorageVersion=2}async getAccessToken(){if(this.settings.tokenStorageVersion===2&&this.settings.encryptedAccessToken){if(!S()){console.error("AICHE: Web Crypto API unavailable, cannot decrypt token");return}try{let e=this.getVaultPath(),t=this.getMachineId();return await _(this.settings.encryptedAccessToken,e,t)}catch(e){console.error("AICHE: Failed to decrypt access token:",e);return}}return this.settings.accessToken||void 0}async setRefreshToken(e){if(!e){this.settings.encryptedRefreshToken=void 0,this.settings.refreshToken=void 0;return}if(!S())throw new Error("Web Crypto API unavailable. Cannot securely store authentication tokens.");let t=this.getVaultPath(),n=this.getMachineId();this.settings.encryptedRefreshToken=await B(e,t,n),this.settings.refreshToken=void 0}async getRefreshToken(){if(this.settings.tokenStorageVersion===2&&this.settings.encryptedRefreshToken){if(!S()){console.error("AICHE: Web Crypto API unavailable, cannot decrypt token");return}try{let e=this.getVaultPath(),t=this.getMachineId();return await _(this.settings.encryptedRefreshToken,e,t)}catch(e){console.error("AICHE: Failed to decrypt refresh token:",e);return}}return this.settings.refreshToken||void 0}async migrateToEncryptedTokens(){if(this.settings.tokenStorageVersion!==2&&!(!this.settings.accessToken&&!this.settings.refreshToken)){if(!S()){console.warn("AICHE: Cannot migrate tokens - Web Crypto API unavailable");return}try{this.settings.accessToken&&await this.setAccessToken(this.settings.accessToken),this.settings.refreshToken&&await this.setRefreshToken(this.settings.refreshToken),await this.saveSettings(),new a.Notice("Security upgrade complete")}catch(e){console.error("AICHE: Token migration failed:",e)}}}getDeviceInfo(){let e=this.getDeviceId();return{name:`Obsidian (${a.Platform.isDesktop?"Desktop":"Mobile"})`,device_fingerprint:e,device_id:e,os:a.Platform.isDesktop?a.Platform.isMacOS?"macOS":a.Platform.isWin?"Windows":"Linux":a.Platform.isIosApp?"iOS":"Android",app_version:this.manifest.version}}generateAuthState(){let e=new Uint8Array(16);crypto.getRandomValues(e);let t=Array.from(e,n=>n.toString(16).padStart(2,"0")).join("");return this.pendingAuth={state:t,timestamp:Date.now()},t}validateAuthState(e){return!(!this.pendingAuth||this.pendingAuth.state!==e||Date.now()-this.pendingAuth.timestamp>300*1e3)}clearAuthState(){this.pendingAuth=null}async handleAuthCallback(e){let{code:t,state:n,error:r}=e;if(r){new a.Notice(`Sign-in failed: ${r}`);return}if(!t){new a.Notice("Sign-in failed: No device code received");return}if(n&&!this.validateAuthState(n)){new a.Notice("Session expired. Please try again."),this.clearAuthState();return}try{await this.activateDeviceCode(t),this.clearAuthState(),this.closeConnectModal()}catch(c){new a.Notice(this.getUserFriendlyError(c))}}openAuthInBrowser(){let e=this.generateAuthState(),t=this.getDeviceInfo(),n=encodeURIComponent(JSON.stringify({name:t.name,os:t.os,app_version:t.app_version,fingerprint:t.device_fingerprint})),r=`https://aiche.app/connect-obsidian?redirect=obsidian://aiche-auth&state=${e}&device=${n}&client=obsidian`;E(r)}async activateDeviceCode(e){try{let t=this.getDeviceInfo(),n=await this.api.activateDeviceCode(e,t);await this.setAccessToken(n.access_token),await this.setRefreshToken(n.refresh_token),this.settings.tokenExpiresAt=Date.now()+n.expires_in*1e3,this.settings.userEmail=n.user.email,this.settings.userId=n.user.id,this.api.setTokens(n.access_token,n.refresh_token),await this.refreshUserStatus(),await this.saveSettings(),new a.Notice("Account connected"),this.updateStatusBar()}catch(t){throw new Error(x(t)||"Failed to activate device code")}}async refreshUserStatus(){let e=await this.api.getUserProfile();this.settings.userEmail=e.email,this.settings.userId=e.id;let t=e.is_premium||!1;this.settings.isSubscribed=t,this.settings.subscriptionPlan=e.plan_name||null,await this.saveSettings(),this.updateStatusBar()}openConnectModal(){this.connectModal=new P(this.app,this),this.connectModal.open()}closeConnectModal(){this.connectModal&&(this.connectModal.close(),this.connectModal=null),this.settingTab&&this.settingTab.display()}async logout(){await this.api.logout(),this.settings.encryptedAccessToken=void 0,this.settings.encryptedRefreshToken=void 0,this.settings.accessToken=void 0,this.settings.refreshToken=void 0,this.settings.tokenExpiresAt=0,this.settings.userEmail="",this.settings.userId=null,this.settings.isSubscribed=!1,this.settings.subscriptionPlan=null,await this.saveSettings(),this.updateStatusBar(),new a.Notice("Account disconnected")}generateNoteTitle(){let e=new Date,n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()],r=e.getDate(),c=e.getHours(),o=e.getMinutes().toString().padStart(2,"0"),d=c>=12?"pm":"am";return c=c%12||12,`${n} ${r}, ${c}.${o}${d}`}async createVoiceNote(){let e=this.settings.spokenNotesFolder||"Voice Notes",t=this.generateNoteTitle(),n=`${e}/${t}.md`;try{this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e);let c=1;for(;this.app.vault.getAbstractFileByPath(n);)n=`${e}/${t} (${c}).md`,c++;let o=await this.app.vault.create(n,"");return await this.app.workspace.getLeaf(!1).openFile(o),o}catch(r){return new a.Notice(`Could not create note: ${x(r)}`),null}}async moveNoteToCategory(e,t){var o;let n=this.settings.spokenNotesFolder||"Voice Notes",r=Q[t],c=`${n}/${r}`;if(((o=e.parent)==null?void 0:o.path)!==c)try{this.app.vault.getAbstractFileByPath(c)||await this.app.vault.createFolder(c);let l=`${c}/${e.name}`,u=1;for(;this.app.vault.getAbstractFileByPath(l);){let h=e.basename,p=e.extension;l=`${c}/${h} ${u}.${p}`,u++}await this.app.fileManager.renameFile(e,l)}catch(d){console.error("Failed to move note to category folder:",d)}}async newVoiceNote(){if(!(this.settings.encryptedAccessToken||this.settings.accessToken)){new a.Notice("Connect your account to start recording"),new P(this.app,this).open();return}if(!this.settings.isSubscribed){new a.Notice("Subscription required"),new $(this.app).open();return}if(await this.createVoiceNote()){await new Promise(n=>setTimeout(n,100));try{await this.recorder.startRecording(),this.vibrate(50),this.showRecordingNotice("Recording...",0),this.announceToScreenReader("Recording started. Speak now.")}catch(n){this.showRecordingNotice(this.getUserFriendlyError(n),3e3)}}}async toggleRecording(){if(!this.recorder)return;let e=this.recorder.getState();e==="idle"?await this.startRecording():(e==="recording"||e==="paused")&&await this.stopAndTranscribe()}async startRecording(){if(!(this.settings.encryptedAccessToken||this.settings.accessToken)){new a.Notice("Connect your account to start recording"),new P(this.app,this).open();return}if(!this.settings.isSubscribed){new a.Notice("Subscription required"),new $(this.app).open();return}if(!this.settings.hasGivenPrivacyConsent){new j(this.app,this,async()=>{await this.proceedWithRecording()}).open();return}await this.proceedWithRecording()}async proceedWithRecording(){let e=this.app.workspace.getActiveViewOfType(a.MarkdownView);if(!e){if(!await this.createVoiceNote())return;await new Promise(n=>setTimeout(n,100)),e=this.app.workspace.getActiveViewOfType(a.MarkdownView)}try{await this.recorder.startRecording(),this.vibrate(50),this.showRecordingNotice("Recording...",0),this.announceToScreenReader("Recording started. Speak now.")}catch(t){this.showRecordingNotice(this.getUserFriendlyError(t),3e3)}}async stopAndTranscribe(){var n;if(!this.recorder)return;let e=null,t="";try{e=await this.recorder.stopRecording(),t=`recording-${Date.now()}.webm`,this.setProcessingState(!0),this.showRecordingNotice("Processing...",0);let r=await this.api.transcribeAudio(e,t);if(r.status==="failed")throw new Error(r.error||"Transcription failed");let c=this.settings.autoEnhance&&r.enhanced_text?r.enhanced_text:r.text;if(!c){this.showRecordingNotice("No speech detected",2e3),this.showErrorAnimation();return}let o=this.app.workspace.getActiveFile(),d=this.settings.spokenNotesFolder||"Voice Notes",l=((n=o==null?void 0:o.parent)==null?void 0:n.path)||"",u=l===d||l.startsWith(d+"/");if(u&&this.settings.attachAudioToVoiceNotes&&o&&e?await this.insertTextWithAudio(c,e,o):this.insertText(c),u&&this.settings.organizeByCategoryFolders&&o){let p=q(r.category);await this.moveNoteToCategory(o,p)}this.showSuccessAnimation(),this.vibrate([50,30,50]),this.settings.showNotifications&&this.showRecordingNotice(`${r.word_count||0} words added`,2e3),this.announceToScreenReader(`Done. ${r.word_count||0} words added.`)}catch(r){this.isNetworkError(r)&&e?(await this.saveToOfflineQueue(e,t),this.showRecordingNotice("Offline. Saved for retry.",3e3),this.announceToScreenReader("Offline. Recording saved for later.")):(this.showRecordingNotice(this.getUserFriendlyError(r),3e3),this.announceToScreenReader("Failed. Try again.")),this.showErrorAnimation(),this.vibrate([100,50,100])}}insertText(e){let t=this.app.workspace.getActiveViewOfType(a.MarkdownView);if(!t){new a.Notice("No note open. Text copied to clipboard."),navigator.clipboard.writeText(e);return}let n=t.editor;if(this.settings.insertAtCursor){let r=n.getCursor();n.replaceRange(e,r);let c=e.split(`
`),o=c[c.length-1].length;n.setCursor({line:r.line+c.length-1,ch:c.length===1?r.ch+o:o})}else{let r=n.getValue(),c=r+(r.endsWith(`
`)?"":`
`)+e+`
`;n.setValue(c),n.setCursor(n.lastLine())}}async insertTextWithAudio(e,t,n){var c;let r=this.app.workspace.getActiveViewOfType(a.MarkdownView);if(!r){new a.Notice("No note open. Text copied to clipboard."),navigator.clipboard.writeText(e);return}try{let o=this.getAttachmentFolder(n),l=`Recording ${n.basename}.webm`,u=o?`${o}/${l}`:l,h=2;for(;this.app.vault.getAbstractFileByPath(u);)l=`Recording ${n.basename} ${h}.webm`,u=o?`${o}/${l}`:l,h++;o&&(this.app.vault.getAbstractFileByPath(o)||await this.app.vault.createFolder(o)),await this.app.vault.createBinary(u,t);let p=`![[${l}]]`,y=r.editor,v=y.getValue();if(v.trim()===""){let g=`${e}

${p}
`;y.setValue(g);let b=e.split(`
`);y.setCursor({line:b.length-1,ch:b[b.length-1].length})}else if(this.settings.insertAtCursor){let g=`${e}

${p}
`,b=y.getCursor();y.replaceRange(g,b);let w=e.split(`
`);y.setCursor({line:b.line+w.length-1,ch:w[w.length-1].length})}else{let g=`${e}

${p}
`,b=v+(v.endsWith(`
`)?"":`
`)+g;y.setValue(b);let w=e.split(`
`),T=v.split(`
`).length;y.setCursor({line:T+w.length-1,ch:w[w.length-1].length})}let f=(c=this.app.workspace.getActiveViewOfType(a.MarkdownView))==null?void 0:c.leaf;if(f){let g=f.getViewState();await f.setViewState({...g,state:{...g.state,mode:"preview"}}),await f.setViewState({...g,state:{...g.state,mode:"source"}})}}catch(o){console.error("Failed to save audio:",o),this.insertText(e)}}getAttachmentFolder(e){var r;let t=this.app.vault.config,n=(t==null?void 0:t.attachmentFolderPath)||"";if(!n||n==="/")return"";if(n.startsWith("./")){let c=((r=e.parent)==null?void 0:r.path)||"",o=n.slice(2);return c?o?`${c}/${o}`:c:o}else return n}updateRecordingUI(e){if(this.ribbonIconEl){switch(this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),document.body.removeClass("aiche-is-recording","aiche-is-processing"),this.updateCommandIcon(e),e){case"recording":this.ribbonIconEl.addClass("aiche-recording"),document.body.addClass("aiche-is-recording"),(0,a.setIcon)(this.ribbonIconEl,"mic");break;case"paused":this.ribbonIconEl.addClass("aiche-paused"),document.body.addClass("aiche-is-recording"),(0,a.setIcon)(this.ribbonIconEl,"pause");break;case"processing":this.ribbonIconEl.addClass("aiche-processing"),document.body.addClass("aiche-is-processing"),(0,a.setIcon)(this.ribbonIconEl,"loader");break;default:(0,a.setIcon)(this.ribbonIconEl,"mic")}this.updateStatusBar()}}updateCommandIcon(e){var r;let t=(r=this.app.commands)==null?void 0:r.commands;if(!t)return;let n=t["aiche-voice:toggle-recording"];if(n)switch(e){case"recording":case"paused":n.icon="square";break;case"processing":n.icon="loader";break;default:n.icon="mic"}}updateDurationDisplay(e){if(!this.statusBarEl)return;let t=Math.floor(e/60),n=e%60,r=`${t}:${n.toString().padStart(2,"0")}`;this.statusBarEl.setText(`Recording ${r}`),this.statusBarEl.addClass("aiche-status-recording")}updateStatusBar(){var r,c;if(!this.statusBarEl)return;let e=((r=this.recorder)==null?void 0:r.getState())||"idle";if(this.statusBarEl.removeClass("aiche-status-recording","aiche-status-processing","aiche-status-ready","aiche-status-error"),e==="recording"){this.statusBarEl.addClass("aiche-status-recording");return}if(e==="processing"){this.statusBarEl.addClass("aiche-status-processing"),this.statusBarEl.setText("Processing...");return}let t=this.settings.encryptedAccessToken||this.settings.accessToken,n=((c=this.settings.pendingTranscriptions)==null?void 0:c.length)||0;t?this.settings.isSubscribed?(this.statusBarEl.addClass("aiche-status-ready"),n>0?(this.statusBarEl.setText(`Voice (${n} saved)`),this.statusBarEl.setAttribute("aria-label",`${n} recordings saved for retry`)):(this.statusBarEl.setText("Voice"),this.statusBarEl.setAttribute("aria-label","Toggle voice recording"))):this.statusBarEl.setText("Voice: No subscription"):this.statusBarEl.setText("Voice: Not connected")}showStatusBarMenu(e){var o,d;let t=new a.Menu,n=((o=this.recorder)==null?void 0:o.getState())||"idle";n==="recording"||n==="paused"?(t.addItem(l=>l.setTitle("Stop recording").setIcon("check").onClick(()=>this.stopAndTranscribe())),t.addItem(l=>l.setTitle("Cancel").setIcon("x").onClick(()=>{var u;(u=this.recorder)==null||u.cancelRecording(),this.showRecordingNotice("Recording canceled",1500)}))):(t.addItem(l=>l.setTitle("Start recording").setIcon("mic").onClick(()=>this.toggleRecording())),t.addItem(l=>l.setTitle("New voice note").setIcon("file-plus").onClick(()=>this.newVoiceNote()))),t.addSeparator(),this.settings.encryptedAccessToken||this.settings.accessToken?t.addItem(l=>l.setTitle("Refresh status").setIcon("refresh-cw").onClick(async()=>{try{await this.refreshUserStatus(),new a.Notice("Status updated")}catch(u){new a.Notice("Could not refresh. Check connection.")}})):t.addItem(l=>l.setTitle("Connect account").setIcon("log-in").onClick(()=>new P(this.app,this).open()));let c=((d=this.settings.pendingTranscriptions)==null?void 0:d.length)||0;c>0&&(t.addSeparator(),t.addItem(l=>l.setTitle(`Retry saved (${c})`).setIcon("upload").onClick(()=>this.processOfflineQueue())),t.addItem(l=>l.setTitle("Delete saved").setIcon("trash").onClick(()=>this.clearOfflineQueue()))),t.addItem(l=>l.setTitle("Settings").setIcon("settings").onClick(()=>{this.app.setting.open(),this.app.setting.openTabById("aiche-voice")})),t.showAtMouseEvent(e)}setProcessingState(e){!this.ribbonIconEl||!this.statusBarEl||(e?(this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-success","aiche-error"),this.ribbonIconEl.addClass("aiche-processing"),(0,a.setIcon)(this.ribbonIconEl,"loader"),this.statusBarEl.removeClass("aiche-status-recording","aiche-status-ready","aiche-status-success","aiche-status-error"),this.statusBarEl.addClass("aiche-status-processing"),this.statusBarEl.setText("Processing...")):(this.ribbonIconEl.removeClass("aiche-processing"),this.statusBarEl.removeClass("aiche-status-processing")))}showSuccessAnimation(){if(!this.ribbonIconEl)return;this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),this.ribbonIconEl.addClass("aiche-success"),(0,a.setIcon)(this.ribbonIconEl,"check"),this.statusBarEl&&(this.statusBarEl.removeClass("aiche-status-processing"),this.statusBarEl.setText("Done"),this.statusBarEl.addClass("aiche-status-success"));let e=setTimeout(()=>{let t=this.animationTimeouts.indexOf(e);t>-1&&this.animationTimeouts.splice(t,1),this.ribbonIconEl&&(this.ribbonIconEl.removeClass("aiche-success"),(0,a.setIcon)(this.ribbonIconEl,"mic")),this.statusBarEl&&this.statusBarEl.removeClass("aiche-status-success"),this.updateStatusBar()},1500);this.animationTimeouts.push(e)}showErrorAnimation(){if(!this.ribbonIconEl)return;this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),this.ribbonIconEl.addClass("aiche-error"),(0,a.setIcon)(this.ribbonIconEl,"mic"),this.statusBarEl&&(this.statusBarEl.removeClass("aiche-status-processing"),this.statusBarEl.addClass("aiche-status-error"));let e=setTimeout(()=>{let t=this.animationTimeouts.indexOf(e);t>-1&&this.animationTimeouts.splice(t,1),this.ribbonIconEl&&this.ribbonIconEl.removeClass("aiche-error"),this.statusBarEl&&this.statusBarEl.removeClass("aiche-status-error"),this.updateStatusBar()},500);this.animationTimeouts.push(e)}createAriaLiveRegion(){this.ariaLiveRegion=document.body.createDiv({cls:"aiche-sr-only"}),this.ariaLiveRegion.setAttribute("role","status"),this.ariaLiveRegion.setAttribute("aria-live","polite"),this.ariaLiveRegion.setAttribute("aria-atomic","true")}announceToScreenReader(e){this.ariaLiveRegion&&(this.ariaLiveRegion.setText(""),setTimeout(()=>{this.ariaLiveRegion&&this.ariaLiveRegion.setText(e)},100))}showRecordingNotice(e,t=2500){this.activeNotice&&this.activeNotice.hide(),this.activeNotice=new a.Notice(e,t)}hideActiveNotice(){this.activeNotice&&(this.activeNotice.hide(),this.activeNotice=null)}vibrate(e=50){a.Platform.isMobileApp&&navigator.vibrate&&navigator.vibrate(e)}async saveToOfflineQueue(e,t){let n=this.getVaultPath(),r=this.getMachineId(),c=await se(e,t,n,r);this.settings.pendingTranscriptions=re(this.settings.pendingTranscriptions,c),await this.saveSettings(),this.updateStatusBar()}async processOfflineQueue(){if(this.isProcessingQueue||!navigator.onLine)return;this.settings.pendingTranscriptions=ae(this.settings.pendingTranscriptions),await this.saveSettings();let e=ce(this.settings.pendingTranscriptions);if(e.pending!==0){this.isProcessingQueue=!0;try{for(new a.Notice(`Retrying ${e.pending} saved recording${e.pending>1?"s":""}...`);;){let t=oe(this.settings.pendingTranscriptions);if(!t)break;if(!navigator.onLine){new a.Notice("Still offline. Will retry when connected.");break}try{let n=this.getVaultPath(),r=this.getMachineId(),c;try{let l=await _(t.audioData,n,r);c=te(l)}catch(l){console.error("Failed to decrypt queued audio:",l),this.settings.pendingTranscriptions=L(this.settings.pendingTranscriptions,t.id),await this.saveSettings();continue}let o=await this.api.transcribeAudio(c,t.filename);if(o.status==="failed")throw new Error(o.error||"Transcription failed");let d=this.settings.autoEnhance&&o.enhanced_text?o.enhanced_text:o.text;d&&(this.insertText(d),new a.Notice(`Saved recording processed: ${o.word_count||0} words added`)),this.settings.pendingTranscriptions=L(this.settings.pendingTranscriptions,t.id),await this.saveSettings()}catch(n){if(this.isNetworkError(n)){new a.Notice("Connection lost. Will retry later.");break}let r=ie(t);r.retryCount>=3?(this.settings.pendingTranscriptions=L(this.settings.pendingTranscriptions,t.id),new a.Notice("Recording failed after 3 attempts. Removed.")):this.settings.pendingTranscriptions=this.settings.pendingTranscriptions.map(c=>c.id===t.id?r:c),await this.saveSettings()}}this.updateStatusBar()}finally{this.isProcessingQueue=!1}}}async clearOfflineQueue(){this.settings.pendingTranscriptions=[],await this.saveSettings(),this.updateStatusBar(),new a.Notice("Saved recordings deleted")}isNetworkError(e){let t=x(e).toLowerCase();return!navigator.onLine||t.includes("network")||t.includes("fetch")||t.includes("connection")||t.includes("timeout")||t.includes("econnrefused")||t.includes("enotfound")||t.includes("net::err")}getUserFriendlyError(e){let t=x(e);return this.isNetworkError(e)?"No internet. Check connection and try again.":t.includes("Session expired")||t.includes("401")?"Session expired. Reconnect in settings.":t.includes("refresh token")||t.includes("No refresh")?"Sign-in expired. Reconnect your account.":t.includes("NotAllowedError")||t.includes("Permission denied")?"Microphone blocked. Allow access in system settings.":t.includes("NotFoundError")||t.includes("No microphone")?"No microphone found. Connect one and try again.":t.includes("NotReadableError")?"Microphone busy. Close other apps using it.":t.includes("too short")?"Too short. Speak for at least 1 second.":t.includes("Already recording")?"Already recording. Stop first.":t.includes("subscription")||t.includes("premium")?"Subscription required. Visit aiche.app/pricing":t.includes("Transcription failed")?"Failed. Check connection and try again.":t.includes("500")||t.includes("Internal")?"Server error. Try again in a moment.":t.includes("503")||t.includes("Service Unavailable")?"Service busy. Try again shortly.":t.length>100?"Something went wrong. Try again.":t}},j=class extends a.Modal{constructor(e,t,n){super(e);this.consentCheckbox=null;this.plugin=t,this.onConsent=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("aiche-modal");let t=e.createEl("h2",{text:"Privacy & Data Consent"});t.style.marginBottom="16px";let n=e.createEl("p",{text:"Before you record, please review how your data is handled:"});n.style.marginBottom="16px",n.style.fontWeight="500";let r=e.createEl("div",{cls:"aiche-consent-info"});r.style.backgroundColor="var(--background-secondary)",r.style.padding="14px",r.style.borderRadius="4px",r.style.marginBottom="16px",r.style.lineHeight="1.6";let c=[{icon:"upload-cloud",text:"Audio sent to AICHE servers for AI processing"},{icon:"trash-2",text:"Audio deleted immediately after transcription"},{icon:"lock",text:"Offline recordings saved locally (encrypted AES-GCM)"},{icon:"database",text:"Transcribed text stored with your account for history"}];c.forEach((g,b)=>{let w=r.createEl("div");w.style.display="flex",w.style.alignItems="center",w.style.gap="10px",w.style.marginBottom=b<c.length-1?"8px":"0",w.style.fontSize="14px";let T=w.createSpan();T.style.width="18px",T.style.height="18px",T.style.flexShrink="0",(0,a.setIcon)(T,g.icon),w.createSpan({text:g.text})});let o=e.createEl("div");o.style.marginBottom="16px",o.style.fontSize="13px";let d=o.createEl("span",{text:"Full details: "});d.style.color="var(--text-muted)";let l=o.createEl("a",{text:"Privacy Policy"});l.href="#",l.style.color="var(--interactive-accent)",l.addEventListener("click",g=>{g.preventDefault(),E("https://aiche.app/privacy")});let u=e.createEl("div",{cls:"aiche-consent-checkbox"});u.style.display="flex",u.style.alignItems="center",u.style.gap="12px",u.style.marginBottom="16px",u.style.padding="12px",u.style.backgroundColor="var(--background-secondary)",u.style.borderRadius="4px";let h=u.createEl("input",{type:"checkbox"});h.style.cursor="pointer",h.style.width="18px",h.style.height="18px",h.style.minWidth="18px",h.style.margin="0",h.id="aiche-consent-checkbox",this.consentCheckbox=h;let p=u.createEl("label",{text:"I understand and consent to the data practices described above"});p.style.fontSize="14px",p.style.cursor="pointer",p.style.userSelect="none",p.style.lineHeight="1.4",p.setAttribute("for","aiche-consent-checkbox");let y=e.createEl("div",{cls:"aiche-modal-buttons"});y.style.display="flex",y.style.gap="8px";let v=y.createEl("button",{text:"Not now"});v.style.flex="1",v.style.padding="8px",v.style.backgroundColor="transparent",v.style.border="1px solid var(--divider-color)",v.style.borderRadius="4px",v.style.cursor="pointer",v.addEventListener("click",()=>this.close());let f=y.createEl("button",{text:"I Consent & Record"});f.style.flex="1",f.style.padding="8px",f.style.backgroundColor="var(--interactive-accent)",f.style.color="white",f.style.border="none",f.style.borderRadius="4px",f.style.cursor="pointer",f.style.fontWeight="500",f.style.opacity="0.5",f.style.pointerEvents="none",h.addEventListener("change",()=>{h.checked?(f.style.opacity="1",f.style.pointerEvents="auto"):(f.style.opacity="0.5",f.style.pointerEvents="none")}),f.addEventListener("click",async()=>{h.checked&&(this.plugin.settings.hasGivenPrivacyConsent=!0,await this.plugin.saveSettings(),this.close(),await this.onConsent())})}},P=class extends a.Modal{constructor(e,t){super(e);this.codeInput=null;this.manualSection=null;this.plugin=t}onOpen(){let{contentEl:e,modalEl:t}=this;e.empty(),e.addClass("aiche-connect-modal"),a.Platform.isMobileApp&&(e.style.setProperty("padding-left","16px","important"),e.style.setProperty("padding-right","16px","important"),e.style.setProperty("margin","0","important"),e.style.setProperty("width","100%","important"),e.style.setProperty("max-width","none","important"),e.style.setProperty("box-sizing","border-box","important"),t&&(t.style.setProperty("padding","0","important"),t.style.setProperty("margin","0 auto","important"))),e.style.setProperty("text-align","center","important"),e.createEl("h2",{text:"Connect Your Account"}).style.setProperty("text-align","center","important"),e.createEl("p",{text:"Sign in to start recording.",cls:"setting-item-description"}).style.setProperty("text-align","center","important");let o=e.createDiv({cls:"aiche-primary-action"}).createEl("button",{text:"Sign In",cls:"mod-cta aiche-signin-btn"});o.style.width="100%",o.style.padding="12px",o.style.fontSize="16px",o.style.marginBottom="16px",o.onclick=()=>{this.plugin.openAuthInBrowser()};let d=e.createDiv();d.style.setProperty("text-align","center","important"),d.style.setProperty("width","100%","important");let l=d.createEl("span",{text:"Opens aiche.app. You'll return here after signing in."});l.style.color="var(--text-muted)",l.style.fontSize="13px";let u=e.createDiv({cls:"aiche-divider"});u.style.borderTop="1px solid var(--background-modifier-border)",u.style.margin="20px 0",u.style.position="relative";let h=u.createEl("span",{text:"or enter code manually"});h.style.position="absolute",h.style.top="-10px",h.style.left="50%",h.style.transform="translateX(-50%)",h.style.background="var(--modal-background)",h.style.padding="0 10px",h.style.color="var(--text-muted)",h.style.fontSize="12px",this.manualSection=e.createDiv({cls:"aiche-manual-section"}),this.manualSection.style.setProperty("text-align","center","important"),this.manualSection.style.setProperty("width","100%","important");let p=this.manualSection.createDiv();p.style.setProperty("text-align","center","important"),p.style.setProperty("width","100%","important");let y=p.createEl("span",{text:"\u25B6 Having trouble? Enter code manually"});y.style.cursor="pointer",y.style.color="var(--text-muted)",y.style.fontSize="13px",y.style.display="inline-block";let v=this.manualSection.createDiv();v.style.display="none",v.style.marginTop="12px",y.onclick=()=>{let k=v.style.display==="none";v.style.display=k?"block":"none",y.textContent=k?"\u25BC Having trouble? Enter code manually":"\u25B6 Having trouble? Enter code manually"},v.createEl("p",{text:`1. Go to aiche.app/connect-obsidian
2. Copy the code and paste below:`,cls:"setting-item-description"}).style.setProperty("text-align","center","important"),new a.Setting(v).setName("Code").addText(k=>{this.codeInput=k.inputEl,k.setPlaceholder("XXXX-XXXX-XXXX"),k.inputEl.style.width="220px",k.inputEl.style.textTransform="uppercase",k.inputEl.addEventListener("keypress",async le=>{le.key==="Enter"&&await this.submitCode()})}).addButton(k=>k.setButtonText("Connect").onClick(async()=>{await this.submitCode()}));let g=e.createDiv({cls:"modal-button-container"});g.style.marginTop="16px",g.style.display="flex",g.style.flexDirection="column",g.style.gap="8px";let b=g.createEl("button",{text:"Create Account"});b.style.width="100%",b.onclick=()=>{E("https://aiche.app/signup")};let w=g.createEl("button",{text:"Cancel"});w.style.width="100%",w.onclick=()=>this.close();let T=e.createDiv();T.style.marginTop="16px",T.style.fontSize="12px",T.style.color="var(--text-muted)",T.style.textAlign="center",T.createEl("span",{text:"By signing in, you agree to our "});let I=T.createEl("a",{text:"Privacy Policy"});I.href="#",I.style.color="var(--interactive-accent)",I.style.textDecoration="none",I.onclick=k=>{k.preventDefault(),E("https://aiche.app/privacy")},T.createEl("span",{text:"."})}async submitCode(){var t,n;let e=(n=(t=this.codeInput)==null?void 0:t.value)==null?void 0:n.trim();if(!e){new a.Notice("Enter a code");return}if(this.plugin.pendingAuth||this.plugin.generateAuthState(),this.plugin.pendingAuth&&Date.now()-this.plugin.pendingAuth.timestamp>300*1e3){new a.Notice("Timed out. Reopen and try again."),this.plugin.clearAuthState(),this.close();return}try{await this.plugin.activateDeviceCode(e),this.plugin.clearAuthState(),this.close()}catch(r){new a.Notice(`Failed: ${x(r)}`)}}onClose(){this.contentEl.empty()}},$=class extends a.Modal{constructor(s){super(s)}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:"Subscription Required"}),s.createEl("p",{text:"You need an active subscription to use voice recording."});let e=s.createDiv({cls:"modal-button-container"}),t=e.createEl("button",{text:"See Plans",cls:"mod-cta"});t.onclick=()=>{E("https://aiche.app/pricing"),this.close()};let n=e.createEl("button",{text:"Later"});n.onclick=()=>this.close()}onClose(){this.contentEl.empty()}},X=class extends a.Modal{constructor(s,e){super(s),this.plugin=e}onOpen(){let{contentEl:s}=this;s.addClass("aiche-welcome-modal"),s.createEl("h2",{text:"Welcome to Voice Recording"}),s.createEl("p",{text:"Speak into your notes. Get polished text in seconds.",cls:"setting-item-description"});let e=s.createDiv({cls:"aiche-welcome-guide"});[{num:"1",text:"Connect your account"},{num:"2",text:"Click the microphone or use a hotkey"},{num:"3",text:"Speak, then click again to finish"}].forEach(l=>{let u=e.createDiv({cls:"aiche-welcome-step"});u.createSpan({text:l.num,cls:"aiche-welcome-step-icon"}),u.createSpan({text:l.text,cls:"aiche-welcome-step-text"})}),s.createEl("p",{text:"Grammar and punctuation are handled automatically.",cls:"setting-item-description"});let n=s.createDiv({cls:"modal-button-container"});n.style.marginTop="20px";let r=n.createEl("button",{text:"Connect Account",cls:"mod-cta"});r.onclick=async()=>{this.plugin.settings.hasShownWelcome=!0,await this.plugin.saveSettings(),this.close(),new P(this.app,this.plugin).open()};let c=n.createEl("button",{text:"Later"});c.onclick=async()=>{this.plugin.settings.hasShownWelcome=!0,await this.plugin.saveSettings(),this.close()};let o=s.createDiv();o.style.marginTop="20px",o.style.fontSize="12px",o.style.color="var(--text-muted)",o.style.textAlign="center",o.createEl("span",{text:"Learn more in our "});let d=o.createEl("a",{text:"Privacy Policy"});d.href="#",d.style.color="var(--interactive-accent)",d.style.textDecoration="none",d.onclick=l=>{l.preventDefault(),E("https://aiche.app/privacy")},o.createEl("span",{text:"."})}onClose(){this.contentEl.empty()}};
