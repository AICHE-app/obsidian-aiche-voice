/*
AICHE Voice - Obsidian Plugin
https://aiche.app
*/

var L=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var le=Object.prototype.hasOwnProperty;var de=(i,s)=>{for(var e in s)L(i,e,{get:s[e],enumerable:!0})},ue=(i,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of ce(s))!le.call(i,n)&&n!==e&&L(i,n,{get:()=>s[n],enumerable:!(t=ae(s,n))||t.enumerable});return i};var he=i=>ue(L({},"__esModule",{value:!0}),i);var we={};de(we,{default:()=>_});module.exports=he(we);var o=require("obsidian");var C=require("obsidian");var $={encryptedAccessToken:void 0,encryptedRefreshToken:void 0,tokenStorageVersion:void 0,machineId:void 0,deviceId:void 0,accessToken:void 0,refreshToken:void 0,tokenExpiresAt:0,userEmail:"",userId:null,isSubscribed:!1,subscriptionPlan:null,autoEnhance:!0,insertAtCursor:!0,showNotifications:!0,hasShownWelcome:!1,spokenNotesFolder:"Voice Notes",attachAudioToVoiceNotes:!0,organizeByCategoryFolders:!1,pendingTranscriptions:[],hasGivenPrivacyConsent:!1},G={work:"Work",life:"Life",ideas:"Ideas",misc:"Misc"};function j(i){if(!i)return"misc";switch(i.toLowerCase()){case"work":return"work";case"life":return"life";case"ideas":return"ideas";case"misc":return"misc";case"personal":return"life";case"idea":return"ideas";case"note":return"misc";default:return"misc"}}function X(i){return i instanceof Error}function pe(i){return typeof i=="object"&&i!==null&&"message"in i&&typeof i.message=="string"}function ge(i){return typeof i=="object"&&i!==null&&"name"in i&&typeof i.name=="string"}function Q(i){return typeof i=="object"&&i!==null&&"status"in i&&typeof i.status=="number"}function q(i){return typeof i=="object"&&i!==null&&"json"in i&&typeof i.json=="object"&&i.json!==null&&"detail"in i.json&&typeof i.json.detail=="string"}function E(i){return X(i)||pe(i)?i.message:typeof i=="string"?i:"Unknown error"}function z(i){if(X(i)||ge(i))return i.name}var x="https://api.aiche.app",B=class{constructor(){this.onTokenRefresh=null;this.refreshPromise=null;this.accessToken="",this.refreshToken=""}setTokens(s,e){this.accessToken=s,this.refreshToken=e}setTokenRefreshCallback(s){this.onTokenRefresh=s}async activateDeviceCode(s,e){let n=(await(0,C.requestUrl)({url:`${x}/api/v1/auth/device/activate`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:s.toUpperCase().trim(),device_info:e})})).json;return this.setTokens(n.access_token,n.refresh_token),n}async verifyDeviceCode(s){try{return(await(0,C.requestUrl)({url:`${x}/api/v1/auth/device/verify/${s.toUpperCase().trim()}`,method:"GET"})).json}catch(e){return{valid:!1,error:E(e)}}}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this.performTokenRefresh();try{return await this.refreshPromise}finally{this.refreshPromise=null}}async performTokenRefresh(){if(!this.refreshToken)throw new Error("No refresh token available");let e=(await(0,C.requestUrl)({url:`${x}/api/v1/auth/refresh`,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`refresh_token=${encodeURIComponent(this.refreshToken)}`})).json,t={access_token:e.access_token,refresh_token:e.refresh_token||this.refreshToken,token_type:e.token_type||"bearer",expires_in:e.expires_in||86400*8};return this.setTokens(t.access_token,t.refresh_token),this.onTokenRefresh&&this.onTokenRefresh(t),t}async request(s){let e=s.headers||{};this.accessToken&&(e.Authorization=`Bearer ${this.accessToken}`);try{return(await(0,C.requestUrl)({...s,headers:e})).json}catch(t){if(Q(t)&&t.status===401&&!s.retried&&this.refreshToken)try{return await this.refreshAccessToken(),e.Authorization=`Bearer ${this.accessToken}`,(await(0,C.requestUrl)({url:s.url,method:s.method,headers:e,body:s.body})).json}catch(r){throw new Error("Session expired. Please reconnect your account.")}let n="Request failed";throw q(t)?n=t.json.detail:n=E(t),new Error(n)}}async getUserProfile(){return this.request({url:`${x}/api/v1/auth/me`,method:"GET"})}async transcribeAudio(s,e){let t="----AicheFormBoundary"+Math.random().toString(36).substring(2),n=JSON.stringify({include_category:!0}),r=`--${t}\r
Content-Disposition: form-data; name="request"\r
Content-Type: application/json\r
\r
${n}\r
`,a=`--${t}\r
Content-Disposition: form-data; name="file"; filename="${e}"\r
Content-Type: audio/webm\r
\r
`,c=`\r
--${t}--\r
`,d=new TextEncoder().encode(r),l=new TextEncoder().encode(a),u=new TextEncoder().encode(c),m=new Uint8Array(s),p=new Uint8Array(d.length+l.length+m.length+u.length);return p.set(d,0),p.set(l,d.length),p.set(m,d.length+l.length),p.set(u,d.length+l.length+m.length),this.request({url:`${x}/api/v1/transcription/audio/direct`,method:"POST",headers:{"Content-Type":`multipart/form-data; boundary=${t}`},body:p.buffer})}async pollTranscriptionStatus(s,e=30){for(let t=0;t<e;t++){let n=await this.request({url:`${x}/api/v1/transcription/${s}`,method:"GET"});if(n.status==="completed"||n.status==="failed")return n;await new Promise(r=>setTimeout(r,Math.min(1e3+t*200,3e3)))}throw new Error("Transcription timed out")}async logout(){if(this.accessToken)try{await this.request({url:`${x}/api/v1/auth/logout`,method:"POST"})}catch(s){}this.accessToken="",this.refreshToken=""}};var V=require("obsidian"),S=null;if(!V.Platform.isMobileApp)try{S=require("child_process").spawn}catch(i){}function w(i){var s;if(V.Platform.isMobileApp){window.open(i,"_blank");return}try{let e=window.electron;if((s=e==null?void 0:e.shell)!=null&&s.openExternal){e.shell.openExternal(i);return}if(S&&process.platform==="linux"){let t={HOME:process.env.HOME||"",PATH:process.env.PATH||"/usr/bin:/bin",USER:process.env.USER||"",DISPLAY:process.env.DISPLAY||":0",XAUTHORITY:process.env.XAUTHORITY||"",DBUS_SESSION_BUS_ADDRESS:process.env.DBUS_SESSION_BUS_ADDRESS||"",XDG_RUNTIME_DIR:process.env.XDG_RUNTIME_DIR||"",XDG_CURRENT_DESKTOP:process.env.XDG_CURRENT_DESKTOP||""};S("xdg-open",[i],{detached:!0,stdio:"ignore",env:t}).unref()}else S&&process.platform==="darwin"?S("open",[i],{detached:!0,stdio:"ignore"}).unref():S&&process.platform==="win32"&&S("cmd",["/c","start","",i],{detached:!0,stdio:"ignore"}).unref()}catch(e){window.open(i,"_blank")}}var R=class{constructor(s){this.mediaRecorder=null;this.audioChunks=[];this.stream=null;this.state="idle";this.durationInterval=null;this.startTime=0;this.events=s}getState(){return this.state}setState(s){this.state=s,this.events.onStateChange(s)}async startRecording(){if(this.state!=="idle")throw new Error("Already recording. Stop first.");try{this.stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:1,sampleRate:48e3}});let s=this.getSupportedMimeType();this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:s,audioBitsPerSecond:83e3}),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.audioChunks.push(e.data)},this.mediaRecorder.onerror=e=>{var n;let t=e;this.events.onError(new Error(((n=t.error)==null?void 0:n.message)||"Recording error")),this.cleanup()},this.mediaRecorder.start(1e3),this.startTime=Date.now(),this.setState("recording"),this.durationInterval=setInterval(()=>{let e=Math.floor((Date.now()-this.startTime)/1e3);this.events.onDurationUpdate(e)},1e3)}catch(s){this.cleanup();let e=z(s);throw e==="NotAllowedError"?new Error("Microphone blocked. Allow access in system settings."):e==="NotFoundError"?new Error("No microphone found. Connect one and try again."):s}}getSupportedMimeType(){let s=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/mp4"];for(let e of s)if(MediaRecorder.isTypeSupported(e))return e;return"audio/webm"}pauseRecording(){this.state!=="recording"||!this.mediaRecorder||(this.mediaRecorder.pause(),this.setState("paused"))}resumeRecording(){this.state!=="paused"||!this.mediaRecorder||(this.mediaRecorder.resume(),this.setState("recording"))}async stopRecording(){if(this.state==="idle"||!this.mediaRecorder)throw new Error("Not recording. Start a recording first.");return this.setState("processing"),new Promise((s,e)=>{if(!this.mediaRecorder){e(new Error("No media recorder"));return}this.mediaRecorder.onstop=async()=>{var t;try{let n=new Blob(this.audioChunks,{type:((t=this.mediaRecorder)==null?void 0:t.mimeType)||"audio/webm"});if(n.size<1e3)throw new Error("Too short. Speak for at least 1 second.");let r=await n.arrayBuffer();s(r)}catch(n){e(n)}finally{this.cleanup()}},this.mediaRecorder.stop()})}cancelRecording(){this.cleanup()}cleanup(){this.durationInterval&&(clearInterval(this.durationInterval),this.durationInterval=null),this.stream&&(this.stream.getTracks().forEach(s=>s.stop()),this.stream=null),this.mediaRecorder=null,this.audioChunks=[],this.setState("idle")}getDuration(){return this.state==="idle"?0:Math.floor((Date.now()-this.startTime)/1e3)}};var f=require("obsidian");var I=class extends f.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;if(s.empty(),s.createEl("h2",{text:"Voice Recording"}),s.createEl("h3",{text:"Account"}),this.plugin.settings.encryptedAccessToken||this.plugin.settings.accessToken){new f.Setting(s).setName("Connected as").setDesc(this.plugin.settings.userEmail||"Connected").addButton(n=>n.setButtonText("Disconnect").setWarning().onClick(async()=>{await this.plugin.logout(),this.display()}));let t=this.plugin.settings.isSubscribed?`Active: ${this.plugin.settings.subscriptionPlan||"Premium"}`:"No active subscription";new f.Setting(s).setName("Subscription").setDesc(t).addButton(n=>n.setButtonText(this.plugin.settings.isSubscribed?"Manage":"Subscribe").onClick(()=>{w("https://aiche.app/account")})),new f.Setting(s).addButton(n=>n.setButtonText("Refresh Status").onClick(async()=>{await this.plugin.refreshUserStatus(),this.display()}))}else new f.Setting(s).setName("Connect your account").setDesc("Sign in to start recording.").addButton(t=>t.setButtonText("Sign In").setCta().onClick(()=>{this.plugin.openConnectModal()})),new f.Setting(s).setDesc("No account yet?").addButton(t=>t.setButtonText("Create Account").onClick(()=>{w("https://aiche.app/signup")}));s.createEl("h3",{text:"Recording"}),new f.Setting(s).setName("Polish text").setDesc("Fix grammar and punctuation automatically.").addToggle(t=>t.setValue(this.plugin.settings.autoEnhance).onChange(async n=>{this.plugin.settings.autoEnhance=n,await this.plugin.saveSettings()})),new f.Setting(s).setName("Insert at cursor").setDesc("Add text where your cursor is. Otherwise, adds to end of note.").addToggle(t=>t.setValue(this.plugin.settings.insertAtCursor).onChange(async n=>{this.plugin.settings.insertAtCursor=n,await this.plugin.saveSettings()})),new f.Setting(s).setName("Show notifications").setDesc("Show a message when recording completes.").addToggle(t=>t.setValue(this.plugin.settings.showNotifications).onChange(async n=>{this.plugin.settings.showNotifications=n,await this.plugin.saveSettings()})),new f.Setting(s).setName("Voice notes folder").setDesc("Where to save new notes when no note is open.").addText(t=>t.setPlaceholder("Voice Notes").setValue(this.plugin.settings.spokenNotesFolder).onChange(async n=>{this.plugin.settings.spokenNotesFolder=n||"Voice Notes",await this.plugin.saveSettings()})),new f.Setting(s).setName("Attach audio").setDesc("Save audio file with notes in the voice notes folder.").addToggle(t=>t.setValue(this.plugin.settings.attachAudioToVoiceNotes).onChange(async n=>{this.plugin.settings.attachAudioToVoiceNotes=n,await this.plugin.saveSettings()})),new f.Setting(s).setName("Organize by category").setDesc("Sort notes into subfolders (Work, Life, Ideas, Misc) based on content.").addToggle(t=>t.setValue(this.plugin.settings.organizeByCategoryFolders).onChange(async n=>{this.plugin.settings.organizeByCategoryFolders=n,await this.plugin.saveSettings()})),f.Platform.isMobileApp||(s.createEl("h3",{text:"Hotkeys"}),new f.Setting(s).setName("Toggle Recording").setDesc("Start or stop recording"),new f.Setting(s).setName("Cancel Recording").setDesc("Discard without saving"),new f.Setting(s).setName("New Voice Note").setDesc("Create a new note and start recording"),new f.Setting(s).setDesc('Set hotkeys in Settings \u2192 Hotkeys, search "Voice"').addButton(t=>t.setButtonText("Open Hotkeys").onClick(()=>{this.app.setting.open(),this.app.setting.openTabById("hotkeys")}))),s.createEl("h3",{text:"About"}),new f.Setting(s).setName("Version").setDesc(this.plugin.manifest.version).addButton(t=>t.setButtonText("Website").onClick(()=>{w("https://aiche.app")})).addButton(t=>t.setButtonText("Help").onClick(()=>{w("https://aiche.app/help")})).addButton(t=>t.setButtonText("Privacy").onClick(()=>{w("https://aiche.app/privacy")}))}};async function K(i,s){let e=new TextEncoder,t=await crypto.subtle.importKey("raw",e.encode(i),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:s.buffer,iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function U(i){let s=new Uint8Array(i),e="";for(let t=0;t<s.byteLength;t++)e+=String.fromCharCode(s[t]);return btoa(e)}function F(i){let s=atob(i),e=new Uint8Array(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e}async function P(i,s,e){if(!i)throw new Error("Cannot encrypt empty token");let t=crypto.getRandomValues(new Uint8Array(16)),n=crypto.getRandomValues(new Uint8Array(12)),r=`${s}:${e}:aiche-voice`,a=await K(r,t),c=new TextEncoder,d=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},a,c.encode(i));return{ciphertext:U(d),iv:U(n.buffer),salt:U(t.buffer)}}async function D(i,s,e){if(!i||!i.ciphertext||!i.iv||!i.salt)throw new Error("Invalid encrypted data");let t=F(i.ciphertext),n=F(i.iv),r=F(i.salt),a=`${s}:${e}:aiche-voice`,c=await K(a,r),d=await crypto.subtle.decrypt({name:"AES-GCM",iv:n.buffer},c,t.buffer);return new TextDecoder().decode(d)}function k(){return!!(typeof crypto!="undefined"&&crypto.subtle&&typeof crypto.subtle.encrypt=="function"&&typeof crypto.subtle.decrypt=="function"&&typeof crypto.getRandomValues=="function")}var fe=50,Y=3,me=1440*60*1e3;function ye(i){let s=new Uint8Array(i),e="";for(let t=0;t<s.byteLength;t++)e+=String.fromCharCode(s[t]);return btoa(e)}function J(i){let s=atob(i),e=new Uint8Array(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e.buffer}function ve(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function H(i){return Date.now()-i.timestamp>me}function Z(i){return i.retryCount<Y&&!H(i)}async function ee(i,s,e,t){if(!k())throw new Error("Web Crypto API unavailable - cannot securely save offline recordings");let n=ye(i),r=await P(n,e,t);return{id:ve(),audioData:r,filename:s,timestamp:Date.now(),retryCount:0}}function te(i){return{...i,retryCount:i.retryCount+1}}function ne(i,s){let e=i.filter(t=>!H(t));return e.length>=fe&&e.shift(),[...e,s]}function N(i,s){return i.filter(e=>e.id!==s)}function se(i){for(let s of i)if(Z(s))return s;return null}function ie(i){return i.filter(s=>Z(s))}function re(i){let s=0,e=0,t=0;for(let n of i)H(n)?e++:n.retryCount>=Y?t++:s++;return{total:i.length,pending:s,expired:e,maxRetries:t}}var _=class extends o.Plugin{constructor(){super(...arguments);this.settings=$;this.api=new B;this.recorder=null;this.statusBarEl=null;this.ribbonIconEl=null;this.pendingAuth=null;this.statusBarClickHandler=null;this.statusBarContextHandler=null;this.statusBarTouchStart=null;this.statusBarTouchEnd=null;this.statusBarTouchMove=null;this.longPressTimer=null;this.animationTimeouts=[];this.beforeUnloadHandler=null;this.ariaLiveRegion=null;this.onlineHandler=null;this.isProcessingQueue=!1}async onload(){await this.loadSettings();let e=await this.getAccessToken(),t=await this.getRefreshToken();e&&this.api.setTokens(e,t||""),this.api.setTokenRefreshCallback(async n=>{await this.setAccessToken(n.access_token),await this.setRefreshToken(n.refresh_token),this.settings.tokenExpiresAt=Date.now()+n.expires_in*1e3,await this.saveSettings()}),this.registerObsidianProtocolHandler("aiche-auth",async n=>{await this.handleAuthCallback(n)}),this.recorder=new R({onStateChange:n=>this.updateRecordingUI(n),onError:n=>new o.Notice(this.getUserFriendlyError(n)),onDurationUpdate:n=>this.updateDurationDisplay(n)}),this.ribbonIconEl=this.addRibbonIcon("mic","Voice recording",async()=>{await this.toggleRecording()}),this.ribbonIconEl.setAttribute("aria-label","Toggle voice recording"),this.statusBarEl=this.addStatusBarItem(),this.statusBarEl.addClass("aiche-status-bar"),this.statusBarEl.setAttribute("role","button"),this.statusBarEl.setAttribute("tabindex","0"),this.statusBarEl.setAttribute("aria-label","Toggle voice recording"),this.statusBarClickHandler=n=>{n.button===0&&(n.preventDefault(),n.stopPropagation(),this.toggleRecording())},this.statusBarContextHandler=n=>{n.preventDefault(),n.stopPropagation(),this.showStatusBarMenu(n)},this.statusBarEl.addEventListener("click",this.statusBarClickHandler),this.statusBarEl.addEventListener("contextmenu",this.statusBarContextHandler),o.Platform.isMobileApp&&(this.statusBarTouchStart=n=>{this.longPressTimer=setTimeout(()=>{this.vibrate(50);let r=n.touches[0],a=new MouseEvent("contextmenu",{clientX:r.clientX,clientY:r.clientY});this.showStatusBarMenu(a)},500)},this.statusBarTouchEnd=()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},this.statusBarTouchMove=()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},this.statusBarEl.addEventListener("touchstart",this.statusBarTouchStart),this.statusBarEl.addEventListener("touchend",this.statusBarTouchEnd),this.statusBarEl.addEventListener("touchmove",this.statusBarTouchMove)),this.statusBarEl.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),this.toggleRecording())}),this.updateStatusBar(),this.createAriaLiveRegion(),this.onlineHandler=()=>{navigator.onLine&&this.settings.pendingTranscriptions.length>0&&this.processOfflineQueue()},window.addEventListener("online",this.onlineHandler),navigator.onLine&&this.settings.pendingTranscriptions.length>0&&setTimeout(()=>this.processOfflineQueue(),3e3),this.addCommand({id:"toggle-recording",name:"Toggle Recording",icon:"mic",editorCallback:async()=>{await this.toggleRecording()}}),this.addCommand({id:"cancel-recording",name:"Cancel Recording",icon:"x",editorCallback:()=>{this.recorder&&this.recorder.getState()!=="idle"&&(this.recorder.cancelRecording(),new o.Notice("Recording canceled"))}}),this.addCommand({id:"new-voice-note",name:"New Voice Note",icon:"file-plus",editorCallback:async()=>{await this.newVoiceNote()}}),this.addSettingTab(new I(this.app,this)),this.beforeUnloadHandler=n=>{if(this.recorder&&this.recorder.getState()!=="idle")return n.preventDefault(),n.returnValue="Active recording will be lost. Close anyway?",n.returnValue},window.addEventListener("beforeunload",this.beforeUnloadHandler),e&&this.refreshUserStatus().catch(()=>{}),this.settings.hasShownWelcome||this.app.workspace.onLayoutReady(()=>{new W(this.app,this).open()})}onunload(){this.recorder&&this.recorder.getState()!=="idle"&&this.recorder.cancelRecording(),this.statusBarEl&&(this.statusBarClickHandler&&this.statusBarEl.removeEventListener("click",this.statusBarClickHandler),this.statusBarContextHandler&&this.statusBarEl.removeEventListener("contextmenu",this.statusBarContextHandler),this.statusBarTouchStart&&this.statusBarEl.removeEventListener("touchstart",this.statusBarTouchStart),this.statusBarTouchEnd&&this.statusBarEl.removeEventListener("touchend",this.statusBarTouchEnd),this.statusBarTouchMove&&this.statusBarEl.removeEventListener("touchmove",this.statusBarTouchMove)),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.animationTimeouts.forEach(e=>clearTimeout(e)),this.animationTimeouts=[],this.beforeUnloadHandler&&(window.removeEventListener("beforeunload",this.beforeUnloadHandler),this.beforeUnloadHandler=null),this.ariaLiveRegion&&(this.ariaLiveRegion.remove(),this.ariaLiveRegion=null),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.statusBarClickHandler=null,this.statusBarContextHandler=null,this.statusBarTouchStart=null,this.statusBarTouchEnd=null,this.statusBarTouchMove=null}async loadSettings(){this.settings=Object.assign({},$,await this.loadData()),await this.migrateToEncryptedTokens()}async saveSettings(){await this.saveData(this.settings)}getVaultPath(){return o.Platform.isMobileApp?this.app.vault.getName():this.app.vault.adapter.basePath||this.app.vault.getName()}getMachineId(){return this.settings.machineId||(this.settings.machineId=crypto.randomUUID()),this.settings.machineId}getDeviceId(){return this.settings.deviceId||(this.settings.deviceId=crypto.randomUUID()),this.settings.deviceId}async setAccessToken(e){if(!e){this.settings.encryptedAccessToken=void 0,this.settings.accessToken=void 0;return}if(!k())throw new Error("Web Crypto API unavailable. Cannot securely store authentication tokens.");let t=this.getVaultPath(),n=this.getMachineId();this.settings.encryptedAccessToken=await P(e,t,n),this.settings.accessToken=void 0,this.settings.tokenStorageVersion=2}async getAccessToken(){if(this.settings.tokenStorageVersion===2&&this.settings.encryptedAccessToken){if(!k()){console.error("AICHE: Web Crypto API unavailable, cannot decrypt token");return}try{let e=this.getVaultPath(),t=this.getMachineId();return await D(this.settings.encryptedAccessToken,e,t)}catch(e){console.error("AICHE: Failed to decrypt access token:",e);return}}return this.settings.accessToken||void 0}async setRefreshToken(e){if(!e){this.settings.encryptedRefreshToken=void 0,this.settings.refreshToken=void 0;return}if(!k())throw new Error("Web Crypto API unavailable. Cannot securely store authentication tokens.");let t=this.getVaultPath(),n=this.getMachineId();this.settings.encryptedRefreshToken=await P(e,t,n),this.settings.refreshToken=void 0}async getRefreshToken(){if(this.settings.tokenStorageVersion===2&&this.settings.encryptedRefreshToken){if(!k()){console.error("AICHE: Web Crypto API unavailable, cannot decrypt token");return}try{let e=this.getVaultPath(),t=this.getMachineId();return await D(this.settings.encryptedRefreshToken,e,t)}catch(e){console.error("AICHE: Failed to decrypt refresh token:",e);return}}return this.settings.refreshToken||void 0}async migrateToEncryptedTokens(){if(this.settings.tokenStorageVersion!==2&&!(!this.settings.accessToken&&!this.settings.refreshToken)){if(!k()){console.warn("AICHE: Cannot migrate tokens - Web Crypto API unavailable");return}try{this.settings.accessToken&&await this.setAccessToken(this.settings.accessToken),this.settings.refreshToken&&await this.setRefreshToken(this.settings.refreshToken),await this.saveSettings(),new o.Notice("Security upgrade complete")}catch(e){console.error("AICHE: Token migration failed:",e)}}}getDeviceInfo(){let e=this.getDeviceId();return{name:`Obsidian (${o.Platform.isDesktop?"Desktop":"Mobile"})`,device_fingerprint:e,device_id:e,os:o.Platform.isDesktop?o.Platform.isMacOS?"macOS":o.Platform.isWin?"Windows":"Linux":o.Platform.isIosApp?"iOS":"Android",app_version:this.manifest.version}}generateAuthState(){let e=new Uint8Array(16);crypto.getRandomValues(e);let t=Array.from(e,n=>n.toString(16).padStart(2,"0")).join("");return this.pendingAuth={state:t,timestamp:Date.now()},t}validateAuthState(e){return!(!this.pendingAuth||this.pendingAuth.state!==e||Date.now()-this.pendingAuth.timestamp>300*1e3)}clearAuthState(){this.pendingAuth=null}async handleAuthCallback(e){let{code:t,state:n,error:r}=e;if(r){new o.Notice(`Sign-in failed: ${r}`);return}if(!t){new o.Notice("Sign-in failed: No device code received");return}if(n&&!this.validateAuthState(n)){new o.Notice("Session expired. Please try again."),this.clearAuthState();return}try{await this.activateDeviceCode(t),this.clearAuthState()}catch(a){new o.Notice(this.getUserFriendlyError(a))}}openAuthInBrowser(){let e=this.generateAuthState(),t=this.getDeviceInfo(),n=encodeURIComponent(JSON.stringify({name:t.name,os:t.os,app_version:t.app_version,fingerprint:t.device_fingerprint})),r=`https://aiche.app/connect-device?redirect=obsidian://aiche-auth&state=${e}&device=${n}&client=obsidian`;w(r)}async activateDeviceCode(e){try{let t=this.getDeviceInfo(),n=await this.api.activateDeviceCode(e,t);await this.setAccessToken(n.access_token),await this.setRefreshToken(n.refresh_token),this.settings.tokenExpiresAt=Date.now()+n.expires_in*1e3,this.settings.userEmail=n.user.email,this.settings.userId=n.user.id,this.api.setTokens(n.access_token,n.refresh_token),await this.refreshUserStatus(),await this.saveSettings(),new o.Notice("Account connected"),this.updateStatusBar()}catch(t){throw new Error(E(t)||"Failed to activate device code")}}async refreshUserStatus(){let e=await this.api.getUserProfile();this.settings.userEmail=e.email,this.settings.userId=e.id;let t=e.is_premium||!1;this.settings.isSubscribed=t,this.settings.subscriptionPlan=e.plan_name||null,await this.saveSettings(),this.updateStatusBar()}openConnectModal(){new A(this.app,this).open()}async logout(){await this.api.logout(),this.settings.encryptedAccessToken=void 0,this.settings.encryptedRefreshToken=void 0,this.settings.accessToken=void 0,this.settings.refreshToken=void 0,this.settings.tokenExpiresAt=0,this.settings.userEmail="",this.settings.userId=null,this.settings.isSubscribed=!1,this.settings.subscriptionPlan=null,await this.saveSettings(),this.updateStatusBar(),new o.Notice("Account disconnected")}generateNoteTitle(){let e=new Date,n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()],r=e.getDate(),a=e.getHours(),c=e.getMinutes().toString().padStart(2,"0"),d=a>=12?"pm":"am";return a=a%12||12,`${n} ${r}, ${a}.${c}${d}`}async createVoiceNote(){let e=this.settings.spokenNotesFolder||"Voice Notes",t=this.generateNoteTitle(),n=`${e}/${t}.md`;try{this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e);let a=1;for(;this.app.vault.getAbstractFileByPath(n);)n=`${e}/${t} (${a}).md`,a++;let c=await this.app.vault.create(n,"");return await this.app.workspace.getLeaf(!1).openFile(c),c}catch(r){return new o.Notice(`Could not create note: ${E(r)}`),null}}async moveNoteToCategory(e,t){var c;let n=this.settings.spokenNotesFolder||"Voice Notes",r=G[t],a=`${n}/${r}`;if(((c=e.parent)==null?void 0:c.path)!==a)try{this.app.vault.getAbstractFileByPath(a)||await this.app.vault.createFolder(a);let l=`${a}/${e.name}`,u=1;for(;this.app.vault.getAbstractFileByPath(l);){let m=e.basename,p=e.extension;l=`${a}/${m} ${u}.${p}`,u++}await this.app.fileManager.renameFile(e,l)}catch(d){console.error("Failed to move note to category folder:",d)}}async newVoiceNote(){if(!(this.settings.encryptedAccessToken||this.settings.accessToken)){new o.Notice("Connect your account to start recording"),new A(this.app,this).open();return}if(!this.settings.isSubscribed){new o.Notice("Subscription required"),new M(this.app).open();return}if(await this.createVoiceNote()){await new Promise(n=>setTimeout(n,100));try{await this.recorder.startRecording(),this.announceToScreenReader("Recording started. Speak now.")}catch(n){new o.Notice(this.getUserFriendlyError(n))}}}async toggleRecording(){if(!this.recorder)return;let e=this.recorder.getState();e==="idle"?await this.startRecording():(e==="recording"||e==="paused")&&await this.stopAndTranscribe()}async startRecording(){if(!(this.settings.encryptedAccessToken||this.settings.accessToken)){new o.Notice("Connect your account to start recording"),new A(this.app,this).open();return}if(!this.settings.isSubscribed){new o.Notice("Subscription required"),new M(this.app).open();return}if(!this.settings.hasGivenPrivacyConsent){new O(this.app,this,async()=>{await this.proceedWithRecording()}).open();return}await this.proceedWithRecording()}async proceedWithRecording(){let e=this.app.workspace.getActiveViewOfType(o.MarkdownView);if(!e){if(!await this.createVoiceNote())return;await new Promise(n=>setTimeout(n,100)),e=this.app.workspace.getActiveViewOfType(o.MarkdownView)}try{await this.recorder.startRecording(),this.vibrate(50),this.announceToScreenReader("Recording started. Speak now.")}catch(t){new o.Notice(this.getUserFriendlyError(t))}}async stopAndTranscribe(){var n;if(!this.recorder)return;let e=null,t="";try{e=await this.recorder.stopRecording(),t=`recording-${Date.now()}.webm`,this.setProcessingState(!0);let r=await this.api.transcribeAudio(e,t);if(r.status==="failed")throw new Error(r.error||"Transcription failed");let a=this.settings.autoEnhance&&r.enhanced_text?r.enhanced_text:r.text;if(!a){new o.Notice("No speech detected. Try again."),this.showErrorAnimation();return}let c=this.app.workspace.getActiveFile(),d=this.settings.spokenNotesFolder||"Voice Notes",l=((n=c==null?void 0:c.parent)==null?void 0:n.path)||"",u=l===d||l.startsWith(d+"/");if(u&&this.settings.attachAudioToVoiceNotes&&c&&e?await this.insertTextWithAudio(a,e,c):this.insertText(a),u&&this.settings.organizeByCategoryFolders&&c){let p=j(r.category);await this.moveNoteToCategory(c,p)}this.showSuccessAnimation(),this.vibrate([50,30,50]),this.settings.showNotifications&&new o.Notice(`${r.word_count||0} words added`),this.announceToScreenReader(`Done. ${r.word_count||0} words added.`)}catch(r){this.isNetworkError(r)&&e?(await this.saveToOfflineQueue(e,t),new o.Notice("Offline. Recording saved and will retry when connected."),this.announceToScreenReader("Offline. Recording saved for later.")):(new o.Notice(this.getUserFriendlyError(r)),this.announceToScreenReader("Failed. Try again.")),this.showErrorAnimation(),this.vibrate([100,50,100])}}insertText(e){let t=this.app.workspace.getActiveViewOfType(o.MarkdownView);if(!t){new o.Notice("No note open. Text copied to clipboard."),navigator.clipboard.writeText(e);return}let n=t.editor;if(this.settings.insertAtCursor){let r=n.getCursor();n.replaceRange(e,r);let a=e.split(`
`),c=a[a.length-1].length;n.setCursor({line:r.line+a.length-1,ch:a.length===1?r.ch+c:c})}else{let r=n.getValue(),a=r+(r.endsWith(`
`)?"":`
`)+e+`
`;n.setValue(a),n.setCursor(n.lastLine())}}async insertTextWithAudio(e,t,n){var a;let r=this.app.workspace.getActiveViewOfType(o.MarkdownView);if(!r){new o.Notice("No note open. Text copied to clipboard."),navigator.clipboard.writeText(e);return}try{let c=this.getAttachmentFolder(n),l=`Recording ${n.basename}.webm`,u=c?`${c}/${l}`:l,m=2;for(;this.app.vault.getAbstractFileByPath(u);)l=`Recording ${n.basename} ${m}.webm`,u=c?`${c}/${l}`:l,m++;c&&(this.app.vault.getAbstractFileByPath(c)||await this.app.vault.createFolder(c)),await this.app.vault.createBinary(u,t);let p=`![[${l}]]`,g=r.editor,v=g.getValue();if(v.trim()===""){let y=`${e}

${p}
`;g.setValue(y);let T=e.split(`
`);g.setCursor({line:T.length-1,ch:T[T.length-1].length})}else if(this.settings.insertAtCursor){let y=`${e}

${p}
`,T=g.getCursor();g.replaceRange(y,T);let b=e.split(`
`);g.setCursor({line:T.line+b.length-1,ch:b[b.length-1].length})}else{let y=`${e}

${p}
`,T=v+(v.endsWith(`
`)?"":`
`)+y;g.setValue(T);let b=e.split(`
`),oe=v.split(`
`).length;g.setCursor({line:oe+b.length-1,ch:b[b.length-1].length})}let h=(a=this.app.workspace.getActiveViewOfType(o.MarkdownView))==null?void 0:a.leaf;if(h){let y=h.getViewState();await h.setViewState({...y,state:{...y.state,mode:"preview"}}),await h.setViewState({...y,state:{...y.state,mode:"source"}})}}catch(c){console.error("Failed to save audio:",c),this.insertText(e)}}getAttachmentFolder(e){var r;let t=this.app.vault.config,n=(t==null?void 0:t.attachmentFolderPath)||"";if(!n||n==="/")return"";if(n.startsWith("./")){let a=((r=e.parent)==null?void 0:r.path)||"",c=n.slice(2);return a?c?`${a}/${c}`:a:c}else return n}updateRecordingUI(e){if(this.ribbonIconEl){switch(this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),document.body.removeClass("aiche-is-recording","aiche-is-processing"),e){case"recording":this.ribbonIconEl.addClass("aiche-recording"),document.body.addClass("aiche-is-recording"),(0,o.setIcon)(this.ribbonIconEl,"mic");break;case"paused":this.ribbonIconEl.addClass("aiche-paused"),document.body.addClass("aiche-is-recording"),(0,o.setIcon)(this.ribbonIconEl,"pause");break;case"processing":this.ribbonIconEl.addClass("aiche-processing"),document.body.addClass("aiche-is-processing"),(0,o.setIcon)(this.ribbonIconEl,"loader");break;default:(0,o.setIcon)(this.ribbonIconEl,"mic")}this.updateStatusBar()}}updateDurationDisplay(e){if(!this.statusBarEl)return;let t=Math.floor(e/60),n=e%60,r=`${t}:${n.toString().padStart(2,"0")}`;this.statusBarEl.setText(`Recording ${r}`),this.statusBarEl.addClass("aiche-status-recording")}updateStatusBar(){var r,a;if(!this.statusBarEl)return;let e=((r=this.recorder)==null?void 0:r.getState())||"idle";if(this.statusBarEl.removeClass("aiche-status-recording","aiche-status-processing","aiche-status-ready","aiche-status-error"),e==="recording"){this.statusBarEl.addClass("aiche-status-recording");return}if(e==="processing"){this.statusBarEl.addClass("aiche-status-processing"),this.statusBarEl.setText("Processing...");return}let t=this.settings.encryptedAccessToken||this.settings.accessToken,n=((a=this.settings.pendingTranscriptions)==null?void 0:a.length)||0;t?this.settings.isSubscribed?(this.statusBarEl.addClass("aiche-status-ready"),n>0?(this.statusBarEl.setText(`Voice (${n} saved)`),this.statusBarEl.setAttribute("aria-label",`${n} recordings saved for retry`)):(this.statusBarEl.setText("Voice"),this.statusBarEl.setAttribute("aria-label","Toggle voice recording"))):this.statusBarEl.setText("Voice: No subscription"):this.statusBarEl.setText("Voice: Not connected")}showStatusBarMenu(e){var c,d;let t=new o.Menu,n=((c=this.recorder)==null?void 0:c.getState())||"idle";n==="recording"||n==="paused"?(t.addItem(l=>l.setTitle("Stop recording").setIcon("check").onClick(()=>this.stopAndTranscribe())),t.addItem(l=>l.setTitle("Cancel").setIcon("x").onClick(()=>{var u;(u=this.recorder)==null||u.cancelRecording(),new o.Notice("Recording canceled")}))):(t.addItem(l=>l.setTitle("Start recording").setIcon("mic").onClick(()=>this.toggleRecording())),t.addItem(l=>l.setTitle("New voice note").setIcon("file-plus").onClick(()=>this.newVoiceNote()))),t.addSeparator(),this.settings.encryptedAccessToken||this.settings.accessToken?t.addItem(l=>l.setTitle("Refresh status").setIcon("refresh-cw").onClick(async()=>{try{await this.refreshUserStatus(),new o.Notice("Status updated")}catch(u){new o.Notice("Could not refresh. Check connection.")}})):t.addItem(l=>l.setTitle("Connect account").setIcon("log-in").onClick(()=>new A(this.app,this).open()));let a=((d=this.settings.pendingTranscriptions)==null?void 0:d.length)||0;a>0&&(t.addSeparator(),t.addItem(l=>l.setTitle(`Retry saved (${a})`).setIcon("upload").onClick(()=>this.processOfflineQueue())),t.addItem(l=>l.setTitle("Delete saved").setIcon("trash").onClick(()=>this.clearOfflineQueue()))),t.addItem(l=>l.setTitle("Settings").setIcon("settings").onClick(()=>{this.app.setting.open(),this.app.setting.openTabById("aiche-voice")})),t.showAtMouseEvent(e)}setProcessingState(e){!this.ribbonIconEl||!this.statusBarEl||(e?(this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-success","aiche-error"),this.ribbonIconEl.addClass("aiche-processing"),(0,o.setIcon)(this.ribbonIconEl,"loader"),this.statusBarEl.removeClass("aiche-status-recording","aiche-status-ready","aiche-status-success","aiche-status-error"),this.statusBarEl.addClass("aiche-status-processing"),this.statusBarEl.setText("Processing...")):(this.ribbonIconEl.removeClass("aiche-processing"),this.statusBarEl.removeClass("aiche-status-processing")))}showSuccessAnimation(){if(!this.ribbonIconEl)return;this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),this.ribbonIconEl.addClass("aiche-success"),(0,o.setIcon)(this.ribbonIconEl,"check"),this.statusBarEl&&(this.statusBarEl.removeClass("aiche-status-processing"),this.statusBarEl.setText("Done"),this.statusBarEl.addClass("aiche-status-success"));let e=setTimeout(()=>{let t=this.animationTimeouts.indexOf(e);t>-1&&this.animationTimeouts.splice(t,1),this.ribbonIconEl&&(this.ribbonIconEl.removeClass("aiche-success"),(0,o.setIcon)(this.ribbonIconEl,"mic")),this.statusBarEl&&this.statusBarEl.removeClass("aiche-status-success"),this.updateStatusBar()},1500);this.animationTimeouts.push(e)}showErrorAnimation(){if(!this.ribbonIconEl)return;this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),this.ribbonIconEl.addClass("aiche-error"),(0,o.setIcon)(this.ribbonIconEl,"mic"),this.statusBarEl&&(this.statusBarEl.removeClass("aiche-status-processing"),this.statusBarEl.addClass("aiche-status-error"));let e=setTimeout(()=>{let t=this.animationTimeouts.indexOf(e);t>-1&&this.animationTimeouts.splice(t,1),this.ribbonIconEl&&this.ribbonIconEl.removeClass("aiche-error"),this.statusBarEl&&this.statusBarEl.removeClass("aiche-status-error"),this.updateStatusBar()},500);this.animationTimeouts.push(e)}createAriaLiveRegion(){this.ariaLiveRegion=document.body.createDiv({cls:"aiche-sr-only"}),this.ariaLiveRegion.setAttribute("role","status"),this.ariaLiveRegion.setAttribute("aria-live","polite"),this.ariaLiveRegion.setAttribute("aria-atomic","true")}announceToScreenReader(e){this.ariaLiveRegion&&(this.ariaLiveRegion.setText(""),setTimeout(()=>{this.ariaLiveRegion&&this.ariaLiveRegion.setText(e)},100))}vibrate(e=50){o.Platform.isMobileApp&&navigator.vibrate&&navigator.vibrate(e)}async saveToOfflineQueue(e,t){let n=this.getVaultPath(),r=this.getMachineId(),a=await ee(e,t,n,r);this.settings.pendingTranscriptions=ne(this.settings.pendingTranscriptions,a),await this.saveSettings(),this.updateStatusBar()}async processOfflineQueue(){if(this.isProcessingQueue||!navigator.onLine)return;this.settings.pendingTranscriptions=ie(this.settings.pendingTranscriptions),await this.saveSettings();let e=re(this.settings.pendingTranscriptions);if(e.pending!==0){this.isProcessingQueue=!0;try{for(new o.Notice(`Retrying ${e.pending} saved recording${e.pending>1?"s":""}...`);;){let t=se(this.settings.pendingTranscriptions);if(!t)break;if(!navigator.onLine){new o.Notice("Still offline. Will retry when connected.");break}try{let n=this.getVaultPath(),r=this.getMachineId(),a;try{let l=await D(t.audioData,n,r);a=J(l)}catch(l){console.error("Failed to decrypt queued audio:",l),this.settings.pendingTranscriptions=N(this.settings.pendingTranscriptions,t.id),await this.saveSettings();continue}let c=await this.api.transcribeAudio(a,t.filename);if(c.status==="failed")throw new Error(c.error||"Transcription failed");let d=this.settings.autoEnhance&&c.enhanced_text?c.enhanced_text:c.text;d&&(this.insertText(d),new o.Notice(`Saved recording processed: ${c.word_count||0} words added`)),this.settings.pendingTranscriptions=N(this.settings.pendingTranscriptions,t.id),await this.saveSettings()}catch(n){if(this.isNetworkError(n)){new o.Notice("Connection lost. Will retry later.");break}let r=te(t);r.retryCount>=3?(this.settings.pendingTranscriptions=N(this.settings.pendingTranscriptions,t.id),new o.Notice("Recording failed after 3 attempts. Removed.")):this.settings.pendingTranscriptions=this.settings.pendingTranscriptions.map(a=>a.id===t.id?r:a),await this.saveSettings()}}this.updateStatusBar()}finally{this.isProcessingQueue=!1}}}async clearOfflineQueue(){this.settings.pendingTranscriptions=[],await this.saveSettings(),this.updateStatusBar(),new o.Notice("Saved recordings deleted")}isNetworkError(e){let t=E(e).toLowerCase();return!navigator.onLine||t.includes("network")||t.includes("fetch")||t.includes("connection")||t.includes("timeout")||t.includes("econnrefused")||t.includes("enotfound")||t.includes("net::err")}getUserFriendlyError(e){let t=E(e);return this.isNetworkError(e)?"No internet. Check connection and try again.":t.includes("Session expired")||t.includes("401")?"Session expired. Reconnect in settings.":t.includes("refresh token")||t.includes("No refresh")?"Sign-in expired. Reconnect your account.":t.includes("NotAllowedError")||t.includes("Permission denied")?"Microphone blocked. Allow access in system settings.":t.includes("NotFoundError")||t.includes("No microphone")?"No microphone found. Connect one and try again.":t.includes("NotReadableError")?"Microphone busy. Close other apps using it.":t.includes("too short")?"Too short. Speak for at least 1 second.":t.includes("Already recording")?"Already recording. Stop first.":t.includes("subscription")||t.includes("premium")?"Subscription required. Visit aiche.app/pricing":t.includes("Transcription failed")?"Failed. Check connection and try again.":t.includes("500")||t.includes("Internal")?"Server error. Try again in a moment.":t.includes("503")||t.includes("Service Unavailable")?"Service busy. Try again shortly.":t.length>100?"Something went wrong. Try again.":t}},O=class extends o.Modal{constructor(e,t,n){super(e);this.consentCheckbox=null;this.plugin=t,this.onConsent=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("aiche-modal");let t=e.createEl("h2",{text:"Privacy & Data Consent"});t.style.marginBottom="16px";let n=e.createEl("p",{text:"Before you record, please review how your data is handled:"});n.style.marginBottom="16px",n.style.fontWeight="500";let r=e.createEl("div",{cls:"aiche-consent-info"});r.style.backgroundColor="var(--background-secondary)",r.style.padding="14px",r.style.borderRadius="4px",r.style.marginBottom="16px",r.style.lineHeight="1.6";let a=[{icon:"\u{1F3A4}",text:"Audio sent to AICHE servers for AI processing"},{icon:"\u2713",text:"Audio deleted immediately after transcription"},{icon:"\u{1F512}",text:"Offline recordings saved locally (encrypted AES-GCM)"},{icon:"\u{1F4CA}",text:"Transcribed text stored with your account for history"}];a.forEach((y,T)=>{let b=r.createEl("div",{text:`${y.icon} ${y.text}`});b.style.marginBottom=T<a.length-1?"8px":"0",b.style.fontSize="14px"});let c=e.createEl("div");c.style.marginBottom="16px",c.style.fontSize="13px";let d=c.createEl("span",{text:"Full details: "});d.style.color="var(--text-muted)";let l=c.createEl("a",{text:"Privacy Policy"});l.href="#",l.style.color="var(--interactive-accent)",l.addEventListener("click",y=>{y.preventDefault(),w("https://aiche.app/privacy")});let u=e.createEl("div",{cls:"aiche-consent-checkbox"});u.style.display="flex",u.style.alignItems="flex-start",u.style.gap="8px",u.style.marginBottom="16px",u.style.padding="12px",u.style.backgroundColor="var(--background-secondary)",u.style.borderRadius="4px";let m=u.createEl("label",{text:"I understand and consent to the data practices described above"});m.style.flex="1",m.style.fontSize="14px",m.style.cursor="pointer",m.style.userSelect="none";let p=m.createEl("input",{type:"checkbox"});p.style.marginRight="8px",p.style.cursor="pointer",p.style.width="18px",p.style.height="18px",this.consentCheckbox=p,m.prepend(p);let g=e.createEl("div",{cls:"aiche-modal-buttons"});g.style.display="flex",g.style.gap="8px";let v=g.createEl("button",{text:"Not now"});v.style.flex="1",v.style.padding="8px",v.style.backgroundColor="transparent",v.style.border="1px solid var(--divider-color)",v.style.borderRadius="4px",v.style.cursor="pointer",v.addEventListener("click",()=>this.close());let h=g.createEl("button",{text:"I Consent & Record"});h.style.flex="1",h.style.padding="8px",h.style.backgroundColor="var(--interactive-accent)",h.style.color="white",h.style.border="none",h.style.borderRadius="4px",h.style.cursor="pointer",h.style.fontWeight="500",h.style.opacity="0.5",h.style.pointerEvents="none",p.addEventListener("change",()=>{p.checked?(h.style.opacity="1",h.style.pointerEvents="auto"):(h.style.opacity="0.5",h.style.pointerEvents="none")}),h.addEventListener("click",async()=>{p.checked&&(this.plugin.settings.hasGivenPrivacyConsent=!0,await this.plugin.saveSettings(),this.close(),await this.onConsent())})}},A=class extends o.Modal{constructor(e,t){super(e);this.codeInput=null;this.manualSection=null;this.plugin=t}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("aiche-connect-modal"),e.createEl("h2",{text:"Connect Your Account"}),e.createEl("p",{text:"Sign in to start recording.",cls:"setting-item-description"});let n=e.createDiv({cls:"aiche-primary-action"}).createEl("button",{text:"Sign In",cls:"mod-cta aiche-signin-btn"});n.style.width="100%",n.style.padding="12px",n.style.fontSize="16px",n.style.marginBottom="16px",n.onclick=()=>{this.plugin.openAuthInBrowser()},e.createEl("p",{text:"Opens aiche.app. You'll return here after signing in.",cls:"setting-item-description"});let r=e.createDiv({cls:"aiche-divider"});r.style.borderTop="1px solid var(--background-modifier-border)",r.style.margin="20px 0",r.style.position="relative";let a=r.createEl("span",{text:"or enter code manually"});a.style.position="absolute",a.style.top="-10px",a.style.left="50%",a.style.transform="translateX(-50%)",a.style.background="var(--modal-background)",a.style.padding="0 10px",a.style.color="var(--text-muted)",a.style.fontSize="12px",this.manualSection=e.createDiv({cls:"aiche-manual-section"});let c=this.manualSection.createEl("details"),d=c.createEl("summary",{text:"Having trouble? Enter code manually"});d.style.cursor="pointer",d.style.color="var(--text-muted)",d.style.marginBottom="12px";let l=c.createDiv();l.createEl("p",{text:`1. Go to aiche.app/account \u2192 "Connect Device"
2. Copy the code and paste below:`,cls:"setting-item-description"}),new o.Setting(l).setName("Code").addText(h=>{this.codeInput=h.inputEl,h.setPlaceholder("XXXX-XXXX-XXXX"),h.inputEl.style.width="220px",h.inputEl.style.textTransform="uppercase",h.inputEl.addEventListener("keypress",async y=>{y.key==="Enter"&&await this.submitCode()})}).addButton(h=>h.setButtonText("Connect").onClick(async()=>{await this.submitCode()}));let u=e.createDiv({cls:"modal-button-container"});u.style.marginTop="16px";let m=u.createEl("button",{text:"Create Account"});m.onclick=()=>{w("https://aiche.app/signup")};let p=u.createEl("button",{text:"Cancel"});p.onclick=()=>this.close();let g=e.createDiv();g.style.marginTop="16px",g.style.fontSize="12px",g.style.color="var(--text-muted)",g.style.textAlign="center",g.createEl("span",{text:"By signing in, you agree to our "});let v=g.createEl("a",{text:"Privacy Policy"});v.href="#",v.style.color="var(--interactive-accent)",v.style.textDecoration="none",v.onclick=h=>{h.preventDefault(),w("https://aiche.app/privacy")},g.createEl("span",{text:"."})}async submitCode(){var t,n;let e=(n=(t=this.codeInput)==null?void 0:t.value)==null?void 0:n.trim();if(!e){new o.Notice("Enter a code");return}if(this.plugin.pendingAuth||this.plugin.generateAuthState(),this.plugin.pendingAuth&&Date.now()-this.plugin.pendingAuth.timestamp>300*1e3){new o.Notice("Timed out. Reopen and try again."),this.plugin.clearAuthState(),this.close();return}try{await this.plugin.activateDeviceCode(e),this.plugin.clearAuthState(),this.close()}catch(r){new o.Notice(`Failed: ${E(r)}`)}}onClose(){this.contentEl.empty()}},M=class extends o.Modal{constructor(s){super(s)}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:"Subscription Required"}),s.createEl("p",{text:"You need an active subscription to use voice recording."});let e=s.createDiv({cls:"modal-button-container"}),t=e.createEl("button",{text:"See Plans",cls:"mod-cta"});t.onclick=()=>{w("https://aiche.app/pricing"),this.close()};let n=e.createEl("button",{text:"Later"});n.onclick=()=>this.close()}onClose(){this.contentEl.empty()}},W=class extends o.Modal{constructor(s,e){super(s),this.plugin=e}onOpen(){let{contentEl:s}=this;s.addClass("aiche-welcome-modal"),s.createEl("h2",{text:"Welcome to Voice Recording"}),s.createEl("p",{text:"Speak into your notes. Get polished text in seconds.",cls:"setting-item-description"});let e=s.createDiv({cls:"aiche-welcome-guide"});[{num:"1",text:"Connect your account"},{num:"2",text:"Click the microphone or use a hotkey"},{num:"3",text:"Speak, then click again to finish"}].forEach(l=>{let u=e.createDiv({cls:"aiche-welcome-step"});u.createSpan({text:l.num,cls:"aiche-welcome-step-icon"}),u.createSpan({text:l.text,cls:"aiche-welcome-step-text"})}),s.createEl("p",{text:"Grammar and punctuation are handled automatically.",cls:"setting-item-description"});let n=s.createDiv({cls:"modal-button-container"});n.style.marginTop="20px";let r=n.createEl("button",{text:"Connect Account",cls:"mod-cta"});r.onclick=async()=>{this.plugin.settings.hasShownWelcome=!0,await this.plugin.saveSettings(),this.close(),new A(this.app,this.plugin).open()};let a=n.createEl("button",{text:"Later"});a.onclick=async()=>{this.plugin.settings.hasShownWelcome=!0,await this.plugin.saveSettings(),this.close()};let c=s.createDiv();c.style.marginTop="20px",c.style.fontSize="12px",c.style.color="var(--text-muted)",c.style.textAlign="center",c.createEl("span",{text:"Learn more in our "});let d=c.createEl("a",{text:"Privacy Policy"});d.href="#",d.style.color="var(--interactive-accent)",d.style.textDecoration="none",d.onclick=l=>{l.preventDefault(),w("https://aiche.app/privacy")},c.createEl("span",{text:"."})}onClose(){this.contentEl.empty()}};
