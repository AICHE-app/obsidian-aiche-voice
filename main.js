/*
AICHE Voice - Obsidian Plugin
https://aiche.app
*/

var U=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var ve=Object.getOwnPropertyNames;var ye=Object.prototype.hasOwnProperty;var we=(i,n)=>{for(var e in n)U(i,e,{get:n[e],enumerable:!0})},be=(i,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of ve(n))!ye.call(i,s)&&s!==e&&U(i,s,{get:()=>n[s],enumerable:!(t=fe(n,s))||t.enumerable});return i};var Te=i=>be(U({},"__esModule",{value:!0}),i);var Pe={};we(Pe,{default:()=>O});module.exports=Te(Pe);var l=require("obsidian");var R=require("obsidian");var H={encryptedAccessToken:void 0,encryptedRefreshToken:void 0,tokenStorageVersion:void 0,machineId:void 0,deviceId:void 0,accessToken:void 0,refreshToken:void 0,tokenExpiresAt:0,userEmail:"",userId:null,isSubscribed:!1,subscriptionPlan:null,autoEnhance:!0,insertAtCursor:!0,showNotifications:!0,hasShownWelcome:!1,selectedMicrophoneId:"",spokenNotesFolder:"Voice Notes",attachAudioToVoiceNotes:!0,organizeByCategoryFolders:!1,pendingTranscriptions:[],hasGivenPrivacyConsent:!1},K={work:"Work",life:"Life",ideas:"Ideas",misc:"Misc"},Ee={work:"work",life:"life",ideas:"ideas",misc:"misc",personal:"life",idea:"ideas",note:"misc"};function Z(i){return i&&Ee[i.toLowerCase()]||"misc"}function ee(i){return i instanceof Error}function ke(i){return typeof i=="object"&&i!==null&&"message"in i&&typeof i.message=="string"}function Se(i){return typeof i=="object"&&i!==null&&"name"in i&&typeof i.name=="string"}function F(i){return typeof i=="object"&&i!==null&&"status"in i&&typeof i.status=="number"}function te(i){return typeof i=="object"&&i!==null&&"json"in i&&typeof i.json=="object"&&i.json!==null&&"detail"in i.json&&typeof i.json.detail=="string"}function S(i){return ee(i)||ke(i)?i.message:typeof i=="string"?i:"Unknown error"}function se(i){if(ee(i)||Se(i))return i.name}var A="https://api.aiche.app",M=class{constructor(){this.onTokenRefresh=null;this.refreshPromise=null;this.userAgent="AICHE-Obsidian/1.0.0";this.accessToken="",this.refreshToken=""}setVersion(n){this.userAgent=`AICHE-Obsidian/${n}`}setTokens(n,e){this.accessToken=n,this.refreshToken=e}setTokenRefreshCallback(n){this.onTokenRefresh=n}async activateDeviceCode(n,e){let s=(await(0,R.requestUrl)({url:`${A}/api/v1/auth/device/activate`,method:"POST",headers:{"Content-Type":"application/json","User-Agent":this.userAgent},body:JSON.stringify({code:n.trim(),device_info:e})})).json;return this.setTokens(s.access_token,s.refresh_token),s}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this.performTokenRefresh();try{return await this.refreshPromise}finally{this.refreshPromise=null}}async performTokenRefresh(){if(!this.refreshToken)throw new Error("No refresh token available");let e=(await(0,R.requestUrl)({url:`${A}/api/v1/auth/refresh`,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":this.userAgent},body:`refresh_token=${encodeURIComponent(this.refreshToken)}`})).json,t={access_token:e.access_token,refresh_token:e.refresh_token||this.refreshToken,token_type:e.token_type||"bearer",expires_in:e.expires_in||86400*8};return this.setTokens(t.access_token,t.refresh_token),this.onTokenRefresh&&this.onTokenRefresh(t),t}async request(n){let e=n.headers||{};e["User-Agent"]=this.userAgent,this.accessToken&&(e.Authorization=`Bearer ${this.accessToken}`);try{return(await(0,R.requestUrl)({...n,headers:e})).json}catch(t){if(F(t)&&t.status===401&&!n.retried&&this.refreshToken)try{return await this.refreshAccessToken(),e.Authorization=`Bearer ${this.accessToken}`,(await(0,R.requestUrl)({url:n.url,method:n.method,headers:e,body:n.body})).json}catch(r){throw new Error("Session expired. Please reconnect your account.")}let s="Request failed";throw te(t)?s=t.json.detail:s=S(t),new Error(s)}}async getUserProfile(){return this.request({url:`${A}/api/v1/auth/me`,method:"GET"})}async transcribeAudio(n,e,t=2){let s="----AicheFormBoundary"+Math.random().toString(36).substring(2),r=JSON.stringify({include_category:!0}),o=`--${s}\r
Content-Disposition: form-data; name="request"\r
Content-Type: application/json\r
\r
${r}\r
`,a=`--${s}\r
Content-Disposition: form-data; name="file"; filename="${e}"\r
Content-Type: audio/webm\r
\r
`,d=`\r
--${s}--\r
`,c=new TextEncoder().encode(o),p=new TextEncoder().encode(a),u=new TextEncoder().encode(d),g=new Uint8Array(n),m=new Uint8Array(c.length+p.length+g.length+u.length);m.set(c,0),m.set(p,c.length),m.set(g,c.length+p.length),m.set(u,c.length+p.length+g.length);let f=null;for(let w=0;w<=t;w++)try{return await this.request({url:`${A}/api/v1/transcription/audio/direct`,method:"POST",headers:{"Content-Type":`multipart/form-data; boundary=${s}`},body:m.buffer})}catch(h){if(f=h instanceof Error?h:new Error(String(h)),F(h)&&h.status===503&&w<t){let E=Math.pow(2,w)*1e3;console.log(`AICHE: Transcription 503, retry ${w+1}/${t} in ${E}ms`),await new Promise(y=>setTimeout(y,E));continue}throw f}throw f||new Error("Transcription failed")}async pollTranscriptionStatus(n,e=30){for(let t=0;t<e;t++){let s=await this.request({url:`${A}/api/v1/transcription/${n}`,method:"GET"});if(s.status==="completed"||s.status==="failed")return s;await new Promise(r=>setTimeout(r,Math.min(1e3+t*200,3e3)))}throw new Error("Transcription timed out")}async logout(){if(this.accessToken)try{await this.request({url:`${A}/api/v1/auth/logout`,method:"POST"})}catch(n){}this.accessToken="",this.refreshToken=""}async generateWebLink(n){return this.request({url:`${A}/api/v1/auth/mobile/generate-web-link`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({redirect_path:n})})}async uploadRecordingSegment(n,e,t,s,r){await this.request({url:`${A}/api/v1/recording-sessions/segment`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:n,segment_index:e,text:t,client_type:"obsidian",device_id:s,duration:r})})}async completeRecordingSession(n,e,t,s){return this.request({url:`${A}/api/v1/recording-sessions/${n}/complete`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({total_segments:e,duration:t,device_id:s,recorded_at:new Date().toISOString()})})}};var W=require("obsidian"),C=null;if(!W.Platform.isMobileApp)try{C=require("child_process").spawn}catch(i){}function T(i){if(W.Platform.isMobileApp){window.open(i,"_blank");return}try{if(C&&process.platform==="linux"){let n={HOME:process.env.HOME||"",PATH:process.env.PATH||"/usr/bin:/bin",USER:process.env.USER||"",DISPLAY:process.env.DISPLAY||":0",XAUTHORITY:process.env.XAUTHORITY||"",DBUS_SESSION_BUS_ADDRESS:process.env.DBUS_SESSION_BUS_ADDRESS||"",XDG_RUNTIME_DIR:process.env.XDG_RUNTIME_DIR||"",XDG_CURRENT_DESKTOP:process.env.XDG_CURRENT_DESKTOP||""};C("xdg-open",[i],{detached:!0,stdio:"ignore",env:n}).unref()}else C&&process.platform==="darwin"?C("open",[i],{detached:!0,stdio:"ignore"}).unref():C&&process.platform==="win32"&&C("cmd",["/c","start","",i],{detached:!0,stdio:"ignore"}).unref()}catch(n){window.open(i,"_blank")}}var _=class{constructor(n){this.mediaRecorder=null;this.audioChunks=[];this.allChunks=[];this.stream=null;this.state="idle";this.durationInterval=null;this.startTime=0;this.events=n}async getAudioInputDevices(){let e=(await navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="audioinput"),t=new Map;return e.map(s=>{let r=s.label||`Microphone (${s.deviceId.slice(0,8)})`,o=t.get(r)||0;return t.set(r,o+1),o>0&&(r=`${r} (${o+1})`),{deviceId:s.deviceId,label:r}})}getState(){return this.state}setState(n){this.state=n,this.events.onStateChange(n)}async startRecording(n){if(this.state!=="idle")throw new Error("Already recording. Stop first.");try{let e={echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:1,sampleRate:48e3};n&&((await this.getAudioInputDevices()).some(o=>o.deviceId===n)?e.deviceId={exact:n}:console.warn("AICHE: Selected microphone not found, using default")),this.stream=await navigator.mediaDevices.getUserMedia({audio:e});let t=this.getSupportedMimeType();this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:t,audioBitsPerSecond:83e3}),this.audioChunks=[],this.allChunks=[],this.mediaRecorder.ondataavailable=s=>{s.data.size>0&&(this.audioChunks.push(s.data),this.allChunks.push(s.data))},this.mediaRecorder.onerror=s=>{var o;let r=s;this.events.onError(new Error(((o=r.error)==null?void 0:o.message)||"Recording error")),this.cleanup()},this.mediaRecorder.start(1e3),this.startTime=Date.now(),this.setState("recording"),this.durationInterval=setInterval(()=>{let s=Math.floor((Date.now()-this.startTime)/1e3);this.events.onDurationUpdate(s)},1e3)}catch(e){this.cleanup();let t=se(e);throw t==="NotAllowedError"?new Error("Microphone blocked. Allow access in system settings."):t==="NotFoundError"?new Error("No microphone found. Connect one and try again."):t==="OverconstrainedError"?new Error("Selected microphone unavailable. Check settings."):e}}getSupportedMimeType(){let n=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/mp4"];for(let e of n)if(MediaRecorder.isTypeSupported(e))return e;return"audio/webm"}pauseRecording(){this.state!=="recording"||!this.mediaRecorder||(this.mediaRecorder.pause(),this.setState("paused"))}resumeRecording(){this.state!=="paused"||!this.mediaRecorder||(this.mediaRecorder.resume(),this.setState("recording"))}async getSegment(n=!1){if(this.state!=="recording"||!this.mediaRecorder||!this.stream||this.audioChunks.length===0)return null;n&&(this.durationInterval&&(clearInterval(this.durationInterval),this.durationInterval=null),this.setState("processing"));let e=this.mediaRecorder.mimeType;return new Promise(t=>{if(!this.mediaRecorder){t(null);return}this.mediaRecorder.onstop=async()=>{var a;let s=new Blob(this.audioChunks,{type:e}),r=s.size>=1e3?await s.arrayBuffer():null;this.audioChunks=[];let o=((a=this.stream)==null?void 0:a.active)&&this.stream.getTracks().some(d=>d.readyState==="live");if(!n&&o&&this.state!=="idle"){await new Promise(d=>setTimeout(d,50));try{this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:e,audioBitsPerSecond:83e3}),this.mediaRecorder.ondataavailable=d=>{d.data.size>0&&(this.audioChunks.push(d.data),this.allChunks.push(d.data))},this.mediaRecorder.onerror=()=>{this.cleanup()},this.mediaRecorder.start(1e3),this.setState("recording")}catch(d){}}t(r)},this.mediaRecorder.stop()})}async getAllRecordedAudio(){var e;if(this.allChunks.length===0)return null;let n=new Blob(this.allChunks,{type:((e=this.mediaRecorder)==null?void 0:e.mimeType)||"audio/webm"});return n.size<1e3?null:await n.arrayBuffer()}async stopRecording(){if(this.state==="idle"||!this.mediaRecorder)throw new Error("Not recording. Start a recording first.");return this.setState("processing"),new Promise((n,e)=>{if(!this.mediaRecorder){e(new Error("No media recorder"));return}this.mediaRecorder.onstop=async()=>{var t;try{let s=new Blob(this.audioChunks,{type:((t=this.mediaRecorder)==null?void 0:t.mimeType)||"audio/webm"});if(s.size<1e3)throw new Error("Too short. Speak for at least 1 second.");let r=await s.arrayBuffer();n(r)}catch(s){e(s)}finally{this.cleanup()}},this.mediaRecorder.stop()})}cancelRecording(){this.cleanup()}cleanup(){this.durationInterval&&(clearInterval(this.durationInterval),this.durationInterval=null),this.stream&&(this.stream.getTracks().forEach(n=>n.stop()),this.stream=null),this.mediaRecorder=null,this.audioChunks=[],this.allChunks=[],this.setState("idle")}getDuration(){return this.state==="idle"?0:Math.floor((Date.now()-this.startTime)/1e3)}};var v=require("obsidian");var L=class extends v.PluginSettingTab{constructor(n,e){super(n,e),this.plugin=e}async openPreAuthUrl(n){try{let e=await this.plugin.api.generateWebLink(n);T(e.url)}catch(e){T("https://aiche.app"+n)}}display(){let{containerEl:n}=this;if(n.empty(),n.createEl("h2",{text:"Voice Recording"}),n.createEl("h3",{text:"Account"}),this.plugin.settings.encryptedAccessToken||this.plugin.settings.accessToken){new v.Setting(n).setName("Connected as").setDesc(this.plugin.settings.userEmail||"Connected").addButton(s=>s.setButtonText("Disconnect").setWarning().onClick(async()=>{await this.plugin.logout(),this.display()}));let t=this.plugin.settings.isSubscribed?`Active: ${this.plugin.settings.subscriptionPlan||"Premium"}`:"No active subscription";new v.Setting(n).setName("Subscription").setDesc(t).addButton(s=>s.setButtonText(this.plugin.settings.isSubscribed?"Manage":"Subscribe").onClick(async()=>{await this.openPreAuthUrl("/account")})),new v.Setting(n).addButton(s=>s.setButtonText("Refresh Status").onClick(async()=>{try{await this.plugin.refreshUserStatus()}catch(r){}this.display()})),new v.Setting(n).setName("Your devices").setDesc("AICHE works on Mac, Windows, Linux, iOS, Android, and browser. Manage all your connected apps in one place.").addButton(s=>s.setButtonText("Manage Devices").onClick(async()=>{await this.openPreAuthUrl("/account?section=sessions")}))}else new v.Setting(n).setName("Connect your account").setDesc("Sign in to start recording.").addButton(t=>t.setButtonText("Sign In").setCta().onClick(()=>{this.plugin.openConnectModal()})),new v.Setting(n).setDesc("No account yet?").addButton(t=>t.setButtonText("Create Account").onClick(()=>{T("https://aiche.app/signup")}));n.createEl("h3",{text:"Recording"}),new v.Setting(n).setName("Polish text").setDesc("Fix grammar and punctuation automatically.").addToggle(t=>t.setValue(this.plugin.settings.autoEnhance).onChange(async s=>{this.plugin.settings.autoEnhance=s,await this.plugin.saveSettings()})),new v.Setting(n).setName("Insert at cursor").setDesc("Add text where your cursor is. Otherwise, adds to end of note.").addToggle(t=>t.setValue(this.plugin.settings.insertAtCursor).onChange(async s=>{this.plugin.settings.insertAtCursor=s,await this.plugin.saveSettings()})),new v.Setting(n).setName("Show notifications").setDesc("Show a message when recording completes.").addToggle(t=>t.setValue(this.plugin.settings.showNotifications).onChange(async s=>{this.plugin.settings.showNotifications=s,await this.plugin.saveSettings()})),new v.Setting(n).setName("Voice notes folder").setDesc("Where to save new notes when no note is open.").addText(t=>t.setPlaceholder("Voice Notes").setValue(this.plugin.settings.spokenNotesFolder).onChange(async s=>{this.plugin.settings.spokenNotesFolder=s||"Voice Notes",await this.plugin.saveSettings()})),new v.Setting(n).setName("Attach audio").setDesc("Save audio file with notes in the voice notes folder.").addToggle(t=>t.setValue(this.plugin.settings.attachAudioToVoiceNotes).onChange(async s=>{this.plugin.settings.attachAudioToVoiceNotes=s,await this.plugin.saveSettings()})),new v.Setting(n).setName("Organize by category").setDesc("Sort notes into subfolders (Work, Life, Ideas, Misc) based on content.").addToggle(t=>t.setValue(this.plugin.settings.organizeByCategoryFolders).onChange(async s=>{this.plugin.settings.organizeByCategoryFolders=s,await this.plugin.saveSettings()})),v.Platform.isMobileApp||(n.createEl("h3",{text:"Hotkeys"}),new v.Setting(n).setName("Toggle Recording").setDesc("Start or stop recording"),new v.Setting(n).setName("Cancel Recording").setDesc("Discard without saving"),new v.Setting(n).setName("New Voice Note").setDesc("Create a new note and start recording"),new v.Setting(n).setDesc('Set hotkeys in Settings \u2192 Hotkeys, search "Voice"').addButton(t=>t.setButtonText("Open Hotkeys").onClick(()=>{this.app.setting.open(),this.app.setting.openTabById("hotkeys")}))),n.createEl("h3",{text:"About"}),new v.Setting(n).setName("Version").setDesc(this.plugin.manifest.version).addButton(t=>t.setButtonText("Website").onClick(()=>{T("https://aiche.app")})).addButton(t=>t.setButtonText("Help").onClick(()=>{T("https://aiche.app/help")})).addButton(t=>t.setButtonText("Privacy").onClick(()=>{T("https://aiche.app/privacy")}))}};var I=class{constructor(n,e,t=!0){this.sessionId=null;this.segmentIndex=0;this.isActive=!1;this.useEnhanced=!0;this.api=n,this.deviceId=e,this.useEnhanced=t}startSession(){if(this.isActive)throw new Error("Session already active");return this.sessionId=crypto.randomUUID(),this.segmentIndex=0,this.isActive=!0,this.sessionId}async processSegment(n){if(!this.sessionId||!this.isActive)return;let e=this.segmentIndex++,t=`segment_${e}.webm`;try{let s=await this.api.transcribeAudio(n,t),r=this.useEnhanced&&s.enhanced_text?s.enhanced_text:s.text;r&&await this.api.uploadRecordingSegment(this.sessionId,e,r,this.deviceId,30)}catch(s){console.error(`AICHE: Segment ${e} failed:`,s)}}async completeSession(n){if(!this.sessionId||!this.isActive)return null;this.isActive=!1;let e=this.sessionId,t=this.segmentIndex;if(this.sessionId=null,t===0)return null;try{return(await this.api.completeRecordingSession(e,t,n,this.deviceId)).final_text||null}catch(s){return console.error("AICHE: Session completion failed:",s),null}}cancelSession(){this.isActive=!1,this.sessionId=null,this.segmentIndex=0}isSessionActive(){return this.isActive}getSegmentCount(){return this.segmentIndex}};async function ne(i,n){let e=new TextEncoder,t=await crypto.subtle.importKey("raw",e.encode(i),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:n.buffer,iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function B(i){let n=new Uint8Array(i),e="";for(let t=0;t<n.byteLength;t++)e+=String.fromCharCode(n[t]);return btoa(e)}function G(i){let n=atob(i),e=new Uint8Array(n.length);for(let t=0;t<n.length;t++)e[t]=n.charCodeAt(t);return e}async function $(i,n,e){if(!i)throw new Error("Cannot encrypt empty token");let t=crypto.getRandomValues(new Uint8Array(16)),s=crypto.getRandomValues(new Uint8Array(12)),r=`${n}:${e}:aiche-voice`,o=await ne(r,t),a=new TextEncoder,d=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},o,a.encode(i));return{ciphertext:B(d),iv:B(s.buffer),salt:B(t.buffer)}}async function j(i,n,e){if(!i||!i.ciphertext||!i.iv||!i.salt)throw new Error("Invalid encrypted data");let t=G(i.ciphertext),s=G(i.iv),r=G(i.salt),o=`${n}:${e}:aiche-voice`,a=await ne(o,r),d=await crypto.subtle.decrypt({name:"AES-GCM",iv:s.buffer},a,t.buffer);return new TextDecoder().decode(d)}function P(){return!!(typeof crypto!="undefined"&&crypto.subtle&&typeof crypto.subtle.encrypt=="function"&&typeof crypto.subtle.decrypt=="function"&&typeof crypto.getRandomValues=="function")}var xe=50,ie=3,Ae=1440*60*1e3;function re(i){let n=atob(i),e=new Uint8Array(n.length);for(let t=0;t<n.length;t++)e[t]=n.charCodeAt(t);return e.buffer}function Ce(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function q(i){return Date.now()-i.timestamp>Ae}function z(i){let n=i.toLowerCase();return n.includes("empty")||n.includes("corrupt")||n.includes("invalid audio")||n.includes("no audio")||n.includes("too short")||n.includes("unreadable")}function V(i){let n=i.toLowerCase();return n.includes("plan limit")||n.includes("quota exceeded")||n.includes("upgrade required")||n.includes("subscription required")||n.includes("limit reached")||n.includes("exceeds your plan")||n.includes("requires pro")||n.includes("upgrade to pro")||n.includes("plan downgrade")||n.includes("tier limit")||n.includes("free plan limit")}function oe(i){if(V(i))return"planLimit";let n=i.toLowerCase();return n.includes("network")||n.includes("offline")||n.includes("connection")||n.includes("econnrefused")||n.includes("enotfound")?"network":n.includes("timeout")?"timeout":n.includes("401")||n.includes("unauthorized")||n.includes("session expired")?"auth":n.includes("500")||n.includes("502")||n.includes("503")||n.includes("504")?"server":"unknown"}function ae(i){return i.failureReason==="planLimit"?!1:i.retryCount<ie&&!q(i)}async function ce(i,n,e,t,s,r,o){if(!P())throw new Error("Web Crypto API unavailable - cannot securely save offline recordings");let a=B(i),d=await $(a,e,t);return{id:Ce(),audioData:d,filename:n,timestamp:Date.now(),retryCount:0,failureReason:s,errorMessage:r,durationSeconds:o}}function le(i){return{...i,retryCount:i.retryCount+1}}function de(i,n){let e=i.filter(t=>!q(t));return e.length>=xe&&e.shift(),[...e,n]}function D(i,n){return i.filter(e=>e.id!==n)}function ue(i){for(let n of i)if(ae(n))return n;return null}function he(i){return i.filter(n=>ae(n))}function pe(i){let n=0,e=0,t=0;for(let s of i)q(s)?e++:s.retryCount>=ie?t++:n++;return{total:i.length,pending:n,expired:e,maxRetries:t}}function ge(i){return i.map(n=>({...n,failureReason:n.failureReason||"unknown",errorMessage:n.errorMessage||"",durationSeconds:n.durationSeconds||0}))}var O=class extends l.Plugin{constructor(){super(...arguments);this.settings=H;this.api=new M;this.recorder=null;this.statusBarEl=null;this.ribbonIconEl=null;this.pendingAuth=null;this.statusBarClickHandler=null;this.statusBarContextHandler=null;this.statusBarTouchStart=null;this.statusBarTouchEnd=null;this.statusBarTouchMove=null;this.longPressTimer=null;this.animationTimeouts=[];this.beforeUnloadHandler=null;this.ariaLiveRegion=null;this.onlineHandler=null;this.visibilityHandler=null;this.isProcessingQueue=!1;this.activeNotice=null;this.connectModal=null;this.settingTab=null;this.sessionManager=null;this.segmentInterval=null;this.progressiveStartPos=null;this.progressiveEndPos=null}async onload(){await this.loadSettings(),this.api.setVersion(this.manifest.version);let e=await this.getAccessToken(),t=await this.getRefreshToken();e&&this.api.setTokens(e,t||""),this.api.setTokenRefreshCallback(async s=>{await this.setAccessToken(s.access_token),await this.setRefreshToken(s.refresh_token),this.settings.tokenExpiresAt=Date.now()+s.expires_in*1e3,await this.saveSettings()}),e&&t&&this.settings.tokenExpiresAt<Date.now()+36e5&&this.api.refreshAccessToken().catch(o=>{console.warn("AICHE: Proactive token refresh failed:",o)}),this.registerObsidianProtocolHandler("aiche-auth",async s=>{await this.handleAuthCallback(s)}),this.recorder=new _({onStateChange:s=>this.updateRecordingUI(s),onError:s=>new l.Notice(this.getUserFriendlyError(s)),onDurationUpdate:s=>this.updateDurationDisplay(s)}),this.ribbonIconEl=this.addRibbonIcon("mic","Voice recording",async()=>{await this.toggleRecording()}),this.ribbonIconEl.setAttribute("aria-label","Toggle voice recording"),this.statusBarEl=this.addStatusBarItem(),this.statusBarEl.addClass("aiche-status-bar"),this.statusBarEl.setAttribute("role","button"),this.statusBarEl.setAttribute("tabindex","0"),this.statusBarEl.setAttribute("aria-label","Toggle voice recording"),this.statusBarClickHandler=s=>{s.button===0&&(s.preventDefault(),s.stopPropagation(),this.toggleRecording())},this.statusBarContextHandler=s=>{s.preventDefault(),s.stopPropagation(),this.showStatusBarMenu(s)},this.statusBarEl.addEventListener("click",this.statusBarClickHandler),this.statusBarEl.addEventListener("contextmenu",this.statusBarContextHandler),l.Platform.isMobileApp&&(this.statusBarTouchStart=s=>{this.longPressTimer=setTimeout(()=>{this.vibrate(50);let r=s.touches[0],o=new MouseEvent("contextmenu",{clientX:r.clientX,clientY:r.clientY});this.showStatusBarMenu(o)},500)},this.statusBarTouchEnd=()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},this.statusBarTouchMove=()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},this.statusBarEl.addEventListener("touchstart",this.statusBarTouchStart),this.statusBarEl.addEventListener("touchend",this.statusBarTouchEnd),this.statusBarEl.addEventListener("touchmove",this.statusBarTouchMove)),this.statusBarEl.addEventListener("keydown",s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),this.toggleRecording())}),this.updateStatusBar(),this.createAriaLiveRegion(),this.onlineHandler=()=>{navigator.onLine&&this.settings.pendingTranscriptions.length>0&&this.processOfflineQueue()},window.addEventListener("online",this.onlineHandler),this.visibilityHandler=()=>{document.visibilityState==="visible"&&navigator.onLine&&this.settings.pendingTranscriptions.length>0&&this.processOfflineQueue()},document.addEventListener("visibilitychange",this.visibilityHandler),navigator.onLine&&this.settings.pendingTranscriptions.length>0&&setTimeout(()=>this.processOfflineQueue(),3e3),this.addCommand({id:"toggle-recording",name:"Toggle Recording",icon:"mic",callback:async()=>{await this.toggleRecording()}}),this.addCommand({id:"cancel-recording",name:"Cancel Recording",icon:"x",callback:()=>{this.recorder&&this.recorder.getState()!=="idle"&&this.cancelCurrentRecording()}}),this.addCommand({id:"new-voice-note",name:"New Voice Note",icon:"file-plus",callback:async()=>{await this.newVoiceNote()}}),this.settingTab=new L(this.app,this),this.addSettingTab(this.settingTab),this.beforeUnloadHandler=s=>{if(this.recorder&&this.recorder.getState()!=="idle")return s.preventDefault(),s.returnValue="Active recording will be lost. Close anyway?",s.returnValue},window.addEventListener("beforeunload",this.beforeUnloadHandler),e&&this.refreshUserStatus().catch(()=>{}),this.settings.hasShownWelcome||this.app.workspace.onLayoutReady(()=>{new J(this.app,this).open()})}onunload(){this.recorder&&this.recorder.getState()!=="idle"&&this.cancelCurrentRecording(),this.statusBarEl&&(this.statusBarClickHandler&&this.statusBarEl.removeEventListener("click",this.statusBarClickHandler),this.statusBarContextHandler&&this.statusBarEl.removeEventListener("contextmenu",this.statusBarContextHandler),this.statusBarTouchStart&&this.statusBarEl.removeEventListener("touchstart",this.statusBarTouchStart),this.statusBarTouchEnd&&this.statusBarEl.removeEventListener("touchend",this.statusBarTouchEnd),this.statusBarTouchMove&&this.statusBarEl.removeEventListener("touchmove",this.statusBarTouchMove)),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.animationTimeouts.forEach(e=>clearTimeout(e)),this.animationTimeouts=[],this.beforeUnloadHandler&&(window.removeEventListener("beforeunload",this.beforeUnloadHandler),this.beforeUnloadHandler=null),this.ariaLiveRegion&&(this.ariaLiveRegion.remove(),this.ariaLiveRegion=null),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.statusBarClickHandler=null,this.statusBarContextHandler=null,this.statusBarTouchStart=null,this.statusBarTouchEnd=null,this.statusBarTouchMove=null}async loadSettings(){var e;this.settings=Object.assign({},H,await this.loadData()),((e=this.settings.pendingTranscriptions)==null?void 0:e.length)>0&&(this.settings.pendingTranscriptions=ge(this.settings.pendingTranscriptions)),await this.migrateToEncryptedTokens()}async saveSettings(){await this.saveData(this.settings)}getVaultPath(){return l.Platform.isMobileApp?this.app.vault.getName():this.app.vault.adapter.basePath||this.app.vault.getName()}getOrCreateId(e){return this.settings[e]||(this.settings[e]=crypto.randomUUID()),this.settings[e]}getMachineId(){return this.getOrCreateId("machineId")}getDeviceId(){return this.getOrCreateId("deviceId")}async setEncryptedToken(e,t,s){if(!e){this.settings[t]=void 0,this.settings[s]=void 0;return}if(!P())throw new Error("Web Crypto API unavailable. Cannot securely store authentication tokens.");this.settings[t]=await $(e,this.getVaultPath(),this.getMachineId()),this.settings[s]=void 0,t==="encryptedAccessToken"&&(this.settings.tokenStorageVersion=2)}async getEncryptedToken(e,t,s){let r=this.settings[e];if(this.settings.tokenStorageVersion===2&&r){if(!P()){console.error(`AICHE: Web Crypto API unavailable, cannot decrypt ${s}`);return}try{return await j(r,this.getVaultPath(),this.getMachineId())}catch(o){console.error(`AICHE: Failed to decrypt ${s}:`,o);return}}return this.settings[t]||void 0}async setAccessToken(e){return this.setEncryptedToken(e,"encryptedAccessToken","accessToken")}async getAccessToken(){return this.getEncryptedToken("encryptedAccessToken","accessToken","access token")}async setRefreshToken(e){return this.setEncryptedToken(e,"encryptedRefreshToken","refreshToken")}async getRefreshToken(){return this.getEncryptedToken("encryptedRefreshToken","refreshToken","refresh token")}async migrateToEncryptedTokens(){if(this.settings.tokenStorageVersion!==2&&!(!this.settings.accessToken&&!this.settings.refreshToken)){if(!P()){console.warn("AICHE: Cannot migrate tokens - Web Crypto API unavailable");return}try{this.settings.accessToken&&await this.setAccessToken(this.settings.accessToken),this.settings.refreshToken&&await this.setRefreshToken(this.settings.refreshToken),await this.saveSettings(),new l.Notice("Security upgrade complete")}catch(e){console.error("AICHE: Token migration failed:",e)}}}getOsName(){return l.Platform.isIosApp?"iOS":l.Platform.isAndroidApp?"Android":l.Platform.isMacOS?"macOS":l.Platform.isWin?"Windows":"Linux"}getDeviceInfo(){let e=this.getDeviceId();return{name:`Obsidian (${l.Platform.isDesktop?"Desktop":"Mobile"})`,device_fingerprint:e,device_id:e,os:this.getOsName(),app_version:this.manifest.version}}generateAuthState(){let e=new Uint8Array(16);crypto.getRandomValues(e);let t=Array.from(e,s=>s.toString(16).padStart(2,"0")).join("");return this.pendingAuth={state:t,timestamp:Date.now()},t}validateAuthState(e){return!!this.pendingAuth&&this.pendingAuth.state===e&&Date.now()-this.pendingAuth.timestamp<=300*1e3}clearAuthState(){this.pendingAuth=null}async handleAuthCallback(e){let t=e.code||e.token,{state:s,error:r}=e;if(r){new l.Notice(`Sign-in failed: ${r}`);return}if(!t){new l.Notice("Sign-in failed: No device code received");return}if(s&&!this.validateAuthState(s)){new l.Notice("Session expired. Please try again."),this.clearAuthState();return}try{await this.activateDeviceCode(t),this.clearAuthState(),this.closeConnectModal()}catch(o){new l.Notice(this.getUserFriendlyError(o))}}openAuthInBrowser(){let e=this.generateAuthState(),t=this.getDeviceInfo(),s=encodeURIComponent(JSON.stringify({name:t.name,os:t.os,app_version:t.app_version,fingerprint:t.device_fingerprint})),r=`https://aiche.app/connect-obsidian?redirect=obsidian://aiche-auth&state=${e}&device=${s}&client=obsidian`;T(r)}async activateDeviceCode(e){try{let t=this.getDeviceInfo(),s=await this.api.activateDeviceCode(e,t);await this.setAccessToken(s.access_token),await this.setRefreshToken(s.refresh_token),this.settings.tokenExpiresAt=Date.now()+s.expires_in*1e3,this.settings.userEmail=s.user.email,this.settings.userId=s.user.id,this.api.setTokens(s.access_token,s.refresh_token),await this.refreshUserStatus(),await this.saveSettings(),new l.Notice("Account connected"),this.updateStatusBar()}catch(t){throw new Error(S(t)||"Failed to activate device code")}}async refreshUserStatus(){try{let e=await this.api.getUserProfile();this.settings.userEmail=e.email,this.settings.userId=e.id;let t=e.is_premium||!1;this.settings.isSubscribed=t,this.settings.subscriptionPlan=e.plan_name||null,await this.saveSettings(),this.updateStatusBar()}catch(e){let t=S(e);throw(t.includes("Session expired")||t.includes("401"))&&(await this.logout(),new l.Notice("Session expired. Please sign in again.")),e}}openConnectModal(){this.connectModal=new X(this.app,this),this.connectModal.open()}closeConnectModal(){this.connectModal&&(this.connectModal.close(),this.connectModal=null),this.settingTab&&this.settingTab.display()}async logout(){await this.api.logout(),this.settings.encryptedAccessToken=void 0,this.settings.encryptedRefreshToken=void 0,this.settings.accessToken=void 0,this.settings.refreshToken=void 0,this.settings.tokenExpiresAt=0,this.settings.userEmail="",this.settings.userId=null,this.settings.isSubscribed=!1,this.settings.subscriptionPlan=null,await this.saveSettings(),this.updateStatusBar(),new l.Notice("Account disconnected")}generateNoteTitle(){let e=new Date,s=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()],r=e.getDate(),o=e.getHours(),a=e.getMinutes().toString().padStart(2,"0"),d=o>=12?"pm":"am";return o=o%12||12,`${s} ${r}, ${o}.${a}${d}`}async createVoiceNote(){let e=this.settings.spokenNotesFolder||"Voice Notes",t=this.generateNoteTitle(),s=`${e}/${t}.md`;try{this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e);let o=1;for(;this.app.vault.getAbstractFileByPath(s);)s=`${e}/${t} (${o}).md`,o++;let a=await this.app.vault.create(s,"");return await this.app.workspace.getLeaf(!1).openFile(a),a}catch(r){return new l.Notice(`Could not create note: ${S(r)}`),null}}async moveNoteToCategory(e,t){var a;let s=this.settings.spokenNotesFolder||"Voice Notes",r=K[t],o=`${s}/${r}`;if(((a=e.parent)==null?void 0:a.path)!==o)try{this.app.vault.getAbstractFileByPath(o)||await this.app.vault.createFolder(o);let c=`${o}/${e.name}`,p=1;for(;this.app.vault.getAbstractFileByPath(c);){let u=e.basename,g=e.extension;c=`${o}/${u} ${p}.${g}`,p++}await this.app.fileManager.renameFile(e,c)}catch(d){console.error("Failed to move note to category folder:",d)}}canRecord(){return this.settings.encryptedAccessToken||this.settings.accessToken?this.settings.isSubscribed?!0:(new l.Notice("Subscription required"),new Y(this.app).open(),!1):(new l.Notice("Connect your account to start recording"),this.openConnectModal(),!1)}async newVoiceNote(){var t,s;if(!(!this.canRecord()||!await this.createVoiceNote())){await new Promise(r=>setTimeout(r,100));try{try{this.sessionManager=new I(this.api,this.getDeviceId(),this.settings.autoEnhance),this.sessionManager.startSession()}catch(r){console.warn("AICHE: Session creation failed, using batch mode"),this.sessionManager=null}await this.recorder.startRecording(this.settings.selectedMicrophoneId||void 0),(t=this.sessionManager)!=null&&t.isSessionActive()&&this.startSegmentProcessing(),this.vibrate(50),this.showRecordingNotice("Recording...",0),this.announceToScreenReader("Recording started. Speak now.")}catch(r){(s=this.sessionManager)==null||s.cancelSession(),this.sessionManager=null,this.showRecordingNotice(this.getUserFriendlyError(r),3e3)}}}async toggleRecording(){if(!this.recorder)return;let e=this.recorder.getState();e==="idle"?await this.startRecording():(e==="recording"||e==="paused")&&await this.stopAndTranscribe()}async startRecording(){if(this.canRecord()){if(!this.settings.hasGivenPrivacyConsent){new Q(this.app,this,async()=>{await this.proceedWithRecording()}).open();return}await this.proceedWithRecording()}}async proceedWithRecording(){var t,s;let e=this.app.workspace.getActiveViewOfType(l.MarkdownView);if(!e){if(!await this.createVoiceNote())return;await new Promise(o=>setTimeout(o,100)),e=this.app.workspace.getActiveViewOfType(l.MarkdownView)}try{try{this.sessionManager=new I(this.api,this.getDeviceId(),this.settings.autoEnhance),this.sessionManager.startSession()}catch(r){console.warn("AICHE: Session creation failed, using batch mode"),this.sessionManager=null}await this.recorder.startRecording(this.settings.selectedMicrophoneId||void 0),(t=this.sessionManager)!=null&&t.isSessionActive()&&this.startSegmentProcessing(),this.vibrate(50),this.showRecordingNotice("Recording...",0),this.announceToScreenReader("Recording started. Speak now.")}catch(r){(s=this.sessionManager)==null||s.cancelSession(),this.sessionManager=null,this.showRecordingNotice(this.getUserFriendlyError(r),3e3)}}startSegmentProcessing(){this.segmentInterval=setInterval(async()=>{var t;if(!((t=this.sessionManager)!=null&&t.isSessionActive())||!this.recorder)return;let e=await this.recorder.getSegment();e&&e.byteLength>1e3&&await this.sessionManager.processSegment(e)},3e4)}stopSegmentProcessing(){this.segmentInterval&&(clearInterval(this.segmentInterval),this.segmentInterval=null)}insertProgressiveText(e,t){let s=this.app.workspace.getActiveViewOfType(l.MarkdownView);if(!s)return;let r=s.editor;if(t){if(this.settings.insertAtCursor)this.progressiveStartPos=r.getCursor();else{let a=r.lastLine(),d=r.getLine(a).length;this.progressiveStartPos={line:a,ch:d}}this.progressiveEndPos={...this.progressiveStartPos}}let o=(t?"":" ")+e;if(this.progressiveEndPos){r.replaceRange(o,this.progressiveEndPos);let a=o,d=a.split(`
`);d.length===1?this.progressiveEndPos={line:this.progressiveEndPos.line,ch:this.progressiveEndPos.ch+a.length}:this.progressiveEndPos={line:this.progressiveEndPos.line+d.length-1,ch:d[d.length-1].length}}}replaceProgressiveText(e){let t=this.app.workspace.getActiveViewOfType(l.MarkdownView);if(!t||!this.progressiveStartPos||!this.progressiveEndPos)return;t.editor.replaceRange(e,this.progressiveStartPos,this.progressiveEndPos),this.progressiveStartPos=null,this.progressiveEndPos=null}cancelCurrentRecording(){var e,t;if(this.stopSegmentProcessing(),(e=this.sessionManager)==null||e.cancelSession(),this.sessionManager=null,(t=this.recorder)==null||t.cancelRecording(),this.progressiveStartPos&&this.progressiveEndPos){let s=this.app.workspace.getActiveViewOfType(l.MarkdownView);s&&s.editor.replaceRange("",this.progressiveStartPos,this.progressiveEndPos)}this.progressiveStartPos=null,this.progressiveEndPos=null,this.showRecordingNotice("Recording canceled",1500)}async stopAndTranscribe(){var o,a,d;if(!this.recorder)return;this.stopSegmentProcessing();let e=(o=this.sessionManager)==null?void 0:o.isSessionActive(),t=null,s="",r=this.recorder.getDuration();try{if(e){this.setProcessingState(!0),this.showRecordingNotice("Processing...",0),t=await this.recorder.getAllRecordedAudio(),s=`recording-${Date.now()}.webm`;let c=await this.recorder.getSegment(!0);c&&c.byteLength>1e3&&await this.sessionManager.processSegment(c),this.recorder.cancelRecording();let p=this.recorder.getDuration(),u=await this.sessionManager.completeSession(p);if(this.sessionManager=null,u){if(this.insertText(u),this.showSuccessAnimation(),this.vibrate([50,30,50]),this.settings.showNotifications){let g=u.split(/\s+/).filter(Boolean).length;this.showRecordingNotice(`${g} words added`,2e3)}this.announceToScreenReader("Done. Transcription complete.")}else t?(await this.saveToOfflineQueue(t,s,"server","Segmented transcription failed",r),this.showRecordingNotice("Saved for retry",3e3),this.announceToScreenReader("Recording saved for later.")):this.showRecordingNotice("Recording failed",2e3),this.showErrorAnimation(),this.vibrate([100,50,100])}else{t=await this.recorder.stopRecording(),s=`recording-${Date.now()}.webm`,this.setProcessingState(!0),this.showRecordingNotice("Processing...",0);let c=await this.api.transcribeAudio(t,s);if(c.status==="failed")throw new Error(c.error||"Transcription failed");let p=this.settings.autoEnhance&&c.enhanced_text?c.enhanced_text:c.text;if(!p){this.showRecordingNotice("No speech detected",2e3),this.showErrorAnimation();return}let u=this.app.workspace.getActiveFile(),g=this.settings.spokenNotesFolder||"Voice Notes",m=((a=u==null?void 0:u.parent)==null?void 0:a.path)||"",f=m===g||m.startsWith(g+"/");if(f&&this.settings.attachAudioToVoiceNotes&&u&&t?await this.insertTextWithAudio(p,t,u):this.insertText(p),f&&this.settings.organizeByCategoryFolders&&u){let h=Z(c.category);await this.moveNoteToCategory(u,h)}this.showSuccessAnimation(),this.vibrate([50,30,50]),this.settings.showNotifications&&this.showRecordingNotice(`${c.word_count||0} words added`,2e3),this.announceToScreenReader(`Done. ${c.word_count||0} words added.`)}}catch(c){(d=this.sessionManager)==null||d.cancelSession(),this.sessionManager=null,this.progressiveStartPos=null,this.progressiveEndPos=null;let p=S(c);if(z(p)){this.showRecordingNotice("Recording cannot be processed",3e3),this.announceToScreenReader("Recording failed."),this.showErrorAnimation(),this.vibrate([100,50,100]);return}if(t){let u=oe(p);await this.saveToOfflineQueue(t,s,u,p,r);let g=V(p)?"Plan limit reached. Recording saved.":this.isAuthError(c)?"Session expired. Recording saved for retry.":"Offline. Saved for retry.";this.showRecordingNotice(g,3e3),this.announceToScreenReader("Recording saved for later.")}else this.showRecordingNotice(this.getUserFriendlyError(c),3e3),this.announceToScreenReader("Failed. Try again.");this.showErrorAnimation(),this.vibrate([100,50,100])}}insertText(e){let t=this.app.workspace.getActiveViewOfType(l.MarkdownView);if(!t){new l.Notice("No note open. Text copied to clipboard."),navigator.clipboard.writeText(e);return}let s=t.editor;if(this.settings.insertAtCursor){let r=s.getCursor();s.replaceRange(e,r);let o=e.split(`
`),a=o[o.length-1].length;s.setCursor({line:r.line+o.length-1,ch:o.length===1?r.ch+a:a})}else{let r=s.getValue(),o=r+(r.endsWith(`
`)?"":`
`)+e+`
`;s.setValue(o),s.setCursor(s.lastLine())}}async insertTextWithAudio(e,t,s){var o;let r=this.app.workspace.getActiveViewOfType(l.MarkdownView);if(!r){new l.Notice("No note open. Text copied to clipboard."),navigator.clipboard.writeText(e);return}try{let a=this.getAttachmentFolder(s),c=`Recording ${s.basename}.webm`,p=a?`${a}/${c}`:c,u=2;for(;this.app.vault.getAbstractFileByPath(p);)c=`Recording ${s.basename} ${u}.webm`,p=a?`${a}/${c}`:c,u++;a&&(this.app.vault.getAbstractFileByPath(a)||await this.app.vault.createFolder(a)),await this.app.vault.createBinary(p,t);let g=`![[${c}]]`,m=r.editor,f=m.getValue();if(f.trim()===""){let h=`${e}

${g}
`;m.setValue(h);let b=e.split(`
`);m.setCursor({line:b.length-1,ch:b[b.length-1].length})}else if(this.settings.insertAtCursor){let h=`${e}

${g}
`,b=m.getCursor();m.replaceRange(h,b);let E=e.split(`
`);m.setCursor({line:b.line+E.length-1,ch:E[E.length-1].length})}else{let h=`${e}

${g}
`,b=f+(f.endsWith(`
`)?"":`
`)+h;m.setValue(b);let E=e.split(`
`),y=f.split(`
`).length;m.setCursor({line:y+E.length-1,ch:E[E.length-1].length})}let w=(o=this.app.workspace.getActiveViewOfType(l.MarkdownView))==null?void 0:o.leaf;if(w){let h=w.getViewState();await w.setViewState({...h,state:{...h.state,mode:"preview"}}),await w.setViewState({...h,state:{...h.state,mode:"source"}})}}catch(a){console.error("Failed to save audio:",a),this.insertText(e)}}getAttachmentFolder(e){var r;let t=this.app.vault.config,s=(t==null?void 0:t.attachmentFolderPath)||"";if(!s||s==="/")return"";if(s.startsWith("./")){let o=((r=e.parent)==null?void 0:r.path)||"",a=s.slice(2);return o?a?`${o}/${a}`:o:a}else return s}updateRecordingUI(e){if(this.ribbonIconEl){switch(this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),document.body.removeClass("aiche-is-recording","aiche-is-processing"),this.updateCommandIcon(e),e){case"recording":this.ribbonIconEl.addClass("aiche-recording"),document.body.addClass("aiche-is-recording"),(0,l.setIcon)(this.ribbonIconEl,"mic");break;case"paused":this.ribbonIconEl.addClass("aiche-paused"),document.body.addClass("aiche-is-recording"),(0,l.setIcon)(this.ribbonIconEl,"pause");break;case"processing":this.ribbonIconEl.addClass("aiche-processing"),document.body.addClass("aiche-is-processing"),(0,l.setIcon)(this.ribbonIconEl,"loader");break;default:(0,l.setIcon)(this.ribbonIconEl,"mic")}this.updateStatusBar()}}updateCommandIcon(e){var r;let t=(r=this.app.commands)==null?void 0:r.commands;if(!t)return;let s=t["aiche-voice:toggle-recording"];if(s)switch(e){case"recording":case"paused":s.icon="square";break;case"processing":s.icon="loader";break;default:s.icon="mic"}}updateDurationDisplay(e){if(!this.statusBarEl)return;let t=Math.floor(e/60),s=e%60,r=`${t}:${s.toString().padStart(2,"0")}`;this.statusBarEl.setText(`Recording ${r}`),this.statusBarEl.addClass("aiche-status-recording")}updateStatusBar(){var r,o;if(!this.statusBarEl)return;let e=((r=this.recorder)==null?void 0:r.getState())||"idle";if(this.statusBarEl.removeClass("aiche-status-recording","aiche-status-processing","aiche-status-ready","aiche-status-error"),e==="recording"){this.statusBarEl.addClass("aiche-status-recording");return}if(e==="processing"){this.statusBarEl.addClass("aiche-status-processing"),this.statusBarEl.setText("Processing...");return}let t=this.settings.encryptedAccessToken||this.settings.accessToken,s=((o=this.settings.pendingTranscriptions)==null?void 0:o.length)||0;t?this.settings.isSubscribed?(this.statusBarEl.addClass("aiche-status-ready"),s>0?(this.statusBarEl.setText(`Voice (${s} saved)`),this.statusBarEl.setAttribute("aria-label",`${s} recordings saved for retry`)):(this.statusBarEl.setText("Voice"),this.statusBarEl.setAttribute("aria-label","Toggle voice recording"))):this.statusBarEl.setText("Voice: No subscription"):this.statusBarEl.setText("Voice: Not connected")}showStatusBarMenu(e){var a,d;let t=new l.Menu,s=((a=this.recorder)==null?void 0:a.getState())||"idle";s==="recording"||s==="paused"?(t.addItem(c=>c.setTitle("Stop recording").setIcon("check").onClick(()=>this.stopAndTranscribe())),t.addItem(c=>c.setTitle("Cancel").setIcon("x").onClick(()=>{this.cancelCurrentRecording()}))):(t.addItem(c=>c.setTitle("Start recording").setIcon("mic").onClick(()=>this.toggleRecording())),t.addItem(c=>c.setTitle("New voice note").setIcon("file-plus").onClick(()=>this.newVoiceNote()))),t.addSeparator(),this.settings.encryptedAccessToken||this.settings.accessToken?t.addItem(c=>c.setTitle("Refresh status").setIcon("refresh-cw").onClick(async()=>{try{await this.refreshUserStatus(),new l.Notice("Status updated")}catch(p){new l.Notice("Could not refresh. Check connection.")}})):t.addItem(c=>c.setTitle("Connect account").setIcon("log-in").onClick(()=>this.openConnectModal()));let o=((d=this.settings.pendingTranscriptions)==null?void 0:d.length)||0;o>0&&(t.addSeparator(),t.addItem(c=>c.setTitle(`Retry saved (${o})`).setIcon("upload").onClick(()=>this.processOfflineQueue())),t.addItem(c=>c.setTitle("Delete saved").setIcon("trash").onClick(()=>this.clearOfflineQueue()))),t.addItem(c=>c.setTitle("Settings").setIcon("settings").onClick(()=>{this.app.setting.open(),this.app.setting.openTabById("aiche-voice")})),t.showAtMouseEvent(e)}setProcessingState(e){!this.ribbonIconEl||!this.statusBarEl||(e?(this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-success","aiche-error"),this.ribbonIconEl.addClass("aiche-processing"),(0,l.setIcon)(this.ribbonIconEl,"loader"),this.statusBarEl.removeClass("aiche-status-recording","aiche-status-ready","aiche-status-success","aiche-status-error"),this.statusBarEl.addClass("aiche-status-processing"),this.statusBarEl.setText("Processing...")):(this.ribbonIconEl.removeClass("aiche-processing"),this.statusBarEl.removeClass("aiche-status-processing")))}showSuccessAnimation(){if(!this.ribbonIconEl)return;this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),this.ribbonIconEl.addClass("aiche-success"),(0,l.setIcon)(this.ribbonIconEl,"check"),this.statusBarEl&&(this.statusBarEl.removeClass("aiche-status-processing"),this.statusBarEl.setText("Done"),this.statusBarEl.addClass("aiche-status-success"));let e=setTimeout(()=>{let t=this.animationTimeouts.indexOf(e);t>-1&&this.animationTimeouts.splice(t,1),this.ribbonIconEl&&(this.ribbonIconEl.removeClass("aiche-success"),(0,l.setIcon)(this.ribbonIconEl,"mic")),this.statusBarEl&&this.statusBarEl.removeClass("aiche-status-success"),this.updateStatusBar()},1500);this.animationTimeouts.push(e)}showErrorAnimation(){if(!this.ribbonIconEl)return;this.ribbonIconEl.removeClass("aiche-recording","aiche-paused","aiche-processing"),this.ribbonIconEl.addClass("aiche-error"),(0,l.setIcon)(this.ribbonIconEl,"mic"),this.statusBarEl&&(this.statusBarEl.removeClass("aiche-status-processing"),this.statusBarEl.addClass("aiche-status-error"));let e=setTimeout(()=>{let t=this.animationTimeouts.indexOf(e);t>-1&&this.animationTimeouts.splice(t,1),this.ribbonIconEl&&this.ribbonIconEl.removeClass("aiche-error"),this.statusBarEl&&this.statusBarEl.removeClass("aiche-status-error"),this.updateStatusBar()},500);this.animationTimeouts.push(e)}createAriaLiveRegion(){this.ariaLiveRegion=document.body.createDiv({cls:"aiche-sr-only"}),this.ariaLiveRegion.setAttribute("role","status"),this.ariaLiveRegion.setAttribute("aria-live","polite"),this.ariaLiveRegion.setAttribute("aria-atomic","true")}announceToScreenReader(e){this.ariaLiveRegion&&(this.ariaLiveRegion.setText(""),setTimeout(()=>{this.ariaLiveRegion&&this.ariaLiveRegion.setText(e)},100))}showRecordingNotice(e,t=2500){this.activeNotice&&this.activeNotice.hide(),this.activeNotice=new l.Notice(e,t)}vibrate(e=50){l.Platform.isMobileApp&&navigator.vibrate&&navigator.vibrate(e)}async saveToOfflineQueue(e,t,s="unknown",r="",o=0){let a=this.getVaultPath(),d=this.getMachineId(),c=await ce(e,t,a,d,s,r,o);this.settings.pendingTranscriptions=de(this.settings.pendingTranscriptions,c),await this.saveSettings(),this.updateStatusBar()}async processOfflineQueue(){if(this.isProcessingQueue||!navigator.onLine)return;this.settings.pendingTranscriptions=he(this.settings.pendingTranscriptions),await this.saveSettings();let e=pe(this.settings.pendingTranscriptions);if(e.pending!==0){this.isProcessingQueue=!0;try{for(new l.Notice(`Retrying ${e.pending} saved recording${e.pending>1?"s":""}...`);;){let t=ue(this.settings.pendingTranscriptions);if(!t)break;if(!navigator.onLine){new l.Notice("Still offline. Will retry when connected.");break}try{let s=this.getVaultPath(),r=this.getMachineId(),o;try{let c=await j(t.audioData,s,r);o=re(c)}catch(c){console.error("Failed to decrypt queued audio:",c),this.settings.pendingTranscriptions=D(this.settings.pendingTranscriptions,t.id),await this.saveSettings();continue}let a=await this.api.transcribeAudio(o,t.filename);if(a.status==="failed")throw new Error(a.error||"Transcription failed");let d=this.settings.autoEnhance&&a.enhanced_text?a.enhanced_text:a.text;d&&(this.app.workspace.getActiveViewOfType(l.MarkdownView)?this.insertText(d):await this.createVoiceNote()?(await new Promise(u=>setTimeout(u,100)),this.insertText(d)):(navigator.clipboard.writeText(d),new l.Notice("Text copied to clipboard (could not create note)")),new l.Notice(`Saved recording processed: ${a.word_count||0} words added`)),this.settings.pendingTranscriptions=D(this.settings.pendingTranscriptions,t.id),await this.saveSettings()}catch(s){let r=S(s);if(z(r)){this.settings.pendingTranscriptions=D(this.settings.pendingTranscriptions,t.id),new l.Notice("Recording cannot be processed. Removed."),await this.saveSettings();continue}if(V(r)){new l.Notice("Plan limit reached. Upgrade to process.");break}if(this.isNetworkError(s)){new l.Notice("Connection lost. Will retry later.");break}let o=le(t);o.retryCount>=3?(this.settings.pendingTranscriptions=D(this.settings.pendingTranscriptions,t.id),new l.Notice("Recording failed after 3 attempts. Removed.")):this.settings.pendingTranscriptions=this.settings.pendingTranscriptions.map(a=>a.id===t.id?o:a),await this.saveSettings()}}this.updateStatusBar()}finally{this.isProcessingQueue=!1}}}async clearOfflineQueue(){this.settings.pendingTranscriptions=[],await this.saveSettings(),this.updateStatusBar(),new l.Notice("Saved recordings deleted")}isNetworkError(e){let t=S(e).toLowerCase();return!navigator.onLine||t.includes("network")||t.includes("fetch")||t.includes("connection")||t.includes("timeout")||t.includes("econnrefused")||t.includes("enotfound")||t.includes("net::err")}isAuthError(e){let t=S(e).toLowerCase();return t.includes("session expired")||t.includes("401")||t.includes("unauthorized")||t.includes("refresh token")||t.includes("reconnect")}getUserFriendlyError(e){let t=S(e);return this.isNetworkError(e)?"No internet. Check connection and try again.":t.includes("Session expired")||t.includes("401")?"Session expired. Reconnect in settings.":t.includes("refresh token")||t.includes("No refresh")?"Sign-in expired. Reconnect your account.":t.includes("NotAllowedError")||t.includes("Permission denied")?"Microphone blocked. Allow access in system settings.":t.includes("NotFoundError")||t.includes("No microphone")?"No microphone found. Connect one and try again.":t.includes("NotReadableError")?"Microphone busy. Close other apps using it.":t.includes("too short")?"Too short. Speak for at least 1 second.":t.includes("Already recording")?"Already recording. Stop first.":t.includes("subscription")||t.includes("premium")?"Subscription required. Visit aiche.app/pricing":t.includes("Transcription failed")?"Failed. Check connection and try again.":t.includes("500")||t.includes("Internal")?"Server error. Try again in a moment.":t.includes("503")||t.includes("Service Unavailable")?"Service busy. Try again shortly.":t.length>100?"Something went wrong. Try again.":t}},Q=class extends l.Modal{constructor(e,t,s){super(e);this.consentCheckbox=null;this.plugin=t,this.onConsent=s}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("aiche-modal");let t=e.createEl("h2",{text:"Privacy & Data Consent"});t.style.marginBottom="16px";let s=e.createEl("p",{text:"Before you record, please review how your data is handled:"});s.style.marginBottom="16px",s.style.fontWeight="500";let r=e.createEl("div",{cls:"aiche-consent-info"});r.style.backgroundColor="var(--background-secondary)",r.style.padding="14px",r.style.borderRadius="4px",r.style.marginBottom="16px",r.style.lineHeight="1.6";let o=[{icon:"upload-cloud",text:"Audio sent to AICHE servers for processing"},{icon:"trash-2",text:"Audio deleted immediately after transcription"},{icon:"file-text",text:"Text returned to your device, not stored on our servers"}];o.forEach((b,E)=>{let y=r.createEl("div");y.style.display="flex",y.style.alignItems="center",y.style.gap="10px",y.style.marginBottom=E<o.length-1?"8px":"0",y.style.fontSize="14px";let x=y.createSpan();x.style.width="18px",x.style.height="18px",x.style.flexShrink="0",(0,l.setIcon)(x,b.icon),y.createSpan({text:b.text})});let a=e.createEl("div");a.style.marginBottom="16px",a.style.fontSize="13px";let d=a.createEl("span",{text:"Full details: "});d.style.color="var(--text-muted)";let c=a.createEl("a",{text:"Privacy Policy"});c.href="#",c.style.color="var(--interactive-accent)",c.addEventListener("click",b=>{b.preventDefault(),T("https://aiche.app/privacy")}),a.createEl("span",{text:" & "}).style.color="var(--text-muted)";let p=a.createEl("a",{text:"Terms of Service"});p.href="#",p.style.color="var(--interactive-accent)",p.addEventListener("click",b=>{b.preventDefault(),T("https://aiche.app/terms")});let u=e.createEl("div",{cls:"aiche-consent-checkbox"});u.style.display="flex",u.style.alignItems="center",u.style.gap="12px",u.style.marginBottom="16px",u.style.padding="12px",u.style.backgroundColor="var(--background-secondary)",u.style.borderRadius="4px";let g=u.createEl("input",{type:"checkbox"});g.style.cursor="pointer",g.style.width="18px",g.style.height="18px",g.style.minWidth="18px",g.style.margin="0",g.id="aiche-consent-checkbox",this.consentCheckbox=g;let m=u.createEl("label",{text:"I understand and consent to the data practices described above"});m.style.fontSize="14px",m.style.cursor="pointer",m.style.userSelect="none",m.style.lineHeight="1.4",m.setAttribute("for","aiche-consent-checkbox");let f=e.createEl("div",{cls:"aiche-modal-buttons"});f.style.display="flex",f.style.gap="8px";let w=f.createEl("button",{text:"Not now"});w.style.flex="1",w.style.padding="8px",w.style.backgroundColor="transparent",w.style.border="1px solid var(--divider-color)",w.style.borderRadius="4px",w.style.cursor="pointer",w.addEventListener("click",()=>this.close());let h=f.createEl("button",{text:"I Consent & Record"});h.style.flex="1",h.style.padding="8px",h.style.backgroundColor="var(--interactive-accent)",h.style.color="white",h.style.border="none",h.style.borderRadius="4px",h.style.cursor="pointer",h.style.fontWeight="500",h.style.opacity="0.5",h.style.pointerEvents="none",g.addEventListener("change",()=>{g.checked?(h.style.opacity="1",h.style.pointerEvents="auto"):(h.style.opacity="0.5",h.style.pointerEvents="none")}),h.addEventListener("click",async()=>{g.checked&&(this.plugin.settings.hasGivenPrivacyConsent=!0,await this.plugin.saveSettings(),this.close(),await this.onConsent())})}},X=class extends l.Modal{constructor(e,t){super(e);this.codeInput=null;this.manualSection=null;this.plugin=t}onOpen(){let{contentEl:e,modalEl:t}=this;e.empty(),e.addClass("aiche-connect-modal"),l.Platform.isMobileApp&&(e.style.setProperty("padding-left","16px","important"),e.style.setProperty("padding-right","16px","important"),e.style.setProperty("margin","0","important"),e.style.setProperty("width","100%","important"),e.style.setProperty("max-width","none","important"),e.style.setProperty("box-sizing","border-box","important"),t&&(t.style.setProperty("padding","0","important"),t.style.setProperty("margin","0 auto","important"))),e.style.setProperty("text-align","center","important"),e.createEl("h2",{text:"Connect Your Account"}).style.setProperty("text-align","center","important"),e.createEl("p",{text:"Sign in to start recording.",cls:"setting-item-description"}).style.setProperty("text-align","center","important");let a=e.createDiv({cls:"aiche-primary-action"}).createEl("button",{text:"Sign In",cls:"mod-cta aiche-signin-btn"});a.style.width="100%",a.style.padding="12px",a.style.fontSize="16px",a.style.marginBottom="16px",a.onclick=()=>{this.plugin.openAuthInBrowser()};let d=e.createDiv();d.style.setProperty("text-align","center","important"),d.style.setProperty("width","100%","important");let c=d.createEl("span",{text:"Opens aiche.app. You'll return here after signing in."});c.style.color="var(--text-muted)",c.style.fontSize="13px";let p=e.createDiv({cls:"aiche-divider"});p.style.borderTop="1px solid var(--background-modifier-border)",p.style.margin="20px 0",p.style.position="relative";let u=p.createEl("span",{text:"or enter code manually"});u.style.position="absolute",u.style.top="-10px",u.style.left="50%",u.style.transform="translateX(-50%)",u.style.background="var(--modal-background)",u.style.padding="0 10px",u.style.color="var(--text-muted)",u.style.fontSize="12px",this.manualSection=e.createDiv({cls:"aiche-manual-section"}),this.manualSection.style.setProperty("text-align","center","important"),this.manualSection.style.setProperty("width","100%","important");let g=this.manualSection.createDiv();g.style.setProperty("text-align","center","important"),g.style.setProperty("width","100%","important");let m=g.createEl("span",{text:"\u25B6 Having trouble? Enter code manually"});m.style.cursor="pointer",m.style.color="var(--text-muted)",m.style.fontSize="13px",m.style.display="inline-block";let f=this.manualSection.createDiv();f.style.display="none",f.style.marginTop="12px",m.onclick=()=>{let k=f.style.display==="none";f.style.display=k?"block":"none",m.textContent=k?"\u25BC Having trouble? Enter code manually":"\u25B6 Having trouble? Enter code manually"},f.createEl("p",{text:`1. Go to aiche.app/connect-obsidian
2. Copy the code and paste below:`,cls:"setting-item-description"}).style.setProperty("text-align","center","important"),new l.Setting(f).setName("Code").addText(k=>{this.codeInput=k.inputEl,k.setPlaceholder("XXXX-XXXX-XXXX"),k.inputEl.style.width="220px",k.inputEl.style.textTransform="uppercase",k.inputEl.addEventListener("keypress",async me=>{me.key==="Enter"&&await this.submitCode()})}).addButton(k=>k.setButtonText("Connect").onClick(async()=>{await this.submitCode()}));let h=e.createDiv({cls:"modal-button-container"});h.style.marginTop="16px",h.style.display="flex",h.style.flexDirection="column",h.style.gap="8px";let b=h.createEl("button",{text:"Create Account"});b.style.width="100%",b.onclick=()=>{T("https://aiche.app/signup")};let E=h.createEl("button",{text:"Cancel"});E.style.width="100%",E.onclick=()=>this.close();let y=h.createDiv();y.style.marginTop="16px",y.style.fontSize="12px",y.style.color="var(--text-muted)",y.style.setProperty("text-align","center","important"),y.createEl("span",{text:"By signing in, you agree to our "});let x=y.createEl("a",{text:"Privacy Policy"});x.href="#",x.style.color="var(--interactive-accent)",x.style.textDecoration="none",x.onclick=k=>{k.preventDefault(),T("https://aiche.app/privacy")},y.createEl("span",{text:" & "});let N=y.createEl("a",{text:"Terms"});N.href="#",N.style.color="var(--interactive-accent)",N.style.textDecoration="none",N.onclick=k=>{k.preventDefault(),T("https://aiche.app/terms")},y.createEl("span",{text:"."})}async submitCode(){var t,s;let e=(s=(t=this.codeInput)==null?void 0:t.value)==null?void 0:s.trim();if(!e){new l.Notice("Enter a code");return}if(this.plugin.pendingAuth||this.plugin.generateAuthState(),this.plugin.pendingAuth&&Date.now()-this.plugin.pendingAuth.timestamp>300*1e3){new l.Notice("Timed out. Reopen and try again."),this.plugin.clearAuthState(),this.close();return}try{await this.plugin.activateDeviceCode(e),this.plugin.clearAuthState(),this.close()}catch(r){new l.Notice(`Failed: ${S(r)}`)}}onClose(){this.contentEl.empty()}},Y=class extends l.Modal{constructor(n){super(n)}onOpen(){let{contentEl:n}=this;n.createEl("h2",{text:"Subscription Required"}),n.createEl("p",{text:"You need an active subscription to use voice recording."});let e=n.createDiv({cls:"modal-button-container"}),t=e.createEl("button",{text:"See Plans",cls:"mod-cta"});t.onclick=()=>{T("https://aiche.app/pricing"),this.close()};let s=e.createEl("button",{text:"Later"});s.onclick=()=>this.close()}onClose(){this.contentEl.empty()}},J=class extends l.Modal{constructor(n,e){super(n),this.plugin=e}onOpen(){let{contentEl:n}=this;n.createEl("h2",{text:"Welcome to Voice Recording"}),n.createEl("p",{text:"Speak into your notes. Get polished text in seconds.",cls:"setting-item-description"});let e=n.createDiv({cls:"aiche-welcome-guide"});[{num:"1",text:"Connect your account"},{num:"2",text:"Click the microphone or use a hotkey"},{num:"3",text:"Speak, then click again to finish"}].forEach(p=>{let u=e.createDiv({cls:"aiche-welcome-step"});u.createSpan({text:p.num,cls:"aiche-welcome-step-num"}),u.createSpan({text:p.text})}),n.createEl("p",{text:"Grammar and punctuation are handled automatically.",cls:"setting-item-description"});let s=n.createDiv({cls:"modal-button-container"}),r=s.createEl("button",{text:"Connect Account",cls:"mod-cta"});r.onclick=async()=>{this.plugin.settings.hasShownWelcome=!0,await this.plugin.saveSettings(),this.close(),this.plugin.openConnectModal()};let o=s.createEl("button",{text:"Later"});o.onclick=async()=>{this.plugin.settings.hasShownWelcome=!0,await this.plugin.saveSettings(),this.close()};let a=n.createDiv({cls:"aiche-welcome-privacy"});a.createEl("span",{text:"Learn more in our "});let d=a.createEl("a",{text:"Privacy Policy"});d.href="#",d.style.color="var(--interactive-accent)",d.style.textDecoration="none",d.onclick=p=>{p.preventDefault(),T("https://aiche.app/privacy")},a.createEl("span",{text:" & "});let c=a.createEl("a",{text:"Terms"});c.href="#",c.style.color="var(--interactive-accent)",c.style.textDecoration="none",c.onclick=p=>{p.preventDefault(),T("https://aiche.app/terms")},a.createEl("span",{text:"."})}onClose(){this.contentEl.empty()}};
